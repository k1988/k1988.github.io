<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>k1988</title>
  
  <link href="/rss.xml" rel="self"/>
  
  <link href="http://baba.zhaoxiuyuan.com/"/>
  <updated>2017-12-27T03:36:03.254Z</updated>
  <id>http://baba.zhaoxiuyuan.com/</id>
  
  <author>
    <name>赵海洋</name>
    <email>zhaohaiyang_1988@163.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>virtualbox编译记录</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/12/127_virtualbox_build/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/12/127_virtualbox_build/</id>
    <published>2017-12-27T03:20:28.000Z</published>
    <updated>2017-12-27T03:36:03.254Z</updated>
    
    <content type="html">&lt;h1 id=&quot;参考文档&quot;&gt;&lt;a href=&quot;#参考文档&quot; class=&quot;headerlink&quot; title=&quot;参考文档&quot;&gt;&lt;/a&gt;参考文档&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.virtualbox.org/wiki/Windows%20build%20instructions&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.virtualbox.org/wiki/Windows%20build%20instructions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/findumars/p/5542973.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.cnblogs.com/findumars/p/5542973.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;机器环境及之前已有库&quot;&gt;&lt;a href=&quot;#机器环境及之前已有库&quot; class=&quot;headerlink&quot; title=&quot;机器环境及之前已有库&quot;&gt;&lt;/a&gt;机器环境及之前已有库&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;windows 10 x64&lt;/li&gt;
&lt;li&gt;Visual Studio 2015 Community 版本&lt;/li&gt;
&lt;li&gt;Windows Driver Development Kit (WDK) v7.1&lt;/li&gt;
&lt;li&gt;Qt5.7.1&lt;/li&gt;
&lt;li&gt;Python 2.7.8&lt;/li&gt;
&lt;li&gt;Nsis 3.0b1&lt;/li&gt;
&lt;li&gt;JDK7 JDK8&lt;/li&gt;
&lt;li&gt;zlib 在 D:\thridparty\zlib&lt;/li&gt;
&lt;li&gt;VirtualBox 69891版本&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;下载工具和库&quot;&gt;&lt;a href=&quot;#下载工具和库&quot; class=&quot;headerlink&quot; title=&quot;下载工具和库&quot;&gt;&lt;/a&gt;下载工具和库&lt;/h1&gt;&lt;h2 id=&quot;下载Virtualbox推荐的链接&quot;&gt;&lt;a href=&quot;#下载Virtualbox推荐的链接&quot; class=&quot;headerlink&quot; title=&quot;下载Virtualbox推荐的链接&quot;&gt;&lt;/a&gt;下载Virtualbox推荐的链接&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Personal%20Builds/rubenvb/gcc-4.5-release/x86_64-w64-mingw32-gcc-4.5.4-release-win64_rubenvb.7z/download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;mingw64&lt;/a&gt;下载解压到&lt;code&gt;D:\projects\virtualbox\mingw64&lt;/code&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h3 id=&quot;mingw32&quot;&gt;&lt;a href=&quot;#mingw32&quot; class=&quot;headerlink&quot; title=&quot;mingw32&quot;&gt;&lt;/a&gt;mingw32&lt;/h3&gt;以下文件都解压&lt;code&gt;D:\projects\virtualbox\mingw32&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://prdownloads.sf.net/mingw/gcc-core-3.3.3-20040217-1.tar.gz?download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GCC 3.3.3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://prdownloads.sf.net/mingw/gcc-g++-3.3.3-20040217-1.tar.gz?download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GCC-g++ 3.3.3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://prdownloads.sf.net/mingw/mingw-runtime-3.8.tar.gz?download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MinGW Runtime&lt;/a&gt; 此版本编译报错，应该下载更新版本，如mingwrt-3.22.4。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://prdownloads.sf.net/mingw/w32api-3.5.tar.gz?download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;W32API&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://prdownloads.sf.net/mingw/binutils-2.13.90-20021006-2.tar.gz?download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Binutils&lt;/a&gt;。此版本windres会报错，应该下载更新版本，如&lt;a href=&quot;https://sourceforge.net/projects/mingw/files/MinGW/Base/binutils/binutils-2.28/binutils-2.28-1-mingw32-bin.tar.xz/download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;binutils-2.28&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;openssl&quot;&gt;&lt;a href=&quot;#openssl&quot; class=&quot;headerlink&quot; title=&quot;openssl&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://slproweb.com/products/Win32OpenSSL.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;openssl&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;其实下Light版本应该就够了&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;openssl 64 &lt;a href=&quot;https://slproweb.com/download/Win64OpenSSL-1_1_0g.exe&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://slproweb.com/download/Win64OpenSSL-1_1_0g.exe&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;openssl 32 &lt;a href=&quot;https://slproweb.com/download/Win32OpenSSL-1_1_0g.exe&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://slproweb.com/download/Win32OpenSSL-1_1_0g.exe&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;其它库&quot;&gt;&lt;a href=&quot;#其它库&quot; class=&quot;headerlink&quot; title=&quot;其它库&quot;&gt;&lt;/a&gt;其它库&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;libxml2 virtualbox已含&lt;/li&gt;
&lt;li&gt;zlib virtualbox已含&lt;/li&gt;
&lt;li&gt;其它可选库都不要&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;check-out代码&quot;&gt;&lt;a href=&quot;#check-out代码&quot; class=&quot;headerlink&quot; title=&quot;check out代码&quot;&gt;&lt;/a&gt;check out代码&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;下载 &lt;a href=&quot;https://github.com/svn2github/virtualbox.git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/svn2github/virtualbox.git&lt;/a&gt; 到 D:\projects\virtualbox,则D:\projects\virtualbox\trunk是virtualBox代码目录。&lt;/li&gt;
&lt;li&gt;在virtualBox代码目录中下载&lt;br&gt;&lt;a href=&quot;http://svn.netlabs.org/repos/kbuild/trunk/kBuild&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://svn.netlabs.org/repos/kbuild/trunk/kBuild&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;下载curl代码库 &lt;a href=&quot;https://github.com/curl/curl.git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/curl/curl.git&lt;/a&gt; 至D:\thridparty\curl。VirtualBox推荐的下载地址&lt;a href=&quot;http://curl.haxx.se/download.html中找不到windows版本的devel包，只好自己编译，编译步骤参考：http://blog.csdn.net/alger_magic/article/details/52584579&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://curl.haxx.se/download.html中找不到windows版本的devel包，只好自己编译，编译步骤参考：http://blog.csdn.net/alger_magic/article/details/52584579&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;编译curl&quot;&gt;&lt;a href=&quot;#编译curl&quot; class=&quot;headerlink&quot; title=&quot;编译curl&quot;&gt;&lt;/a&gt;编译curl&lt;/h2&gt;&lt;p&gt;将以下指令保存到curl根目录的批处理文件中，并执行:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;build_dll.bat&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;@echo off
@cd winbuild
@echo 正在使用release模式编译libcurl&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;    @nmake /f Makefile.vc WITH_DEVEL=D:\VC_INCLUDE\OpenSSL-Win32 WITH_ZLIB=D:\thridparty\zlib mode=dll VC=14 WITH_SSL=dll ENABLE_IDN=no RTLIBCFG=dll DEBUG=no MACHINE=x86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    @REM @echo on&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    @cd ..&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;`build_dll_x64.bat`&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    @echo off&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    @cd winbuild&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    @echo 正在使用release模式编译libcurl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

@nmake /f Makefile.vc WITH_DEVEL=D:\VC_INCLUDE\OpenSSL-Win64 WITH_ZLIB=D:\thridparty\zlib mode=dll VC=14 WITH_SSL=dll ENABLE_IDN=no RTLIBCFG=dll DEBUG=no MACHINE=x64
@REM @echo on
@cd ..
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;编译输出在&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;D:\thridparty\curl\builds\libcurl-vc14-x64-release-dll-ssl-dll-ipv6-sspi&lt;/li&gt;
&lt;li&gt;D:\thridparty\curl\builds\libcurl-vc14-x86-release-dll-ssl-dll-ipv6-sspi&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;因为virtualbox查找curl的lib和dll时只在指定目录查找，所以还需要将他们子目录下的bin和lib目录里的文件拷贝到父级目录。&lt;/p&gt;
&lt;h2 id=&quot;编译Virtulbox&quot;&gt;&lt;a href=&quot;#编译Virtulbox&quot; class=&quot;headerlink&quot; title=&quot;编译Virtulbox&quot;&gt;&lt;/a&gt;编译Virtulbox&lt;/h2&gt;&lt;h3 id=&quot;LocalConfig-kmk&quot;&gt;&lt;a href=&quot;#LocalConfig-kmk&quot; class=&quot;headerlink&quot; title=&quot;LocalConfig.kmk&quot;&gt;&lt;/a&gt;LocalConfig.kmk&lt;/h3&gt;&lt;p&gt;代码根目录新建文件LocalConfig.kmk，内容：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;VBOX_WITH_ADDITIONS=

VBOX_WITH_ADDITIONS_PACKING=
#Don&amp;apos;t build + package the VirtualBox Guest Additions. If only VBOX_WITH_ADDITIONS= is specified then the Guest Additions are not built but the VBoxGuestAdditions.iso file is expected to be present in the &amp;apos;out\win.ARCH\release\bin\additions&amp;apos; directory.

VBOX_ONLY_ADDITIONS=1
#Build the Guest Additions exclusively.

VBOX_WITH_VALIDATIONKIT=
#Don&amp;apos;t build + package the VirtualBox validation kit. The validation kit is not part of the final .msi package anyway.

VBOX_WITH_WEBSERVICES=
#Don&amp;apos;t build + package the webservices API server.

VBOX_WITHOUT_HARDENING=1

VBOX_INF2CAT=D:\WinDDK\7600.16385.1\bin\selfsign\Inf2Cat.exe
VBOX_PATH_SIGN_TOOLS=D:\WinDDK\7600.16385.1\bin\amd64\SignTool.exe

# 以下的我不用，只是机器上有，就放上来
VBOX_PATH_NSIS=D:\Program Files\NSIS
VBOX_ZIP=D:\VC_INCLUDE\GetGnuWin32\gnuwin32\bin\zip.exe
VBOX_PATH_WISUMINFO=D:\projects\Microsoft SDKs\Windows\v7.1\Samples\sysmgmt\msi\scripts\WiSumInf.vbs
VBOX_MKISOFS=C:\Program Files (x86)\VMware\VMware Workstation\mkisofs.exe
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;configure-vbs&quot;&gt;&lt;a href=&quot;#configure-vbs&quot; class=&quot;headerlink&quot; title=&quot;configure.vbs&quot;&gt;&lt;/a&gt;configure.vbs&lt;/h3&gt;&lt;p&gt;configure.vbs中修改代码&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;if   (InStr(1, g_strShellOutput, &amp;quot;Version 16.&amp;quot;) &amp;lt;= 0) _
And (InStr(1, g_strShellOutput, &amp;quot;Version 17.&amp;quot;) &amp;lt;= 0) then
    MsgError &amp;quot;The Visual C++ compiler we found (&amp;apos;&amp;quot; &amp;amp; strPathVC &amp;amp; &amp;quot;&amp;apos;) isn&amp;apos;t 10.0 or 11.0. Check the build requirements.&amp;quot;
    exit sub
end if
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;为&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;if   (InStr(1, g_strShellOutput, &amp;quot;Version 16.&amp;quot;) &amp;lt;= 0) _
    And (InStr(1, g_strShellOutput, &amp;quot;Version 17.&amp;quot;) &amp;lt;= 0) _
    And (InStr(1, g_strShellOutput, &amp;quot;Version 18.&amp;quot;) &amp;lt;= 0) _
    And (InStr(1, g_strShellOutput, &amp;quot;19.00&amp;quot;) &amp;lt;= 0) then
    MsgError &amp;quot;Check Version failed: The Visual C++ compiler we found (&amp;apos;&amp;quot; &amp;amp; strPathVC &amp;amp; &amp;quot;&amp;apos;) isn&amp;apos;t 10.0 - 14.0. Check the build requirements.&amp;quot;
    exit sub
end if
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;用来支持vs2015&lt;/p&gt;
&lt;h3 id=&quot;build-bat&quot;&gt;&lt;a href=&quot;#build-bat&quot; class=&quot;headerlink&quot; title=&quot;build.bat&quot;&gt;&lt;/a&gt;build.bat&lt;/h3&gt;&lt;p&gt;根目录新建build_x64.bat:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;@echo off
set cur_dir= %~dp0%
call D:\projects\virtualbox\kBuild\envwin.cmd

cscript %cur_dir%configure.vbs --with-vc=&amp;quot;C:\Program Files (x86)\Microsoft Visual Studio 14.0&amp;quot; --with-MinGW-w64=D:\projects\virtualbox\mingw64 --with-SDK=&amp;quot;C:\Program Files (x86)\Microsoft SDKs\Windows\v7.1A&amp;quot; --with-DDK=D:\VC_INCLUDE\Windows\WinDDK  --with-Qt5=E:\Qt\Qt5.7.1\5.7\msvc2015_64 --with-python=D:\Python27 --with-libcurl32=D:\thridparty\curl\builds\libcurl-vc14-x86-release-dll-ssl-dll-ipv6-sspi --with-libcurl=D:\thridparty\curl\builds\libcurl-vc14-x64-release-dll-ssl-dll-ipv6-sspi --with-openssl32=&amp;quot;D:\VC_INCLUDE\OpenSSL-Win32&amp;quot; --with-openssl=&amp;quot;D:\VC_INCLUDE\OpenSSL-Win32&amp;quot; --disable-SDL --target-arch=amd64   
pause
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;执行之，然后再在命令行中分别执行：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;env
kmk
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h1&gt;&lt;h2 id=&quot;kmk-Invalid-number-“ev”-Stop&quot;&gt;&lt;a href=&quot;#kmk-Invalid-number-“ev”-Stop&quot; class=&quot;headerlink&quot; title=&quot;kmk: * Invalid number “ev”.  Stop.&quot;&gt;&lt;/a&gt;kmk: &lt;em&gt;*&lt;/em&gt; Invalid number “ev”.  Stop.&lt;/h2&gt;&lt;p&gt;执行kmk后，出现这个问题，然后我无论是切换virtualbox的版本还是切换kbuild的版本，最后安装了vs2010版本。结果还是报这个错误。&lt;br&gt;最后挨个文件夹执行kmk，最后发现在&lt;code&gt;virtualbox\trunk\src\recompiler&lt;/code&gt;中kmk提示这个错误。&lt;br&gt;打开这个目录的Makefile.kmk后搜索ev，只搜索到&lt;code&gt;DVBOX_SVN_REV&lt;/code&gt;，就想起来既然makefile中使用到了svn版本号，而我用的这个库又是git的，那问题会不会出现在svn版本号生成的地方。后面又在kmk输出的out\revision.kmk里发现了&lt;code&gt;export VBOX_SVN_REV=ev&lt;/code&gt;这样一来问题就很明显了。我只需要在生成svn版本号的地方改一下代码即可，但是手改config.kmk中的svn版本号分析实在是太烦了，所以就直接在LocalConfig.kmk中添加一行&lt;code&gt;VBOX_SVN_REV=69807&lt;/code&gt;即可解决。&lt;/p&gt;
&lt;h2 id=&quot;找不到&quot;&gt;&lt;a href=&quot;#找不到&quot; class=&quot;headerlink&quot; title=&quot;找不到 &quot;&gt;&lt;/a&gt;找不到 &lt;k kldr.h=&quot;&quot;&gt;&lt;/k&gt;&lt;/h2&gt;&lt;p&gt;在&lt;code&gt;D:\projects\virtualbox\trunk\src\VBox\Runtime\common\ldr\ldrkStuff.cpp&lt;/code&gt;中有&lt;code&gt;#include &amp;lt;k/kLdr.h&amp;gt;&lt;/code&gt;，但是代码库里没有。在老版本的&lt;a href=&quot;http://virtualbox-ose.sourcearchive.com/documentation/3.2.0-dfsg/files.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;文件列表&lt;/a&gt;里倒是能找到。&lt;br&gt;最后没办法，先屏蔽掉它吧。在&lt;code&gt;LocalConfig.kmk&lt;/code&gt;中添加一行&lt;code&gt;IPRT_WITH_KSTUFF=&lt;/code&gt;这样&lt;code&gt;D:\projects\virtualbox\trunk\src\VBox\Runtime\Makefile.kmk&lt;/code&gt;中就不会包含&lt;code&gt;kdrkStuff.cpp&lt;/code&gt;了。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ifdef IPRT_WITH_KSTUFF
RuntimeR3_SOURCES += \
    common/ldr/ldrkStuff.cpp
endif
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;后面发现，可以从&lt;a href=&quot;http://www.virtualbox.org/svn/kstuff-mirror下载kstuff的源码，所以这个又能编译的过&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.virtualbox.org/svn/kstuff-mirror下载kstuff的源码，所以这个又能编译的过&lt;/a&gt;    &lt;/p&gt;
&lt;h2 id=&quot;spu-dispatch-table-h&quot;&gt;&lt;a href=&quot;#spu-dispatch-table-h&quot; class=&quot;headerlink&quot; title=&quot;spu_dispatch_table.h&quot;&gt;&lt;/a&gt;spu_dispatch_table.h&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;D:\projects\virtualbox\trunk\src\VBox\GuestHost\OpenGL\include\cr_spu.h(16) : fatal error C1083: 无法打开包括文件:“spu_dispatch_table.h”: No such file or directory    &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;查看MakeFile发现D:\projects\virtualbox\trunk\src\VBox\Additions\common\crOpenGL\Makefile.kmk中用到D:\projects\virtualbox\trunk\src\VBox\GuestHost\OpenGL\Makefile.kmk中生成的spu_dispatch_table.h。而OpenGL\Makefile.kmk还没有执行。&lt;/p&gt;
&lt;p&gt;并且在&lt;a href=&quot;https://www.virtualbox.org/wiki/Windows%20build%20instructions中有提到：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.virtualbox.org/wiki/Windows%20build%20instructions中有提到：&lt;/a&gt;&lt;br&gt;This step will fail for a 64-bit (amd64) target if the Guest Additions are part of the build process (which is the default, disable by adding VBOX_WITH_ADDITIONS= and VBOX_WITH_ADDITIONS_PACKING= to LocalConfig.kmk, see below). It will complain about a dependency to VBoxOGL* libraries in out\win.x86\release\bin\additions. In that case, create the 32-bit Guest Additions by executing。&lt;/p&gt;
&lt;p&gt;所以，先在LocalConfig.kmk中加入 VBOX_WITH_ADDITIONS= and VBOX_WITH_ADDITIONS_PACKING= 跳过addtions的编译&lt;/p&gt;
&lt;h2 id=&quot;无法解析的外部符号-isprint&quot;&gt;&lt;a href=&quot;#无法解析的外部符号-isprint&quot; class=&quot;headerlink&quot; title=&quot;无法解析的外部符号 isprint&quot;&gt;&lt;/a&gt;无法解析的外部符号 isprint&lt;/h2&gt;&lt;p&gt;用2015编译过程中，大量的link错误，报错都是：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bin2c.obj : error LNK2019: 无法解析的外部符号 isprint，该符号在函数 main 中被引用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bin2c.obj : error LNK2019: 无法解析的外部符号 __acrt_iob_func，该符号在函数 main 中被引用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bin2c.obj : error LNK2019: 无法解析的外部符号 fclose，该符号在函数 main 中被引用&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;报错的程序太多，构建脚本又太复杂，经过摸索使用bin2c这个cpp来突破,bin2c不依赖于其它virtualbox或三方库代码，单独使用命令行cl即可编译生成出exe。&lt;/p&gt;
&lt;p&gt;经研究，virtualbox在编译命令行中加入了&lt;code&gt;-Zl&lt;/code&gt;,于是用cl -Zl bin2c.c 编译，果然直接失败，但输出obj后在link时添加c运行时库能成功。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// -Zl https://msdn.microsoft.com/zh-cn/library/f1tbxcxh.aspx。 ps：-Zl这是小写L，不是数字1.
// 可以使用 /Zl 来编译打算放入库中的 .obj 文件。 虽然省略库名只为单个 .obj 文件节省了少量空间，但在包含许多对象模块的库中节省的总空间是很多的。
cl.exe  -Zl -Fobin2c.obj bin2c.c
然后使用 link.exe bin2c.obj libcmt.lib 可以链接通过。
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;但从Config.kmk中看到，编译时还是带上了libcmt.lib的，比如：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;VBoxRT_LIBS.win.x86 = \
    $(PATH_TOOL_$(VBOX_VCC_TOOL_STEM)X86_LIB)/oldnames.lib \
    $(PATH_TOOL_$(VBOX_VCC_TOOL_STEM)X86_LIB)/libcmt.lib \
    $(PATH_TOOL_$(VBOX_VCC_TOOL_STEM)X86_LIB)/libcpmt.lib
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;但还是链接，从日志文件中提取出来最后的line命令行，并且精简如下：&lt;code&gt;link.exe /NOD bin2c.obj libcmt.lib&lt;/code&gt;,其中去掉这个&lt;code&gt;/NOD&lt;/code&gt;就会链接成功。msdn上并没有该选项，仅有一个&lt;code&gt;/NODEFAULTLIB     在解析外部引用时忽略所有（或指定的）默认库。&lt;/code&gt;,通过实验它们两是效果相等的。&lt;/p&gt;
&lt;p&gt;但同样是添加了/NOD选项，用vs2010编译就不会失败，而用2015就失败。只好先去掉/NOD这个选项。&lt;/p&gt;
&lt;h2 id=&quot;kmk-builtin-kDepObj-删除sanity-c相关文件失败&quot;&gt;&lt;a href=&quot;#kmk-builtin-kDepObj-删除sanity-c相关文件失败&quot; class=&quot;headerlink&quot; title=&quot;kmk_builtin_kDepObj 删除sanity-c相关文件失败&quot;&gt;&lt;/a&gt;kmk_builtin_kDepObj 删除sanity-c相关文件失败&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;kmk: *** [D:/projects/virtualbox/trunk/out/obj/RuntimeBldProg/common/misc/sanity-c.obj] Error 512 (0x200)
The failing command:
@kmk_builtin_kDepObj -f -s -q -o D:/projects/virtualbox/trunk/out/obj/RuntimeBldProg/common/misc/sanity-c.obj.dep -t D:/projects/virtualbox/trunk/out/obj/RuntimeBldProg/common/misc/sanity-c.obj D:/projects/virtualbox/trunk/out/obj/RuntimeBldProg/common/misc/sanity-c.obj
kmk: *** Deleting file `D:/projects/virtualbox/trunk/out/obj/RuntimeBldProg/common/misc/sanity-c.obj&amp;apos;
kmk: *** Waiting for unfinished jobs....
kmk: *** Exiting with status 2

vs2015下才有此bug，原因未知，先换用2010继续编译
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&quot;资源编译失败&quot;&gt;&lt;a href=&quot;#资源编译失败&quot; class=&quot;headerlink&quot; title=&quot;资源编译失败&quot;&gt;&lt;/a&gt;资源编译失败&lt;/h1&gt;&lt;pre&gt;&lt;code&gt;D:/projects/virtualbox/mingw32/bin/windres: unknown format type `D:/projects/virtualbox/trunk/include&amp;apos;
D:/projects/virtualbox/mingw32/bin/windres: supported formats: rc res coff

原始命令行：

D:/projects/virtualbox/mingw32/bin/windres    -ID:/projects/virtualbox/trunk/include -ID:/projects/virtualbox/trunk/out_vs2010 -IC:/PROGRA~2/MICROS~1/Windows/v7.1A/Include -IC:/PROGRA~2/MICROS~4.0/VC/include     -DVBOX_SVN_REV=69891     -DVBOX_SVN_REV_MOD_5K=19891     D:/projects/virtualbox/trunk/src/recompiler/VBoxREM.rc D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxREMImp/VBoxREMRes.o
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;查看windres的帮助，发现下载的virtualbox推荐mingw32里的windres是GNU windres (GNU Binutils) 2.25，-I参数不是输入文件，而是指格式。&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Usage: D:\projects\virtualbox\mingw32\bin\windres.exe [option(s)] [input-file] [output-file]
 The options are:
  -i --input=&amp;lt;file&amp;gt;            Name input file
  -o --output=&amp;lt;file&amp;gt;           Name output file
  -I --input-format=&amp;lt;format&amp;gt;   Specify input format
  -O --output-format=&amp;lt;format&amp;gt;  Specify output format    
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;再查看其它几个windres发现是&lt;code&gt;-I --input-format=&amp;lt;format&amp;gt;   Specify input format&lt;/code&gt;，于是就从其它地方找了windres替换掉这个。&lt;/p&gt;
&lt;h2 id=&quot;dllwrap-exe-报错-undefined-reference-to-dyn-tls-init-callback’-1&quot;&gt;&lt;a href=&quot;#dllwrap-exe-报错-undefined-reference-to-dyn-tls-init-callback’-1&quot; class=&quot;headerlink&quot; title=&quot;dllwrap.exe 报错 undefined reference to `__dyn_tls_init_callback’ 1&quot;&gt;&lt;/a&gt;dllwrap.exe 报错 undefined reference to `__dyn_tls_init_callback’ 1&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;/mingw/lib/dllcrt2.o(.text+0xd1): undefined reference to `__dyn_tls_init_callback` 1

# 命令行是
D:/projects/virtualbox/mingw32/bin/dllwrap.exe  -s                         --dllname=D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/VBoxREM32.dll --output-exp=D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/VBoxREM32.exp --output-lib=D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/VBoxREM32.a  --def D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxREMImp/VBoxREMWin.def  D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/VBoxRecompiler.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/cpu-exec.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/exec.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/translate-all.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/host-utils.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/cutils.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/tcg-runtime.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/tcg/tcg.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/tcg/tcg-dyngen.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/fpu/softfloat-native.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/target-i386/op_helper.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/target-i386/helper.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxRemPrimary/target-i386/translate.o D:/projects/virtualbox/trunk/out_vs2010/obj/VBoxREMImp/VBoxREMRes.o  -LD:/projects/virtualbox/mingw32/lib   D:/projects/virtualbox/trunk/out_vs2010/lib/VBoxVMM.lib   D:/projects/virtualbox/trunk/out_vs2010/lib/VBoxRT.lib
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;神奇的是，去掉-LD:/projects/virtualbox/mingw32/lib或者将目录改成我原来的D:/Mingw/lib就能正常生成dll。所以我觉得是virtualbox推荐的mingwruntime有问题，所以我去下载了&lt;code&gt;mingwrt-3.22.4&lt;/code&gt;版本，也能正常编译。&lt;/p&gt;
&lt;h2 id=&quot;QT“void-thiscall-UISnapshotPane-void-”转换为“const-char-”&quot;&gt;&lt;a href=&quot;#QT“void-thiscall-UISnapshotPane-void-”转换为“const-char-”&quot; class=&quot;headerlink&quot; title=&quot;QT“void (__thiscall UISnapshotPane:: )(void)”转换为“const char ”&quot;&gt;&lt;/a&gt;QT“void (__thiscall UISnapshotPane::&lt;em&gt; )(void)”转换为“const char &lt;/em&gt;”&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;D:\projects\virtualbox\trunk\src\VBox\Frontends\VirtualBox\src\selector\UISnapshotPane.cpp(1273) : error C2664: “QAction *QToolBar::addAction(const QIcon &amp;amp;,const QString &amp;amp;,const QObject *,const char *)”: 不能将参数 4 从“void (__thiscall UISnapshotPane::* )(void)”转换为“const char *”
        没有使该转换得以执行的上下文
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;事实证明一开始偷懒下载的Qt5.5.1不支持virtualbox使用的头文件,Qt5.6.x之后有Q_QDOC宏包括起来的几个头文件。于是下载5.6.2版本重新编译。这里不能下载5.7.x版本，因为5.7.x版本的不支持vs2010编译了。&lt;/p&gt;
&lt;p&gt;在config.kmk中的第5933行中发现还有对VBOX_WITH_ORACLE_QT宏的判断，这个宏最终编译QT这些DLL的virtualBox版本。但我没有搞懂(也没有时间)怎么才能像官网版本那样编译出来Qt5CoreVBox.dll、Qt5GuiVBox.dll、Qt5OpenGLVBox.dll、Qt5PrintSupportVBox.dll、Qt5WidgetsVBox.dll、Qt5WinExtrasVBox.dll这几个文件。&lt;/p&gt;
&lt;h2 id=&quot;src-libs-xpcom18a4-python-gen-python-deps-py-No-Python-development-package-found&quot;&gt;&lt;a href=&quot;#src-libs-xpcom18a4-python-gen-python-deps-py-No-Python-development-package-found&quot; class=&quot;headerlink&quot; title=&quot;src/libs/xpcom18a4/python/gen_python_deps.py: No Python development package found!&quot;&gt;&lt;/a&gt;src/libs/xpcom18a4/python/gen_python_deps.py: No Python development package found!&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;其实virtualbox已经能运行了，但是在研究VBoxFB时使用了新的宏，编译时提示错误。
kmk.exe VBOX_WITH_VBOXFB=1 VBOX_WITH_XPCOM=1
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;  但看具体代码，似乎VBoxFB在非win系统下使用的。所以这个就跳过了。&lt;/p&gt;
&lt;h1 id=&quot;安装启动&quot;&gt;&lt;a href=&quot;#安装启动&quot; class=&quot;headerlink&quot; title=&quot;安装启动&quot;&gt;&lt;/a&gt;安装启动&lt;/h1&gt;&lt;p&gt;解决以上bug后，编译都顺利通过，然后我还继续使用vs2010编译了64位的qt。然后编译了64位的virtualbox。&lt;/p&gt;
&lt;p&gt;然后将编译中用到的libcurl和openssl相关dll放到bin目录。 libcrypto-1_1-x64.dll、libcurl.dll、libssl-1_1-x64.dll，还有QT相关的6个dll，Qt5Core.dll、Qt5Gui.dll、Qt5OpenGL.dll、Qt5PrintSupport.dll、Qt5Widgets.dll、Qt5WinExtras.dll。然后各种程序启动不报错，但是启动还没有效果。&lt;/p&gt;
&lt;p&gt;需要按照官网上build instructions网页上的说法： &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;需要先注册com进程，以管理员权限运行：comregister.cmd。&lt;/li&gt;
&lt;li&gt;loadall.cmd 安装驱动，但驱动(.sys结尾的7个文件)需要先签名。&lt;/li&gt;
&lt;li&gt;然后就能启动VirtualBox.exe了。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;SUPInstall-exe-error-installation-failed-rc-VERR-UNRESOLVED-ERROR&quot;&gt;&lt;a href=&quot;#SUPInstall-exe-error-installation-failed-rc-VERR-UNRESOLVED-ERROR&quot; class=&quot;headerlink&quot; title=&quot;SUPInstall.exe: error: installation failed. rc=VERR_UNRESOLVED_ERROR&quot;&gt;&lt;/a&gt;SUPInstall.exe: error: installation failed. rc=VERR_UNRESOLVED_ERROR&lt;/h2&gt;&lt;p&gt;在第2步安装驱动时，提示：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;+ D:/projects/virtualbox/out_vs2010_x64/bin/SUPInstall.exe
SUPInstall.exe: error: installation failed. rc=VERR_UNRESOLVED_ERROR
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;将所有驱动文件生成对应的cat文件，并且将cat和sys签名即可。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;参考文档&quot;&gt;&lt;a href=&quot;#参考文档&quot; class=&quot;headerlink&quot; title=&quot;参考文档&quot;&gt;&lt;/a&gt;参考文档&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.virtualbox.org/wiki/Windows%20build%20instructions&quot;&gt;https://www.virtualbox.org/wiki/Windows%20build%20instructions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cnblogs.com/findumars/p/5542973.html&quot;&gt;https://www.cnblogs.com/findumars/p/5542973.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;机器环境及之前已有库&quot;&gt;&lt;a href=&quot;#机器环境及之前已有库&quot; class=&quot;headerlink&quot; title=&quot;机器环境及之前已有库&quot;&gt;&lt;/a&gt;机器环境及之前已有库&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;windows 10 x64&lt;/li&gt;
&lt;li&gt;Visual Studio 2015 Community 版本&lt;/li&gt;
&lt;li&gt;Windows Driver Development Kit (WDK) v7.1&lt;/li&gt;
&lt;li&gt;Qt5.7.1&lt;/li&gt;
&lt;li&gt;Python 2.7.8&lt;/li&gt;
&lt;li&gt;Nsis 3.0b1&lt;/li&gt;
&lt;li&gt;JDK7 JDK8&lt;/li&gt;
&lt;li&gt;zlib 在 D:\thridparty\zlib&lt;/li&gt;
&lt;li&gt;VirtualBox 69891版本&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;下载工具和库&quot;&gt;&lt;a href=&quot;#下载工具和库&quot; class=&quot;headerlink&quot; title=&quot;下载工具和库&quot;&gt;&lt;/a&gt;下载工具和库&lt;/h1&gt;&lt;h2 id=&quot;下载Virtualbox推荐的链接&quot;&gt;&lt;a href=&quot;#下载Virtualbox推荐的链接&quot; class=&quot;headerlink&quot; title=&quot;下载Virtualbox推荐的链接&quot;&gt;&lt;/a&gt;下载Virtualbox推荐的链接&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Personal%20Builds/rubenvb/gcc-4.5-release/x86_64-w64-mingw32-gcc-4.5.4-release-win64_rubenvb.7z/download&quot;&gt;mingw64&lt;/a&gt;下载解压到&lt;code&gt;D:\projects\virtualbox\mingw64&lt;/code&gt;
    
    </summary>
    
      <category term="开源项目" scheme="http://baba.zhaoxiuyuan.com/categories/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/tags/windows/"/>
    
      <category term="tool" scheme="http://baba.zhaoxiuyuan.com/tags/tool/"/>
    
      <category term="system" scheme="http://baba.zhaoxiuyuan.com/tags/system/"/>
    
  </entry>
  
  <entry>
    <title>c/c++宏展开成字符串</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/12/128_c++_str_macro/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/12/128_c++_str_macro/</id>
    <published>2017-12-27T03:20:28.000Z</published>
    <updated>2018-02-27T02:31:21.992Z</updated>
    
    <content type="html">&lt;h1 id=&quot;参考文档&quot;&gt;&lt;a href=&quot;#参考文档&quot; class=&quot;headerlink&quot; title=&quot;参考文档&quot;&gt;&lt;/a&gt;参考文档&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://bbs.csdn.net/topics/390790529&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bbs.csdn.net/topics/390790529&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.chinaunix.net/uid-22125732-id-1790639.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.chinaunix.net/uid-22125732-id-1790639.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/moxiaomomo/article/details/53453949&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/moxiaomomo/article/details/53453949&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;代码&quot;&gt;&lt;a href=&quot;#代码&quot; class=&quot;headerlink&quot; title=&quot;代码&quot;&gt;&lt;/a&gt;代码&lt;/h1&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;#include &amp;lt;assert.h&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 连接标识符(非字符串连接成非字符串，字符串连接成字符串)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define __JOIN(x,y) x##y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 将参数转换成字符(x长度小于5，否则会溢出)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define __CHAR(x)   #@x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 将x变成字符串（如果x是宏也不展开）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define __S(x)   #x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 将x变成T字符串（如果x是宏也不展开）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define __ST(x)   _T(#x)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 将x变成字符串（如果x是宏，展开)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define _S(x)   __S(x)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 将x变成字符串（如果x是宏，展开)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define _ST(x)   __ST(x)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 将参数连接并转成字符串(遇宏则展开)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define _TO_STR(x, y) _S(x) &amp;quot;&amp;quot; _S(y)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define _TO_STRT(x, y) _T( _S(x) &amp;quot;&amp;quot; _S(y) )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bool testStrMacro()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	int ab = 12;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__JOIN(1, 2) == 12); // 常量连接组合&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__JOIN(&amp;quot;a&amp;quot;, &amp;quot;b&amp;quot;) == &amp;quot;ab&amp;quot;); // 字符串连接&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__JOIN(a, b) == 12); // 变量组合连接&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	auto a = __CHAR(65);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(a == &amp;apos;65&amp;apos;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__CHAR(中国) == &amp;apos;中国&amp;apos;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	auto cc = __CHAR(PNG);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__CHAR(PNG) == 0x504e47);// PNG 的 hex即是 0x504e47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	// 直接转成字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__S(65) == &amp;quot;65&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__ST(65) == _T(&amp;quot;65&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define test a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#define test_s &amp;quot;a&amp;quot; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__S(test) == &amp;quot;test&amp;quot;); // test是宏，但__S里有#，所以后续内容不展开&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(__ST(test) == _T(&amp;quot;test&amp;quot;)); // test是宏，但__S里有#，所以后续内容不展开&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	// 宏展开转换成字符串&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(_S(test) == &amp;quot;a&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(_ST(test) == _T(&amp;quot;a&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(_TO_STRT(test, 123) == _T(&amp;quot;a123&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(_TO_STR(test, 123) == &amp;quot;a123&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	// 宏嵌套效果&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	auto b = _TO_STR(__S(test), 123);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(_TO_STR(__S(test), 123) == &amp;quot;\&amp;quot;test\&amp;quot;123&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	auto c = _TO_STR(_S(test), 123);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(_TO_STR(_S(test), 123) == &amp;quot;\&amp;quot;a\&amp;quot;123&amp;quot;);  //_S(test) 展开成了a&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	assert(_TO_STR(_S(test), _TO_STR(123,456) ) == &amp;quot;\&amp;quot;a\&amp;quot;123456&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	return true;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;参考文档&quot;&gt;&lt;a href=&quot;#参考文档&quot; class=&quot;headerlink&quot; title=&quot;参考文档&quot;&gt;&lt;/a&gt;参考文档&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://bbs.csdn.net/topics/390790529&quot; target=&quot;_
    
    </summary>
    
      <category term="c++" scheme="http://baba.zhaoxiuyuan.com/categories/c/"/>
    
    
      <category term="c++" scheme="http://baba.zhaoxiuyuan.com/tags/c/"/>
    
  </entry>
  
  <entry>
    <title>Android-X86集成houdini(Arm兼容工具)</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/11/126_android_x86_houdini/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/11/126_android_x86_houdini/</id>
    <published>2017-11-30T06:20:28.000Z</published>
    <updated>2017-12-01T10:19:28.852Z</updated>
    
    <content type="html">&lt;p&gt;在&lt;a href=&quot;http://blog.csdn.net/roland_sun/article/details/49735601中看到对于android&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/roland_sun/article/details/49735601中看到对于android&lt;/a&gt; x86如何支持arm架构app的说明，但没有详细操作步骤，我这里经过摸索实操了一遍。&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Win10 64 Home版&lt;/li&gt;
&lt;li&gt;VirtualBox 5.1&lt;/li&gt;
&lt;li&gt;android-x86_64-6.0-r3.iso(下载于：&lt;a href=&quot;https://www.fosshub.com/Android-x86.html/android-x86_64-6.0-r3.iso&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.fosshub.com/Android-x86.html/android-x86_64-6.0-r3.iso&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;要注意的是安装android系统时(我参考的&lt;a href=&quot;https://www.cnblogs.com/wynn0123/p/6288344.html)，要在下面这一步一定要选择Yes，否则没有权限对系统进行修改（可能安装后用root&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.cnblogs.com/wynn0123/p/6288344.html)，要在下面这一步一定要选择Yes，否则没有权限对系统进行修改（可能安装后用root&lt;/a&gt; remount也行，但我没实验过）。&lt;br&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/4625619-18d8aa82cadc94d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;使用可读写方式安装&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装houdini&quot;&gt;&lt;a href=&quot;#安装houdini&quot; class=&quot;headerlink&quot; title=&quot;安装houdini&quot;&gt;&lt;/a&gt;安装houdini&lt;/h2&gt;&lt;p&gt;由于我没有翻墙，所以一些说翻墙后直接开启选项的方式我不能用，于是就手动处理。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;首先&lt;code&gt;adb pull /system/bin/enable_nativebridge .\enable_nativebridge(x64-6.0-rc3)&lt;/code&gt;将arm兼容安装的脚本pull下来。&lt;/li&gt;
&lt;li&gt;打开&lt;code&gt;enable_nativebridge(x64-6.0-rc3)&lt;/code&gt;，里面有几个下载地址&lt;code&gt;http://goo.gl/Knnmyl、url=http://goo.gl/JsoX2C、http://goo.gl/n6KtQa&lt;/code&gt;，用迅雷把他们下载下来(不翻墙也能下，迅雷就这点好)。&lt;/li&gt;
&lt;li&gt;&lt;p&gt;然后放到某http服务器，我是放到我自己本地架设的http服务器中。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;http://192.168.0.101/houdini_Knnmyl/houdini.sfs&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://192.168.0.101/houdini_Knnmyl/houdini.sfs&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://192.168.0.101/houdini_JsoX2C/houdini.sfs&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://192.168.0.101/houdini_JsoX2C/houdini.sfs&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;http://192.168.0.101/houdini_n6KtQa/houdini.sfs&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://192.168.0.101/houdini_n6KtQa/houdini.sfs&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;然后把&lt;code&gt;enable_nativebridge(x64-6.0-rc3)&lt;/code&gt;中的链接换成新的链接,将打印日志的语句&lt;code&gt;log -pe -thoudini&lt;/code&gt;都直接改为&lt;code&gt;echo&lt;/code&gt;方便后动执行时看效果，再另存为&lt;code&gt;enable_nativebridge&lt;/code&gt;.&lt;br&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/4625619-fc81703133b982bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;修改前后对比&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;执行&lt;code&gt;adb push enable_nativebridge /system/bin/enable_nativebridge&lt;/code&gt;将文件推送回去。&lt;br&gt;执行时出错：&lt;br&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/4625619-ee95ad1fc1ba423d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;看来&lt;strong&gt;权限&lt;/strong&gt;不足，先执行&lt;strong&gt;adb root&lt;/strong&gt;，来使用root级别的adb。注意如果是使用虚拟机端口转发的android系统的5555，则这时需要重新adb connect 127.0.0.1:7560 (这里这个ip和端口是配置的本地转发地址)。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;然后再执行&lt;code&gt;adb push enable_nativebridge /system/bin/enable_nativebridge&lt;/code&gt; 则成功将文件推入。&lt;/li&gt;
&lt;li&gt;adb shell后,执行&lt;code&gt;/system/lib/enable_nativebridge&lt;/code&gt;,执行结果最后一行显示的是houdini64 enabled。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;安装一个我的世界游戏试试，果然行了。&lt;/p&gt;
&lt;p&gt;20171201：更新&lt;/p&gt;
&lt;h2 id=&quot;android-x86-7-1-rc2&quot;&gt;&lt;a href=&quot;#android-x86-7-1-rc2&quot; class=&quot;headerlink&quot; title=&quot;android-x86-7.1-rc2&quot;&gt;&lt;/a&gt;android-x86-7.1-rc2&lt;/h2&gt;&lt;p&gt;在继续研究的过程中对于各版本的android-x86都进行了测试，其中4.4及5.1的都能正常安装houdini，但是启动游戏时都有各种问题导致崩溃。6.0及7.0的x86和x64版本均正常。&lt;br&gt;在各种尝试时，写了个快速脚本来处理安装houdini。这里拿安装android-x86-7.1-rc2的houdini举例：&lt;/p&gt;
&lt;h3 id=&quot;环境-1&quot;&gt;&lt;a href=&quot;#环境-1&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;未FQ的Win10 64 Home版&lt;/li&gt;
&lt;li&gt;VirtualBox 5.1&lt;/li&gt;
&lt;li&gt;android-x86-7.1-rc2.iso(下载于：&lt;a href=&quot;http://bdownload.fosshub.com/programs/android-x86-7.1-rc2.iso&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bdownload.fosshub.com/programs/android-x86-7.1-rc2.iso&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;安装android-x86-7.1-rc2时设置了adb端口转发为127.0.0.1:8671&lt;br&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/4625619-da6e9db1182b964a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;image.png&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;安装步骤&quot;&gt;&lt;a href=&quot;#安装步骤&quot; class=&quot;headerlink&quot; title=&quot;安装步骤&quot;&gt;&lt;/a&gt;安装步骤&lt;/h3&gt;&lt;p&gt;在某目录建立bat文件，填入以下内容并执行&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;@rem 注意下面的地址和端口是虚拟机的地址和端口&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@set address=127.0.0.1:8671&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@adb connect %address%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@adb -s %address% pull /system/bin/enable_nativebridge  enable_nativebridge_raw&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@copy enable_nativebridge_raw enable_nativebridge&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@echo 请修改enable_nativebridge后按任意键将文件写回&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@pause&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@echo 以root权限重新连接，并写回enable_nativebridge文件&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;adb -s %address% root&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;adb connect %address%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;adb -s %address% push .\enable_nativebridge /system/bin/enable_nativebridge&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@echo 任意键开始执行enable_nativebridge&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@pause&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在提示“请修改enable_nativebridge后按任意键将文件写回”时，用文本编辑工具打开pull回来的&lt;code&gt;enable_nativebridge&lt;/code&gt;文件，并且将里面的&lt;code&gt;goo.gl&lt;/code&gt;的链接（用短链接还原网站&lt;a href=&quot;http://bitly.co/，已FQ可跳过）解析出来并且改成真实链接如下，最好顺便把所有的`log&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bitly.co/，已FQ可跳过）解析出来并且改成真实链接如下，最好顺便把所有的`log&lt;/a&gt; -pe -thoudini &lt;code&gt;和&lt;/code&gt;log -pi -thoudini&lt;code&gt;改成&lt;/code&gt;echo`方便后面shell执行时看到结果 ：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;f [ -z &amp;quot;$1&amp;quot; ]; then&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if [ &amp;quot;`uname -m`&amp;quot; = &amp;quot;x86_64&amp;quot; ]; then&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		v=7_y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		# http://goo.gl/SBU3is -&amp;gt; http://dl.android-x86.org/houdini.php?v=7_y&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		url=http://mirror.ddscentral.org/dl.android-x86.org/houdini/7_y/houdini.sfs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	else&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		v=7_x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		# http://goo.gl/0IJs40 =&amp;gt; http://dl.android-x86.org/houdini.php?v=7_x&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		url=http://zebra-mirror.ddscentral.org/dl.android-x86.org/houdini/7_x/houdini.sfs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;else&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	v=7_z&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	# http://goo.gl/FDrxVN -&amp;gt; http://dl.android-x86.org/houdini.php?v=7_z&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	url=http://mirror.ddscentral.org/dl.android-x86.org/houdini/7_z/houdini.sfs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fi&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后回到批处理按任意键写回，再按任意键执行enable_nativebridge。&lt;br&gt;然后去android里把应用兼容性里的支持arm打开。&lt;br&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/4625619-71c86ea216986355.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;image.png&quot;&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在&lt;a href=&quot;http://blog.csdn.net/roland_sun/article/details/49735601中看到对于android&quot;&gt;http://blog.csdn.net/roland_sun/article/details/49735601中看到对于android&lt;/a&gt; x86如何支持arm架构app的说明，但没有详细操作步骤，我这里经过摸索实操了一遍。&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Win10 64 Home版&lt;/li&gt;
&lt;li&gt;VirtualBox 5.1&lt;/li&gt;
&lt;li&gt;android-x86_64-6.0-r3.iso(下载于：&lt;a href=&quot;https://www.fosshub.com/Android-x86.html/android-x86_64-6.0-r3.iso&quot;&gt;https://www.fosshub.com/Android-x86.html/android-x86_64-6.0-r3.iso&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;要注意的是安装android系统时(我参考的&lt;a href=&quot;https://www.cnblogs.com/wynn0123/p/6288344.html)，要在下面这一步一定要选择Yes，否则没有权限对系统进行修改（可能安装后用root&quot;&gt;https://www.cnblogs.com/wynn0123/p/6288344.html)，要在下面这一步一定要选择Yes，否则没有权限对系统进行修改（可能安装后用root&lt;/a&gt; remount也行，但我没实验过）。&lt;br&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/4625619-18d8aa82cadc94d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;使用可读写方式安装&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装houdini&quot;&gt;&lt;a href=&quot;#安装houdini&quot; class=&quot;headerlink&quot; title=&quot;安装houdini&quot;&gt;&lt;/a&gt;安装houdini&lt;/h2&gt;&lt;p&gt;由于我没有翻墙，所以一些说翻墙后直接开启选项的方式我不能用，于是就手动处理。
    
    </summary>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/categories/android/"/>
    
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/tags/android/"/>
    
      <category term="tool" scheme="http://baba.zhaoxiuyuan.com/tags/tool/"/>
    
      <category term="system" scheme="http://baba.zhaoxiuyuan.com/tags/system/"/>
    
  </entry>
  
  <entry>
    <title>Visual Studio 2017 命令行默认目录</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/11/125_vs_cmd_start_dir/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/11/125_vs_cmd_start_dir/</id>
    <published>2017-11-08T02:20:28.000Z</published>
    <updated>2017-11-30T06:50:35.299Z</updated>
    
    <content type="html">&lt;p&gt;自从安装了&lt;code&gt;Visual Studio 2017&lt;/code&gt; 后，在使用时有一个最大的不同一直困扰着我，今天终于下决心花了十来分钟解决了下。&lt;br&gt;我习惯于使用快捷方式或者在资源管理器中使用StEx加上一个vs编译命令行，而之前的VS版本&lt;strong&gt;命令行&lt;/strong&gt;打开后都是在&lt;strong&gt;当前目录&lt;/strong&gt;，&lt;strong&gt;Visual Studio 2017&lt;/strong&gt;这个奇葩打开后一直是cd到我的&lt;strong&gt;C:\Users\UserName\source&lt;/strong&gt;下。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;由于我启动命令行使用的命令是&lt;code&gt;%comspec% /k &amp;quot;C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat&amp;quot; x86&lt;/code&gt;&lt;br&gt;经过递归查找vcvarsall.bat里包含所有批处理文件，最后在&lt;code&gt;C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\vsdevcmd\core\vsdevcmd_end.bat&lt;/code&gt;中找到了以下代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;@REM Set the current directory that users will be set after the script completes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@REM in the following order:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@REM 1. [VSCMD_START_DIR] will be used if specified in the user environment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@REM 2. [USERPROFILE]\source if it exists&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@REM 3. current directory&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;if &amp;quot;%VSCMD_START_DIR%&amp;quot; NEQ &amp;quot;&amp;quot; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cd /d &amp;quot;%VSCMD_START_DIR%&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;) else (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if EXIST &amp;quot;%USERPROFILE%\Source&amp;quot; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cd /d &amp;quot;%USERPROFILE%\Source&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;看起来就很明显了，vs2017优先使用环境变量中的&lt;strong&gt;%VSCMD_START_DIR%&lt;/strong&gt;，其次使用&lt;strong&gt;%USERPROFILE%\source&lt;/strong&gt;，如果source目录不存在的话才会跑到当前目录。&lt;/p&gt;
&lt;p&gt;解决方案有两种(随你喜好)：&lt;br&gt;一、&lt;strong&gt;删除%USERPROFILE%\source&lt;/strong&gt;目录&lt;br&gt;二、直接修改bat，注释或&lt;strong&gt;删除&lt;/strong&gt;上面那段&lt;strong&gt;代码&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;自从安装了&lt;code&gt;Visual Studio 2017&lt;/code&gt; 后，在使用时有一个最大的不同一直困扰着我，今天终于下决心花了十来分钟解决了下。&lt;br&gt;我习惯于使用快捷方式或者在资源管理器中使用StEx加上一个vs编译命令行，而之前的VS版本&lt;strong&gt;命令行&lt;/strong&gt;打开后都是在&lt;strong&gt;当前目录&lt;/strong&gt;，&lt;strong&gt;Visual Studio 2017&lt;/strong&gt;这个奇葩打开后一直是cd到我的&lt;strong&gt;C:\Users\UserName\source&lt;/strong&gt;下。
    
    </summary>
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/categories/windows/"/>
    
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/tags/windows/"/>
    
      <category term="visual studio" scheme="http://baba.zhaoxiuyuan.com/tags/visual-studio/"/>
    
  </entry>
  
  <entry>
    <title>使用python和wincap抓包</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/11/124_python+wincap/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/11/124_python+wincap/</id>
    <published>2017-11-02T04:34:28.000Z</published>
    <updated>2017-11-08T02:31:16.219Z</updated>
    
    <content type="html">&lt;h2 id=&quot;环境安装&quot;&gt;&lt;a href=&quot;#环境安装&quot; class=&quot;headerlink&quot; title=&quot;环境安装&quot;&gt;&lt;/a&gt;环境安装&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;code&gt;easy_install winpcapy&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;easy_install pcapy&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在这第2步安装pcapy时报错了:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Searching for pcapy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Reading https://pypi.python.org/simple/pcapy/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Best match: pcapy 0.11.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Downloading https://pypi.python.org/packages/7f/12/626c6c1ee949b6d447f887a65388aa83faec6feb247e1bdf2478139a6078/pcapy-0.11.1.tar.gz#md5=24f8f339f1f1b00b2b43fe3c6910cbc1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Processing pcapy-0.11.1.tar.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Writing c:\users\terry\appdata\local\temp\easy_install-vf9ep5\pcapy-0.11.1\setup.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Running pcapy-0.11.1\setup.py -q bdist_egg --dist-dir c:\users\terry\appdata\local\temp\easy_install-vf9ep5\pcapy-0.11.1\egg-dist-tmp-0vrahf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error: Setup script exited with error: Microsoft Visual C++ 9.0 is required (Unable to find vcvarsall.bat). Get it from http://aka.ms/vcpython27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;原来pcapy下载下来不是直接可用的，而是需要先编译，按照提示在浏览器中打开了&lt;a href=&quot;http://aka.ms/vcpython27&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://aka.ms/vcpython27&lt;/a&gt;链接，跳转到微软官网上下载了&lt;a href=&quot;https://www.microsoft.com/en-us/download/details.aspx?id=44266&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Microsoft Visual C++ Compiler for Python 2.7&lt;/a&gt;,然后安装，安装位置是&lt;code&gt;%appdata%\Local\Programs\Common\Microsoft\Visual C++ for Python\9.0&lt;/code&gt;,安装后继续easy_install，结果又报一错误。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Running pcapy-0.11.1\setup.py -q bdist_egg --dist-dir c:\users\terry\appdata\local\temp\easy_install-ger_s1\pcapy-0.11.1\egg-dist-tmp-kl4a0h&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pcapdumper.cc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pcapdumper.cc(11) : fatal error C1083: Cannot open include file: &amp;apos;pcap.h&amp;apos;: No such file or directory&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error: Setup script exited with error: command &amp;apos;C:\\Users\\terry\\AppData\\Local\\Programs\\Common\\Microsoft\\Visual C++ for Python\\9.0\\VC\\Bin\\cl.exe&amp;apos; failed with exit status 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;由上可以看出来在编译pcapy时，还需要引用winpcap的头文件pcap.h，可以从winpcap网站下载，截止目前最新的版本是&lt;code&gt;https://www.winpcap.org/install/bin/WpdPack_4_1_2.zip&lt;/code&gt;。由于我机器上已经有些c++的项目带了一些pcap的库，所以我直接在&lt;code&gt;Visual C++ for Python&lt;/code&gt;的安装目录下找到了&lt;code&gt;vcvarsall.bat&lt;/code&gt;，然后编辑之，修改INCLUDE和LIB路径加上winpcap开发sdk的安装目录（D:\VC_INCLUDE\winpcap那个是我加的）：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;set INCLUDE=D:\VC_INCLUDE\winpcap\Include;%VCINSTALLDIR%Include;%WindowsSdkDir%Include;%INCLUDE%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set LIB=D:\VC_INCLUDE\winpcap\Lib;%VCINSTALLDIR%Lib;%WindowsSdkDir%Lib;%LIB%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set LIBPATH=D:\VC_INCLUDE\winpcap\Lib;%VCINSTALLDIR%Lib;%WindowsSdkDir%Lib;%LIBPATH%&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;然后再编译，就成功了。&lt;/p&gt;
&lt;h2 id=&quot;示例代码&quot;&gt;&lt;a href=&quot;#示例代码&quot; class=&quot;headerlink&quot; title=&quot;示例代码&quot;&gt;&lt;/a&gt;示例代码&lt;/h2&gt;&lt;p&gt;使用pcap抓包，再使用dpkt解析包&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;#! python3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# coding: utf-8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;__author__ = &amp;apos;terry&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import logging&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;from winpcapy import WinPcapDevices&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;from winpcapy import WinPcapUtils&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;logging.basicConfig(level=logging.DEBUG,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    format=&amp;apos;%(asctime)s %(filename)s[line:%(lineno)d] %(levelname)s %(message)s&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    datefmt=&amp;apos;%a, %d %b %Y %H:%M:%S&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    filename=&amp;apos;myapp.log&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    filemode=&amp;apos;w&amp;apos;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;logging.debug(&amp;apos;This is debug message&amp;apos;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;logging.info(&amp;apos;This is info message&amp;apos;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;logging.warning(&amp;apos;This is warning message&amp;apos;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;logging.info(&amp;quot;当前机器上有以下网卡&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;logging.info(WinPcapDevices.list_devices())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# Example Callback function to parse IP packets&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;def packet_callback(win_pcap, param, header, pkt_data):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # Assuming IP (for real parsing use modules like dpkt)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ip_frame = pkt_data[14:]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # Parse ips&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    src_ip = &amp;quot;.&amp;quot;.join([str(ord(b)) for b in ip_frame[0xc:0x10]])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    dst_ip = &amp;quot;.&amp;quot;.join([str(ord(b)) for b in ip_frame[0x10:0x14]])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    print(&amp;quot;%s -&amp;gt; %s&amp;quot; % (src_ip, dst_ip))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# WinPcapUtils.capture_on(&amp;quot;*Ethernet*&amp;quot;, packet_callback)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import pcap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import dpkt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sniffer = pcap.pcap()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sniffer.setfilter(&amp;apos;tcp port 80&amp;apos;)  # 过滤功能，可以设置需要显示的&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;def process_packet(ptime, packet):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tem = dpkt.ethernet.Ethernet(packet)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if tem.data.data.__class__.__name__ == &amp;apos;TCP&amp;apos;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        http_data = tem.data.data.data&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        if len(http_data) &amp;gt; 0:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            if http_data.startswith(b&amp;quot;HTTP&amp;quot;):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                # http response&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                response = dpkt.http.Response(http_data)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pass&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            else:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                # http request&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                req = dpkt.http.Request(http_data)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                host = str(req.headers[&amp;quot;host&amp;quot;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                cookie = str(req.headers[&amp;quot;cookie&amp;quot;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                path = str(req.uri)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                if host.index(&amp;quot;qianka.com&amp;quot;):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    logging.info(&amp;quot;QianKa message:&amp;quot; + host + cookie + path)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                pass&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;def print_http_packet(ts, buf):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    eth = dpkt.ethernet.Ethernet(buf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ip = eth.data&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # This is an oversimplification - IP packets can fragment if an MTU in the path is smaller than the MTU of the LAN&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # Also, this changes a little bit with IPv6.  To tell the difference between IPv4 and IPv6, you have to look&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # at the ethertype field, which is given by http://www.iana.org/assignments/ethernet-numbers.  IPv4 is 0x800 or 2048&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # and IPv6 is 0x86DD or 34525&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    tcp = ip.data&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # This is an oversimplification - this is true if and only if the protocol field of the IP packet is 6.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # See http://www.iana.org/assignments/protocol-numbers/protocol-numbers.xml for details of protocol numbers.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # See http://tools.ietf.org/html/rfc791 for details on IPv4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # If the destination port is 80 and there is data in the packet, then probably this is an HTTP request.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # TO be certain, there should&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    # be a TCP finite state machine in here.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if tcp.dport == 80 and len(tcp.data) &amp;gt; 0:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        http_req = dpkt.http.Request(tcp.data)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        print(&amp;quot;URI is &amp;quot;, http_req.uri)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        for header in http_req.headers.keys():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            print(header, http_req.headers[header])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # [&amp;apos;_Request__methods&amp;apos;, &amp;apos;_Request__proto&amp;apos;, &amp;apos;__class__&amp;apos;, &amp;apos;__delattr__&amp;apos;, &amp;apos;__dict__&amp;apos;, &amp;apos;__doc__&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        #  &amp;apos;__format__&amp;apos;, &amp;apos;__getattribute__&amp;apos;, &amp;apos;__getitem__&amp;apos;, &amp;apos;__hash__&amp;apos;, &amp;apos;__hdr_defaults__&amp;apos;, &amp;apos;__init__&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        #  &amp;apos;__len__&amp;apos;, &amp;apos;__metaclass__&amp;apos;, &amp;apos;__module__&amp;apos;, &amp;apos;__new__&amp;apos;, &amp;apos;__reduce__&amp;apos;, &amp;apos;__reduce_ex__&amp;apos;, &amp;apos;__repr__&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # &amp;apos;__setattr__&amp;apos;, &amp;apos;__sizeof__&amp;apos;, &amp;apos;__str__&amp;apos;, &amp;apos;__subclasshook__&amp;apos;, &amp;apos;__weakref__&amp;apos;, &amp;apos;body&amp;apos;, &amp;apos;data&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # &amp;apos;headers&amp;apos;, &amp;apos;method&amp;apos;, &amp;apos;pack&amp;apos;, &amp;apos;pack_hdr&amp;apos;, &amp;apos;unpack&amp;apos;, &amp;apos;uri&amp;apos;, &amp;apos;version&amp;apos;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        print(&amp;quot;method is &amp;quot;, http_req.method)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # &amp;apos;body&amp;apos;, &amp;apos;data&amp;apos;, &amp;apos;headers&amp;apos;, &amp;apos;method&amp;apos;, &amp;apos;pack&amp;apos;, &amp;apos;pack_hdr&amp;apos;, &amp;apos;unpack&amp;apos;, &amp;apos;uri&amp;apos;, &amp;apos;version&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        print(&amp;quot;HTTP headers, packed &amp;quot;, http_req.pack())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        print(&amp;quot;HTTP version&amp;quot;, http_req.version)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        print(&amp;quot;HTTP data &amp;quot;, http_req.data)  # I think this is valid if the method is POST&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if tcp.sport == 80 and len(tcp.data) &amp;gt; 0:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        try:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            http = dpkt.http.Response(tcp.data)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            print(&amp;quot;HTTP version is &amp;quot;, http.version)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            print(&amp;quot;Status code is &amp;quot;, http.status)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            print(&amp;quot;Status reason &amp;quot;, http.reason)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            for header in http.headers.keys():&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                print(header, http.headers[header])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                # print &amp;quot;date&amp;quot;, http.headers[&amp;apos;date&amp;apos;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                # print &amp;quot;accept-ranges&amp;quot;, http.headers[&amp;apos;accept-ranges&amp;apos;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                # print &amp;quot;content-type&amp;quot;, http.headers[&amp;apos;content-type&amp;apos;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                #            print &amp;quot;connection&amp;quot;, http.headers[&amp;apos;connection&amp;apos;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                #            print &amp;quot;server&amp;quot;, http.headers[&amp;apos;server&amp;apos;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        except dpkt.dpkt.UnpackError:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            print(&amp;quot;Encounted an unpacking error&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;for ptime, packet in sniffer:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    try:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # process_packet(ptime, packet)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        print_http_packet(ptime, packet)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    except Exception as e:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        # print(e)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pass&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;环境安装&quot;&gt;&lt;a href=&quot;#环境安装&quot; class=&quot;headerlink&quot; title=&quot;环境安装&quot;&gt;&lt;/a&gt;环境安装&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;code&gt;easy_install winpcapy&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;easy_install pcapy&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在这第2步安装pcapy时报错了:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Searching for pcapy&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Reading https://pypi.python.org/simple/pcapy/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Best match: pcapy 0.11.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Downloading https://pypi.python.org/packages/7f/12/626c6c1ee949b6d447f887a65388aa83faec6feb247e1bdf2478139a6078/pcapy-0.11.1.tar.gz#md5=24f8f339f1f1b00b2b43fe3c6910cbc1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Processing pcapy-0.11.1.tar.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Writing c:\users\terry\appdata\local\temp\easy_install-vf9ep5\pcapy-0.11.1\setup.cfg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Running pcapy-0.11.1\setup.py -q bdist_egg --dist-dir c:\users\terry\appdata\local\temp\easy_install-vf9ep5\pcapy-0.11.1\egg-dist-tmp-0vrahf&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;error: Setup script exited with error: Microsoft Visual C++ 9.0 is required (Unable to find vcvarsall.bat). Get it from http://aka.ms/vcpython27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;原来pcapy下载下来不是直接可用的，而是需要先编译，按照提示在浏览器中打开了&lt;a href=&quot;http://aka.ms/vcpython27&quot;&gt;http://aka.ms/vcpython27&lt;/a&gt;链接，跳转到微软官网上下载了&lt;a href=&quot;https://www.microsoft.com/en-us/download/details.aspx?id=44266&quot;&gt;Microsoft Visual C++ Compiler for Python 2.7&lt;/a&gt;,然后安装，安装位置是&lt;code&gt;%appdata%\Local\Programs\Common\Microsoft\Visual C++ for Python\9.0&lt;/code&gt;,安装后继续easy_install，结果又报一错误。
    
    </summary>
    
      <category term="python" scheme="http://baba.zhaoxiuyuan.com/categories/python/"/>
    
    
      <category term="python" scheme="http://baba.zhaoxiuyuan.com/tags/python/"/>
    
      <category term="wincap" scheme="http://baba.zhaoxiuyuan.com/tags/wincap/"/>
    
      <category term="net" scheme="http://baba.zhaoxiuyuan.com/tags/net/"/>
    
  </entry>
  
  <entry>
    <title>Makefile随笔(一)：shell 执行</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/09/123_makefile_1/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/09/123_makefile_1/</id>
    <published>2017-09-28T07:34:28.000Z</published>
    <updated>2017-09-29T07:39:36.018Z</updated>
    
    <content type="html">&lt;h2 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://seisman.github.io/how-to-write-makefile/recipes.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;跟我一起写Makefile&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;shell&quot;&gt;&lt;a href=&quot;#shell&quot; class=&quot;headerlink&quot; title=&quot;shell&quot;&gt;&lt;/a&gt;shell&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;我们在UNIX下可能会使用不同的Shell，但是make的命令默认是被 /bin/sh ——UNIX的标准Shell 解释执行的。除非你特别指定一个其它的Shell。Makefile中， # 是注释符，很像C/C++中的 // ，其后的本行字符都被注释。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;但windows上没有提到命令行是被谁解析，但在编译某个开源代码时使用只有使用作者打包的mingw才能编译成功，使用TDM-GCC-64、nuwen-mingw、MinGW.org的mingw都编译失败，最后发现是shell问题。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;把makefile精简成&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;folder:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	echo &amp;quot;folder&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	mkdir build&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	mkdir -p build/test	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	mkdir  build\test\test2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;使用&lt;code&gt;cmd&lt;/code&gt;来执行&lt;code&gt;make&lt;/code&gt;、&lt;code&gt;mingw32-make&lt;/code&gt;都会提示&lt;code&gt;mkdir -p build/test&lt;/code&gt;这一行&lt;strong&gt;命令语法不正确。&lt;/strong&gt;，使用&lt;code&gt;msys&lt;/code&gt;或&lt;code&gt;Git-bash&lt;/code&gt;(也是基于msys)以及作者提供的&lt;code&gt;mingw&lt;/code&gt;中的&lt;code&gt;make&lt;/code&gt;时就会创建文件夹成功。&lt;/p&gt;
&lt;p&gt;然后发现，作者提供的&lt;code&gt;mingw\bin&lt;/code&gt;中有一个&lt;code&gt;sh.exe&lt;/code&gt;，以及&lt;code&gt;msys&lt;/code&gt;、&lt;code&gt;git-bash&lt;/code&gt;的&lt;code&gt;bin&lt;/code&gt;目录下都有&lt;code&gt;sh.exe&lt;/code&gt;，结合上面&lt;a href=&quot;https://seisman.github.io/how-to-write-makefile/recipes.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;跟我一起写Makefile&lt;/a&gt;中的那一句，答案就应该是如果当前&lt;code&gt;PATH&lt;/code&gt;中有&lt;code&gt;sh.exe&lt;/code&gt;则会使用&lt;code&gt;sh.exe&lt;/code&gt;来执行命令行，&lt;code&gt;sh.exe&lt;/code&gt;能正确处理linux风格的路径。&lt;/p&gt;
&lt;p&gt;随带：&lt;code&gt;sh.exe&lt;/code&gt;的参数格式是&lt;code&gt;sh.exe --login -c &amp;quot;&amp;lt;command&amp;gt;&amp;quot;&lt;/code&gt;,举例：&lt;code&gt;sh.exe --login -c &amp;quot;echo hello&amp;quot;&lt;/code&gt;。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://seisman.github.io/how-to-write-makefile/recipes.html&quot;&gt;跟我一起写Makefile&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;shell&quot;&gt;&lt;a href=&quot;#shell&quot; class=&quot;headerlink&quot; title=&quot;shell&quot;&gt;&lt;/a&gt;shell&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;我们在UNIX下可能会使用不同的Shell，但是make的命令默认是被 /bin/sh ——UNIX的标准Shell 解释执行的。除非你特别指定一个其它的Shell。Makefile中， # 是注释符，很像C/C++中的 // ，其后的本行字符都被注释。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;但windows上没有提到命令行是被谁解析，但在编译某个开源代码时使用只有使用作者打包的mingw才能编译成功，使用TDM-GCC-64、nuwen-mingw、MinGW.org的mingw都编译失败，最后发现是shell问题。&lt;br&gt;
    
    </summary>
    
      <category term="开源项目" scheme="http://baba.zhaoxiuyuan.com/categories/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/"/>
    
    
      <category term="shell" scheme="http://baba.zhaoxiuyuan.com/tags/shell/"/>
    
      <category term="gnu" scheme="http://baba.zhaoxiuyuan.com/tags/gnu/"/>
    
      <category term="make" scheme="http://baba.zhaoxiuyuan.com/tags/make/"/>
    
      <category term="makefile" scheme="http://baba.zhaoxiuyuan.com/tags/makefile/"/>
    
  </entry>
  
  <entry>
    <title>Visual Studio 2017 / 2015 命令行编译 找不到 stdlib.h 的问题</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/09/122_vs_cmd_win10_sdk/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/09/122_vs_cmd_win10_sdk/</id>
    <published>2017-09-28T06:12:28.000Z</published>
    <updated>2017-10-11T06:39:53.146Z</updated>
    
    <content type="html">&lt;p&gt;上周折腾了下VS不能使用XP系统工具集（如：vc140_xp）编译的问题，原因是不知道为何以前安装的windows SDK 8 不完整，但是单独安装winsdk 8.0的话安装包又崩溃退出，包括用vs2015和vs2017修复都修复不成功。&lt;/p&gt;
&lt;p&gt;所以最后是彻底卸载了vs2015、vs2017后依次再重装解决问题。&lt;br&gt;结果本周在mingw+msvc编译某项目时就报出了错误&lt;code&gt;fatal error C1083: 无法打开包括文件: “stdio.h”: No such file or directory&lt;/code&gt;。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;但是单独使用VS2015或VS2017去编译时又可以编译成功，右键&lt;code&gt;stdio.h&lt;/code&gt;打开头文件时定位到了路径&lt;code&gt;&amp;quot;C:\Program Files (x86)\Windows Kits\10\Include\10.0.10240.0\ucrt\stdio.h&amp;quot;&lt;/code&gt;,为什么IDE能够找到头文件而命令行不行呢?&lt;/p&gt;
&lt;p&gt;接着&lt;code&gt;VS2015 x86 本机工具命令提示符&lt;/code&gt;中执行&lt;code&gt;set INCLUDE&lt;/code&gt;时发现包含了一系列头文件路径中有&lt;code&gt;C:\Program Files (x86)\Windows Kits\10\Include\10.0.15063.0\ucrt&lt;/code&gt;但是没有10.0.10240.0,而&lt;code&gt;10.0.15063.0&lt;/code&gt;下没有ucrt目录。&lt;/p&gt;
&lt;p&gt;一开始觉得可能是10.0.15063.0的安装有问题，就打开vs2017的安装程序点修改，发现所有10.0.15063.0相关的安装选项都是勾上的。然后将其全部反勾选并且勾选上另一个&lt;code&gt;win10 sdk 10.0.14393.0&lt;/code&gt;，然后安装后使用命令行成功编译，看INCLUDE也能看到ucrt目录变成了&lt;code&gt;&amp;quot;C:\Program Files (x86)\Windows Kits\10\Include\10.0.14393.0&amp;quot;&lt;/code&gt;下的了。&lt;/p&gt;
&lt;p&gt;然后再修改安装包将所有10.0.15063.0相关的安装选项都勾上，再安装后用命令行发现INCLUDE也能看到ucrt目录变成了&lt;code&gt;&amp;quot;C:\Program Files (x86)\Windows Kits\10\Include\10.0.15063.0&amp;quot;&lt;/code&gt;下的了，然后也能编译成功了，自此命令行的问题解决了。&lt;/p&gt;
&lt;p&gt;猜想：命令行查找win10 sdk的方式是找注册表中的&lt;strong&gt;最高版本号&lt;/strong&gt;，并不验证用户是否安装完整的win10 sdk。&lt;/p&gt;
&lt;p&gt;衍生问题：&lt;br&gt;我机器上还有两个不完整的win10 sdk，10.0.10150.0和10.0.10240.0，在vs里的项目属性中，如果选择平台工具集为&lt;strong&gt;Visual Studio 2017 - Windows XP (v141_xp)&lt;/strong&gt;，则&lt;strong&gt;Windows SDK版本&lt;/strong&gt;默认变成了7.0，点击下拉后有可选项8.1，&lt;strong&gt;目标平台&lt;/strong&gt;显示空白。&lt;br&gt;如果选择平台工具集为&lt;strong&gt;Visual Studio 2017 (v141)&lt;/strong&gt;，则&lt;strong&gt;Windows SDK版本&lt;/strong&gt;可选项有10.0.14393.0、10.0.15063.0、8.1三个版本。如果选择8.1，则目标平台显示Windows；如果选择10.0.x.0，则目标平台显示Windows 10。&lt;/p&gt;
&lt;p&gt;猜想：在IDE里可选的Windows SDK版本取自完整安装的sdk，如果平台工具集是v141_xp，为了支持XP，所以目标平台不做限定，且Windows SDK至多只能使用8.1。如果选择v141，则默认不支持xp，如果同时SDK版本选择了10.x，可能默认只支持win10（仅猜测，未验证）。&lt;/p&gt;
&lt;p&gt;还有一个疑问，在我机器上同时存在4个版本的ucrt的情况下，IDE计算出来的包含目录是10.0.10240.0，即不是最小版本号的那个，也不是最大版本号的那个，这个就不清楚原因了，可能要看下MSBUILD的那些Props文件才可以得出答案了。&lt;/p&gt;
&lt;p&gt;2017/10/11 补充：&lt;br&gt;“X:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat”的命令行如下:&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Syntax:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vcvarsall.bat [arch] [platform_type] [winsdk_version] [-vcvars_ver=vc_version]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;where :&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [arch]: x86 | amd64 | x86_amd64 | x86_arm | x86_arm64 | amd64_x86 | amd64_arm | amd64_arm64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [platform_type]: &amp;#123;empty&amp;#125; | store | uwp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [winsdk_version] : full Windows 10 SDK number (e.g. 10.0.10240.0) or &amp;quot;8.1&amp;quot; to use the Windows 8.1 SDK.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    [vc_version] : &amp;quot;14.0&amp;quot; for VC++ 2015 Compiler Toolset | &amp;#123;empty&amp;#125; for default VS 2017 VC++ compiler toolset&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;The store parameter sets environment variables to support Universal Windows Platform application&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;development and is an alias for &amp;apos;uwp&amp;apos;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;For example:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vcvarsall.bat x86_amd64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vcvarsall.bat x86_amd64 10.0.10240.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vcvarsall.bat x86_arm uwp 10.0.10240.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vcvarsall.bat x86_arm onecore 10.0.10240.0 -vcvars_ver=14.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vcvarsall.bat x64 8.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    vcvarsall.bat x64 store 8.1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;看命令行中可以指定windows sdk的版本号。如果未指定，看bat的代码是引用 &lt;code&gt;X:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat&lt;/code&gt;时不加&lt;code&gt;-winsdk&lt;/code&gt;参数，然后在&lt;code&gt;VsDevCmd.bat&lt;/code&gt;里转调&lt;code&gt;X:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\vsdevcmd\core\winsdk.bat&lt;/code&gt;来确定windows sdk的版本号，在bat里有这么一段代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;:GetWin10SdkDirHelper&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@REM Get Windows 10 SDK installed folder&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;for /F &amp;quot;tokens=1,2*&amp;quot; %%i in (&amp;apos;reg query &amp;quot;%1\Microsoft\Microsoft SDKs\Windows\v10.0&amp;quot; /v &amp;quot;InstallationFolder&amp;quot;&amp;apos;) DO (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if &amp;quot;%%i&amp;quot;==&amp;quot;InstallationFolder&amp;quot; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        SET WindowsSdkDir=%%~k&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@REM get windows 10 sdk version number&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;setlocal enableDelayedExpansion&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;if not &amp;quot;%WindowsSdkDir%&amp;quot;==&amp;quot;&amp;quot; for /f %%i IN (&amp;apos;dir &amp;quot;%WindowsSdkDir%include\&amp;quot; /b /ad-h /on&amp;apos;) DO (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    @REM Skip if Windows.h is not found in %%i\um.  This would indicate that only the UCRT MSIs were&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    @REM installed for this Windows SDK version.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if EXIST &amp;quot;%WindowsSdkDir%include\%%i\um\Windows.h&amp;quot; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        set result=%%i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        if &amp;quot;!result:~0,3!&amp;quot;==&amp;quot;10.&amp;quot; (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            set SDK=!result!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            if &amp;quot;!result!&amp;quot;==&amp;quot;%VSCMD_ARG_WINSDK%&amp;quot; set findSDK=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;由上面代码中看出，bat里只检测windows 10安装目录里是否有某版本的&lt;code&gt;include&lt;/code&gt;目录里有&lt;code&gt;um\windows.h&lt;/code&gt;即拿来使用，所以才导致上面提到的引用了一个安装不完整的&lt;code&gt;win10 sdk&lt;/code&gt;的问题。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;上周折腾了下VS不能使用XP系统工具集（如：vc140_xp）编译的问题，原因是不知道为何以前安装的windows SDK 8 不完整，但是单独安装winsdk 8.0的话安装包又崩溃退出，包括用vs2015和vs2017修复都修复不成功。&lt;/p&gt;
&lt;p&gt;所以最后是彻底卸载了vs2015、vs2017后依次再重装解决问题。&lt;br&gt;结果本周在mingw+msvc编译某项目时就报出了错误&lt;code&gt;fatal error C1083: 无法打开包括文件: “stdio.h”: No such file or directory&lt;/code&gt;。&lt;br&gt;
    
    </summary>
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/categories/windows/"/>
    
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/tags/windows/"/>
    
      <category term="visual studio" scheme="http://baba.zhaoxiuyuan.com/tags/visual-studio/"/>
    
  </entry>
  
  <entry>
    <title>几种mingw使用记录</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/09/121_mingw_record/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/09/121_mingw_record/</id>
    <published>2017-09-14T03:12:28.000Z</published>
    <updated>2017-09-26T10:05:09.287Z</updated>
    
    <content type="html">&lt;h1 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;windows 10 64位 专业版 1607（内部版本 14393.1715）&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://mingw.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;mingw&lt;/a&gt; 多年前装的版本，但使用&lt;a href=&quot;https://sourceforge.net/projects/mingw/files/latest/download?source=files&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;在线安装器&lt;/a&gt; 到了最新&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://nuwen.net/mingw.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;nuwen mingw&lt;/a&gt; &lt;a href=&quot;https://nuwen.net/files/mingw/mingw-15.1-without-git.exe&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;下载地址&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://sourceforge.net/projects/tdm-gcc/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;TDM-GCC-64&lt;/a&gt; &lt;a href=&quot;https://sourceforge.net/projects/tdm-gcc/files/latest/download&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;下载地址&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;mingw-w64 本来想也测下这个的，但是没下载动，算了。。。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;mingw-gcc-v&quot;&gt;&lt;a href=&quot;#mingw-gcc-v&quot; class=&quot;headerlink&quot; title=&quot;mingw gcc -v&quot;&gt;&lt;/a&gt;mingw gcc -v&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt; specs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;COLLECT_GCC=gcc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;COLLECT_LTO_WRAPPER=d:/mingw/bin/../libexec/gcc/mingw32/6.3.0/lto-wrapper.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mingw32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;../src/gcc-6.3.0/configure --build=x86_64-pc-linux-gnu --host=mingw32 --target=mingw32 --with-gmp=/mingw --with-mpfr --with-mpc=/mingw --with-isl=/mingw --prefix=/mingw --disable-win32-registry --with-arch=i586 --with-tune=generic --enable-languages=c,c++,objc,obj-c++,fortran,ada --with-pkgversion=&amp;apos;MinGW.org GCC-6.3.0-1&amp;apos; --enable-static --enable-shared --enable-threads --with-dwarf2 --disable-sjlj-exceptions --enable-version-specific-runtime-libs --with-libiconv-prefix=/mingw --with-libintl-prefix=/mingw --enable-libstdcxx-debug --enable-libgomp --disable-libvtv --enable-nls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;win32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gcc  6.3.0 (MinGW.org GCC-6.3.0-1)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;TDM-GCC-64-gcc-v&quot;&gt;&lt;a href=&quot;#TDM-GCC-64-gcc-v&quot; class=&quot;headerlink&quot; title=&quot;TDM-GCC-64 gcc -v&quot;&gt;&lt;/a&gt;TDM-GCC-64 gcc -v&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Using built-in specs.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;COLLECT_GCC=gcc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;COLLECT_LTO_WRAPPER=D:/TDM-GCC-64/bin/../libexec/gcc/x86_64-w64-mingw32/5.1.0/lto-wrapper.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Target: x86_64-w64-mingw32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Configured with: ../../../src/gcc-5.1.0/configure --build=x86_64-w64-mingw32 --enable-targets=all --enable-languages=ada,c,c++,fortran,lto,objc,obj-c++ --enable-libgomp --enable-lto --enable-graphite --enable-cxx-flags=-DWINPTHREAD_STATIC --disable-build-with-cxx --disable-build-poststage1-with-cxx --enable-libstdcxx-debug --enable-threads=posix --enable-version-specific-runtime-libs --enable-fully-dynamic-string --enable-libstdcxx-threads --enable-libstdcxx-time --with-gnu-ld --disable-werror --disable-nls --disable-win32-registry --prefix=/mingw64tdm --with-local-prefix=/mingw64tdm --with-pkgversion=tdm64-1 --with-bugurl=http://tdm-gcc.tdragon.net/bugs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Thread model: posix&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gcc version 5.1.0 (tdm64-1)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;nuwen-gcc-v&quot;&gt;&lt;a href=&quot;#nuwen-gcc-v&quot; class=&quot;headerlink&quot; title=&quot;nuwen gcc -v&quot;&gt;&lt;/a&gt;nuwen gcc -v&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Using built-in specs.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;COLLECT_GCC=gcc&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;COLLECT_LTO_WRAPPER=d:/mingw-nuwen-15.1/bin/../libexec/gcc/x86_64-w64-mingw32/7.2.0/lto-wrapper.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Target: x86_64-w64-mingw32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Configured with: ../src/configure --enable-languages=c,c++ --build=x86_64-w64-mingw32 --host=x86_64-w64-mingw32 --target=x86_64-w64-mingw32 --disable-multilib --prefix=/c/temp/gcc/dest --with-sysroot=/c/temp/gcc/dest --disable-libstdcxx-pch --disable-libstdcxx-verbose --disable-nls --disable-shared --disable-win32-registry --with-tune=haswell&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Thread model: win32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gcc version 7.2.0 (GCC)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;简单测试&quot;&gt;&lt;a href=&quot;#简单测试&quot; class=&quot;headerlink&quot; title=&quot;简单测试&quot;&gt;&lt;/a&gt;简单测试&lt;/h1&gt;&lt;p&gt;先创建一个简单的c文件：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;echo void main()&amp;#123;&amp;#125; &amp;gt; simple.c&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后使用不同的mingw环境来执行gcc进行编译链接，分别使用默认参数、-m32、-m64做测试。&lt;/p&gt;
&lt;h2 id=&quot;mingw&quot;&gt;&lt;a href=&quot;#mingw&quot; class=&quot;headerlink&quot; title=&quot;mingw&quot;&gt;&lt;/a&gt;mingw&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-gcc.exe&lt;/code&gt; 无输出，生成32位exe&lt;/li&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-gcc-m32.exe -m32&lt;/code&gt; 无输出，生成32位exe&lt;/li&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-gcc-m64.exe -m64&lt;/code&gt; 命令直接出错&lt;blockquote&gt;
&lt;p&gt;simple.c:1:0: 对不起，尚未实现：未编译入对 64 位模式的支持&lt;br&gt;void main(){}&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;nuwen&quot;&gt;&lt;a href=&quot;#nuwen&quot; class=&quot;headerlink&quot; title=&quot;nuwen&quot;&gt;&lt;/a&gt;nuwen&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-nuwen.exe&lt;/code&gt; 无输出，生成64位exe&lt;/li&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-nuwen-m64.exe -m64&lt;/code&gt; 无输出，生成64位exe&lt;/li&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-nuwen-m32.exe -m32&lt;/code&gt; 链接出错&lt;blockquote&gt;
&lt;p&gt;d:/mingw-nuwen-15.1/bin/../lib/gcc/x86_64-w64-mingw32/7.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: skipping incompatible d:/mingw-nuwen-15.1/bin/../lib/gcc/x86_64-w64-mingw32/7.2.0/../../../../x86_64-w64-mingw32/lib/libmingw32.a when searching for -lmingw32&lt;br&gt;…-lgcc、-lmoldname、-lmingwex、-lmsvcrt、-ladvapi32、-lshell32、-lkernel32…&lt;br&gt;x86_64-w64-mingw32/7.2.0/../../../../x86_64-w64-mingw32/lib/libmsvcrt.a when searching for -lmsvcrt&lt;br&gt;d:/mingw-nuwen-15.1/bin/../lib/gcc/x86_64-w64-mingw32/7.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: cannot find -lmsvcrt&lt;br&gt;collect2.exe: error: ld returned 1 exit status&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;TDM-GCC-64&quot;&gt;&lt;a href=&quot;#TDM-GCC-64&quot; class=&quot;headerlink&quot; title=&quot;TDM-GCC-64&quot;&gt;&lt;/a&gt;TDM-GCC-64&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-tdm.exe&lt;/code&gt; 无输出，生成64位exe&lt;/li&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-tdm-m64.exe -m64&lt;/code&gt; 无输出，生成64位exe&lt;/li&gt;
&lt;li&gt;&lt;code&gt;gcc simple.c -o simple-tdm-m32.exe -m32&lt;/code&gt; 无输出，生成32位exe&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;某项目用到了glibc，所以使用glibc再测一次&quot;&gt;&lt;a href=&quot;#某项目用到了glibc，所以使用glibc再测一次&quot; class=&quot;headerlink&quot; title=&quot;某项目用到了glibc，所以使用glibc再测一次&quot;&gt;&lt;/a&gt;某项目用到了glibc，所以使用glibc再测一次&lt;/h1&gt;&lt;p&gt;使用glibc 2.28版本，&lt;a href=&quot;http://ftp.acc.umu.se/pub/gnome/binaries/win32/glib/2.28/glib-dev_2.28.8-1_win32.zip&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;下载地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;上面编译失败的就不再尝试了，只尝试上面成功过的。&lt;/p&gt;
&lt;p&gt;使用测试代码：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;#include &amp;lt;glib.h&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;void main() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	char* buffer = (char *)g_malloc(100);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	g_free(buffer);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;MinGW-m32&quot;&gt;&lt;a href=&quot;#MinGW-m32&quot; class=&quot;headerlink&quot; title=&quot;MinGW -m32&quot;&gt;&lt;/a&gt;MinGW -m32&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gcc test.c -ID:\VC_INCLUDE\glibc-2.28.8\include\glib-2.0 -ID:\VC_INCLUDE\glibc-2.28.8\lib\glib-2.0\include  D:\VC_INCLUDE\glibc-2.28.8\bin\libglib-2.0-0.dll -o test-gcc.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;====&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;编译成功，生成32位exe&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;TDM-GCC-64-m32&quot;&gt;&lt;a href=&quot;#TDM-GCC-64-m32&quot; class=&quot;headerlink&quot; title=&quot;TDM-GCC-64 -m32&quot;&gt;&lt;/a&gt;TDM-GCC-64 -m32&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gcc test.c -ID:\VC_INCLUDE\glibc-2.28.8\include\glib-2.0 -ID:\VC_INCLUDE\glibc-2.28.8\lib\glib-2.0\include  D:\VC_INCLUDE\glibc-2.28.8\bin\libglib-2.0-0.dll -o test-tdm-m32.exe -m32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;====&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;编译成功，生成32位exe&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;TDM-GCC-64-不使用-m32-链接出错-没有glibc的64位lib&quot;&gt;&lt;a href=&quot;#TDM-GCC-64-不使用-m32-链接出错-没有glibc的64位lib&quot; class=&quot;headerlink&quot; title=&quot;TDM-GCC-64 不使用-m32 链接出错(没有glibc的64位lib)&quot;&gt;&lt;/a&gt;TDM-GCC-64 不使用-m32 链接出错(没有glibc的64位lib)&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gcc test.c -ID:\VC_INCLUDE\glibc-2.28.8\include\glib-2.0 -ID:\VC_INCLUDE\glibc-2.28.8\lib\glib-2.0\include  D:\VC_INCLUDE\glibc-2.28.8\bin\libglib-2.0-0.dll -o test-tdm.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;====&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;C:\Users\terry\AppData\Local\Temp\ccA3V4Ba.o:test.c:(.text+0x13): undefined reference to `g_malloc&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;C:\Users\terry\AppData\Local\Temp\ccA3V4Ba.o:test.c:(.text+0x23): undefined reference to `g_free&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;collect2.exe: error: ld returned 1 exit status&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;nuwen-链接出错-没有glibc的64位lib&quot;&gt;&lt;a href=&quot;#nuwen-链接出错-没有glibc的64位lib&quot; class=&quot;headerlink&quot; title=&quot;nuwen 链接出错 (没有glibc的64位lib)&quot;&gt;&lt;/a&gt;nuwen 链接出错 (没有glibc的64位lib)&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;gcc test.c -ID:\VC_INCLUDE\glibc-2.28.8\include\glib-2.0 -ID:\VC_INCLUDE\glibc-2.28.8\lib\glib-2.0\include  D:\VC_INCLUDE\glibc-2.28.8\bin\libglib-2.0-0.dll -o test-nuwen.exe&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;====&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;C:\Users\terry\AppData\Local\Temp\ccedeuKo.o:test.c:(.text+0x13): undefined reference to `g_malloc&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;C:\Users\terry\AppData\Local\Temp\ccedeuKo.o:test.c:(.text+0x23): undefined reference to `g_free&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;collect2.exe: error: ld returned 1 exit status&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h1&gt;&lt;p&gt;反正TDM-GCC-64这个最好使，默认下载下来就支持32位和64位的gcc编译，其它的估计都得自己再折腾。但nuwen的优势是版本更新快，自带的3方库最多。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;windows 10 64位 专业版 1607（内部版本 14393.1715）&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://mingw.org/&quot;&gt;mingw&lt;/a&gt; 多年前装的版本，但使用&lt;a href=&quot;https://sourceforge.net/projects/mingw/files/latest/download?source=files&quot;&gt;在线安装器&lt;/a&gt; 到了最新&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://nuwen.net/mingw.html&quot;&gt;nuwen mingw&lt;/a&gt; &lt;a href=&quot;https://nuwen.net/files/mingw/mingw-15.1-without-git.exe&quot;&gt;下载地址&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://sourceforge.net/projects/tdm-gcc/&quot;&gt;TDM-GCC-64&lt;/a&gt; &lt;a href=&quot;https://sourceforge.net/projects/tdm-gcc/files/latest/download&quot;&gt;下载地址&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;mingw-w64 本来想也测下这个的，但是没下载动，算了。。。
    
    </summary>
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/categories/windows/"/>
    
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/tags/windows/"/>
    
      <category term="gnu" scheme="http://baba.zhaoxiuyuan.com/tags/gnu/"/>
    
      <category term="gcc" scheme="http://baba.zhaoxiuyuan.com/tags/gcc/"/>
    
      <category term="mingw" scheme="http://baba.zhaoxiuyuan.com/tags/mingw/"/>
    
  </entry>
  
  <entry>
    <title>修改so导出函数名称</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/09/120_redefine_so_dynamic_symbols/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/09/120_redefine_so_dynamic_symbols/</id>
    <published>2017-09-14T03:12:28.000Z</published>
    <updated>2017-09-14T03:03:59.543Z</updated>
    
    <content type="html">&lt;p&gt;最近有一个需求是将某so（无源码）的某些函数名称改掉。搜遍网络没有直接的解决方案，最后是综合多个地方的资料和建议及类似代码，自己弄出了个不通用的解决方案。&lt;/p&gt;
&lt;p&gt;首先，so没有源码，所以不可能直接修改导出函数，一开始的思路就是下面这两种解决方案：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过ida将so反编译成源码，然后再手动整理成可编译的代码，再去改。&lt;/li&gt;
&lt;li&gt;so是ELF格式的，直接以二进制方式修改这个ELF文件应该可以达到目的。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;以上两种方法中，1最彻底，实行完之后代码就是可维护可更新的了，以后加什么新功能或其它改动都可以。但我使用ida及Hex-ray插件生成c伪代码后看了看代码就放弃了。一个264KB的so，反编译出来了795KB的代码，这你敢信。。。 反编译出来的代码中大量的sub_xxx函数，还结合各种汇编代码，各种跳转，除了调用其它so以及自身的导出函数的名称是可见的，其它一概不可见。预计恢复难度较高，至少在一周的工作时间，所以暂时搁置了。&lt;/p&gt;
&lt;p&gt;然后就研究第2种修改ELF格式的方法，首先查找了一些资料如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://oiwjee823.bkt.clouddn.com/ELF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%88%86%E6%9E%90.pdf&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ELF文件格式分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.oracle.com/cd/E23824_01/html/819-0690/chapter6-73709.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;String Table Section格式&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.cppblog.com/tqsheng/archive/2012/12/07/196107.aspx&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.cppblog.com/tqsheng/archive/2012/12/07/196107.aspx&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://docs.oracle.com/cd/E26926_01/html/E25910/chapter6-48031.html#scrolltoc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://docs.oracle.com/cd/E26926_01/html/E25910/chapter6-48031.html#scrolltoc&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以及elf分析的相关工具：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/readelf.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;readelf elf文件格式分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/objdump.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;objdump 二进制文件分析&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;也找到同样尝试修改导出函数名称的人，还有半成品代码：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://stackoverflow.com/questions/20492225/how-to-rename-dynamic-symbols-in-arm-elf-so-file&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;how-to-rename-dynamic-symbols-in-arm-elf-so-file&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;(&lt;a href=&quot;http://binutils.sourceware.narkive.com/fZHiSvNm/objcopy-redefine-dynamic-symbols&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://binutils.sourceware.narkive.com/fZHiSvNm/objcopy-redefine-dynamic-symbols&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;然后花了点时间熟悉了makefile及linux编译（没有使用Android Studio+NDK来实现，因为毕竟是工具类），再在github上一个&lt;a href=&quot;https://github.com/BR903/ELFkickers&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;elf工具集&lt;/a&gt;的基础上增加了个redefine工具。&lt;/p&gt;
&lt;p&gt;看到这里,我假设你已经读了上面一些ELF相关资料,所以下面的解释对ELF相关术语不做详述。&lt;/p&gt;
&lt;p&gt;一开始很顺利，找到类型为&lt;code&gt;DYNSYM&lt;/code&gt;的section，然后找到它对应的类型为&lt;code&gt;STRTAB&lt;/code&gt;的section，然后直接取出整个section,遍历里面的所有字符串(都是以\0结尾，和c字符串一样),然后将字符串修改成新的字符串,目前只支持&lt;strong&gt;将长字符串替换成短&lt;/strong&gt;的,然后把\0前未替换的部分前移（如果替换前后一样长就不用前移了），在后面多余的地方补0。&lt;/p&gt;
&lt;p&gt;替换完了后，使用dlsym加载发现找不到符号，然后就发现了* &lt;a href=&quot;http://blog.csdn.net/gxd_506/article/details/38843567&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ELF格式可执行文件，更改符号名称要注意的地方&lt;/a&gt;，所以又改进了代码，加上了rehash的步骤。&lt;/p&gt;
&lt;p&gt;然后测试修改用ndk生成的一个hellojni的示例后成功。但是在实际使用中发现了一个奇葩的问题，即比如原导出函数Java_com_&lt;em&gt;example&lt;/em&gt; _test_TestJni_mprotect,被我替换成Java_com_&lt;em&gt;abcdef&lt;/em&gt;_test_TestJni_mprotect，在加载时提示&lt;code&gt;dlopen failed: cannot locate symbol &amp;quot;protect&amp;quot; referenced by &amp;quot;/data/app/com.xxxx.xxxx-2/lib/arm/libmxxxx_xxx.so&amp;quot;&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://upload-images.jianshu.io/upload_images/4625619-93dd149a1320fa78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&quot; alt=&quot;dlopen failed: cannot locate symbol &amp;quot;protect&amp;quot; referenced by &amp;quot;/data/app/com.xxxx.xxxx-2/lib/arm/libmxxxx_xxx.so&amp;quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;使用ida反编译修改后的so发现，有一个import function名为mprotect，在修改后变成了protect，再使用readelf查看section信息：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Section Headers:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 0]                   NULL            00000000 000000 000000 00      0   0  0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 1] .note.gnu.build-i NOTE            00000114 000114 000024 00   A  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 2] .hash             HASH            00000138 000138 002210 04   A  3   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 3] .dynsym           DYNSYM          00002348 002348 0047b0 10   A  4   3  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 4] .dynstr           STRTAB          00006af8 006af8 012751 00   A  0   0  1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 5] .gnu.version      VERSYM          0001924a 01924a 0008f6 02   A  3   0  2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 6] .gnu.version_r    VERNEED         00019b40 019b40 000040 00   A  4   2  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 7] .rel.dyn          REL             00019b80 019b80 000250 08   A  3   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 8] .rel.plt          REL             00019dd0 019dd0 000260 08  AI  3   9  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [ 9] .plt              PROGBITS        0001a030 01a030 0003a4 04  AX  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [10] .text             PROGBITS        0001a3d4 01a3d4 0180e0 00  AX  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [11] .rodata           PROGBITS        000324b4 0324b4 0021ac 00   A  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [12] .ARM.extab        PROGBITS        00034660 034660 003d24 00   A  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [13] .ARM.exidx        ARM_EXIDX       00038384 038384 0025a0 00  AL 10   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [14] .init_array       INIT_ARRAY      00040c74 040c74 00000c 00  WA  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [15] .fini_array       FINI_ARRAY      00040c80 040c80 000008 00  WA  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [16] .data.rel.ro      PROGBITS        00040c88 040c88 0000b8 00  WA  0   0  8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [17] .dynamic          DYNAMIC         00040d40 040d40 000128 08  WA  4   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [18] .got              PROGBITS        00040e68 040e68 000194 04  WA  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [19] .data             PROGBITS        00041000 041000 000070 00  WA  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [20] .bss              NOBITS          00041070 041070 0029a4 00  WA  0   0  4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [21] .comment          PROGBITS        00000000 041070 000027 01  MS  0   0  1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [22] .ARM.attributes   ARM_ATTRIBUTES  00000000 041097 000031 00      0   0  1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [23] .shstrtab         STRTAB          00000000 0410c8 0000dd 00      0   0  1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中 &lt;code&gt;[ 3] .dynsym&lt;/code&gt;和&lt;code&gt;[17] .dynamic&lt;/code&gt;都引用的是索引为4的&lt;code&gt;[ 4] .dynstr           STRTAB&lt;/code&gt;。那么问题很明显了，应该是导入表和导出表共用了字符表，并且共用了同一个字符串，只不过索引不同。在修改函数名称时，因为是将example替换成了abcdef后，将后面的&lt;code&gt;_test_TestJni_mprotect&lt;/code&gt;前移了1位，导致mprotect这个符号引用的name指向了protect。&lt;/p&gt;
&lt;p&gt;那么如果想解决这个问题，还得在修改字符表后，枚举所有引用了同一个字符表的section，并查看它里面的每一个符号引用的字符串是某是被修改并移位过的，也要修改它的st_name，然后保存。&lt;/p&gt;
&lt;p&gt;已经在这个问题上折腾了几天的我不想再继续倒腾了，所以就调整了下替换字符串的长度，把abcdef换成了abcdefg，这样的话所有符号的st_name索引都不会变化了。&lt;/p&gt;
&lt;p&gt;如果以后有机会，会把未完成的功能做完：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;支持短字符替换成长字符。&lt;/li&gt;
&lt;li&gt;替换字符串并移位后检查所有引用同一字符串的符号，修改其st_name。&lt;/li&gt;
&lt;li&gt;测试对于不同平台上的的so的兼容性。&lt;/li&gt;
&lt;li&gt;支持GCC编译出来的GNU_HASH(没有.hash段)的Section。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;最后附上代码：&lt;a href=&quot;https://github.com/k1988/ELFkickers/tree/master/redefine&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/k1988/ELFkickers/tree/master/redefine&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近有一个需求是将某so（无源码）的某些函数名称改掉。搜遍网络没有直接的解决方案，最后是综合多个地方的资料和建议及类似代码，自己弄出了个不通用的解决方案。&lt;/p&gt;
&lt;p&gt;首先，so没有源码，所以不可能直接修改导出函数，一开始的思路就是下面这两种解决方案：&lt;/p&gt;
&lt;ol&gt;

    
    </summary>
    
      <category term="linux" scheme="http://baba.zhaoxiuyuan.com/categories/linux/"/>
    
    
      <category term="elf" scheme="http://baba.zhaoxiuyuan.com/tags/elf/"/>
    
      <category term="ndk" scheme="http://baba.zhaoxiuyuan.com/tags/ndk/"/>
    
      <category term="linux" scheme="http://baba.zhaoxiuyuan.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Android NDK 知识大全</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/08/119_ndk/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/08/119_ndk/</id>
    <published>2017-08-18T07:12:28.000Z</published>
    <updated>2018-02-08T05:49:54.640Z</updated>
    
    <content type="html">&lt;h1 id=&quot;引用&quot;&gt;&lt;a href=&quot;#引用&quot; class=&quot;headerlink&quot; title=&quot;引用&quot;&gt;&lt;/a&gt;引用&lt;/h1&gt;&lt;h2 id=&quot;基本概念&quot;&gt;&lt;a href=&quot;#基本概念&quot; class=&quot;headerlink&quot; title=&quot;基本概念&quot;&gt;&lt;/a&gt;基本概念&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/concepts.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android官方文档-概念&lt;/a&gt;，从这里可以发散出JNI、ABI等需要学习的概念，按文档学习即可&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android Gradle插件节点定义&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;NDK安装配置&quot;&gt;&lt;a href=&quot;#NDK安装配置&quot; class=&quot;headerlink&quot; title=&quot;NDK安装配置&quot;&gt;&lt;/a&gt;NDK安装配置&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android官方指南&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.jianshu.com/p/9aff422204eb&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android Studio里NDK入门&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/zhaoguangjun33/article/details/51690136&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android Studio下使用NDK&lt;/a&gt;,这里提供了一些gradle里直接设置toolchain,CFlags等的示例&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;编译选项&quot;&gt;&lt;a href=&quot;#编译选项&quot; class=&quot;headerlink&quot; title=&quot;编译选项&quot;&gt;&lt;/a&gt;编译选项&lt;/h2&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/crash163/article/details/52228412&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android NDK编译选项设置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/wchinaw/article/details/19621285&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;NDK中C++标准库、STL的配置；Include其他头文件&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.jianshu.com/p/d9e9ba3312fc&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android Studio中对NDK进行设置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/android_mk.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android官方指南之Androd.mk&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/application_mk.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android官方指南之Androd.mk&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;资料整理&quot;&gt;&lt;a href=&quot;#资料整理&quot; class=&quot;headerlink&quot; title=&quot;资料整理&quot;&gt;&lt;/a&gt;资料整理&lt;/h1&gt;&lt;p&gt;无论是用Android Studio集成NDK，还是手动使用NDK命令行，有两个文件是必须的&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/android_mk.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android.mk&lt;/a&gt;: 在jni文件夹内必须创建这个文件，ndk-build命令也会首先查找此文件才能执行，文件里定义ndk编译的模块的名称、c/c++源代码，需要链接的库及构建选项（传递给编译工具gcc|clang等的参数）。&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/application_mk.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Application.mk&lt;/a&gt;: 这个文件定义需要构建的模块和构建环境及工具(如果是集成在 &lt;strong&gt;android studio&lt;/strong&gt;里，部分选项会被 &lt;strong&gt;gradle覆盖&lt;/strong&gt;)，包括以下：&lt;ul&gt;
&lt;li&gt;需要编译的目标平台&lt;a href=&quot;https://developer.android.com/ndk/guides/abis.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ABI&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;工具链接&lt;/li&gt;
&lt;li&gt;需要包含的标准库(static and dynamic STLport or default system).&lt;/li&gt;
&lt;li&gt;全局的编译选项&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Android-mk&quot;&gt;&lt;a href=&quot;#Android-mk&quot; class=&quot;headerlink&quot; title=&quot;Android.mk&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/android_mk.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Android.mk&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;示例：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;LOCAL_PATH := $(call my-dir) # 必须要使用这个开头&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;include $(CLEAR_VARS)  # 必须，清除编译环境中所有的LOCAL变量，否则同时编译多个Module时不同的Android.mk里的LOCAL变量会相互影响&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LOCAL_MODULE    := mcpelauncher # 必须，定义模块名称&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 必须，源文件文件列表&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LOCAL_SRC_FILES := nativepatch.c modscript.c modscript_nextgen.cpp modscript_ScriptLevelListener.cpp utf8proc_slim.c dobby.cpp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LOCAL_C_INCLUDES += E:\C_Shared\sdk\ndk-bundle\platforms\android-14\arch-arm\usr\include\&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LOCAL_LDLIBS := -llog   # 需要链接的NDK库&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LOCAL_SHARED_LIBRARIES := tinysubstrate-bin&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 必须，包含定义好的一个文件，获取抽有LOCAL变量并决定构建信息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;include $(BUILD_SHARED_LIBRARY)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$(call import-add-path, prebuilts) # 其它导入模块&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$(call import-module, tinysubstrate-bin)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;变量和宏&quot;&gt;&lt;a href=&quot;#变量和宏&quot; class=&quot;headerlink&quot; title=&quot;变量和宏&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/android_mk.html#var&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;变量和宏&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;命名规则：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LOCAL_： NDK编译系统使用的，提供给用户设置值&lt;/li&gt;
&lt;li&gt;PRIVATE&lt;em&gt;、NDK&lt;/em&gt;、APP：NDK编译系统内部使用，用户不要定义&lt;/li&gt;
&lt;li&gt;my-dir：一些小写名称，编译系统内部使用的&lt;/li&gt;
&lt;li&gt;MY_: 其它大写名称，是用户自定义（仅仅是推荐，用户可以使用其它前缀或不使用前缀）&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;NDK预定义变量&quot;&gt;&lt;a href=&quot;#NDK预定义变量&quot; class=&quot;headerlink&quot; title=&quot;NDK预定义变量&quot;&gt;&lt;/a&gt;NDK预定义变量&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;CLEAR_VARS&lt;/strong&gt; &lt;code&gt;include $(CLEAR_VARS)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;BUILD_SHARED_LIBRARY | BUILD_STATIC_LIBRARY&lt;/strong&gt; &lt;code&gt;include $(BUILD_SHARED_LIBRARY)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;PREBUILT_SHARED_LIBRARY | PREBUILT_STATIC_LIBRARY&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TARGET_ARCH&lt;/strong&gt; 目标cpu架构 取值arm、x86等&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TARGET_PLATFORM&lt;/strong&gt; 目标android版本 &lt;code&gt;TARGET_PLATFORM := android-22&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TARGET_ARCH_ABI&lt;/strong&gt; 目标cpu及架构的全名 如：&lt;code&gt;TARGET_ARCH_ABI := arm64-v8a x86&lt;/code&gt;，详表见&lt;a href=&quot;https://developer.android.com/ndk/guides/android_mk.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;官方文档&lt;/a&gt;中TARGET_ARCH_ABI一节。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TARGET_ABI&lt;/strong&gt; Android Api级别和ABI的组合&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;模块定义变量&quot;&gt;&lt;a href=&quot;#模块定义变量&quot; class=&quot;headerlink&quot; title=&quot;模块定义变量&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/android_mk.html#mdv&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;模块定义变量&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;这些变量是每个模块单独设置的，每个模块都需要做以下事情：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;初使化模块变量或者用CLEAR_VARS清除&lt;/li&gt;
&lt;li&gt;给一些变量赋值来描述模块的功能&lt;/li&gt;
&lt;li&gt;使用NDK预定义变量中的BUILD_XXX来定义模块的格式（动态库、静态库等）&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;变量列表（粗体为必须）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;LOCAL_PATH&lt;/strong&gt; 设置当前文件的路径，必须在Androd.mk的开头使用&lt;code&gt;LOCAL_PATH := $(call my-dir)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;LOCAL_MODULE&lt;/strong&gt; 当前模块名称，不能用空格。除了&lt;code&gt;CLEAR_VARS&lt;/code&gt;之外他要放在前面，不需要添加lib前缀和.so.a后缀。&lt;/li&gt;
&lt;li&gt;LOCAL_MODULE_FILENAME 模块文件名，可以指定一个新的模块文件名&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;LOCAL_SRC_FILES&lt;/strong&gt; 源文件文件列表&lt;/li&gt;
&lt;li&gt;LOCAL_CPP_EXTENSION 定义支持的c++源文件的后缀，一般来说可以用&lt;code&gt;LOCAL_CPP_EXTENSION := .cxx .cpp .cc&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;LOCAL_CPP_FEATURES c++语言特性，如rtti、exceptions等&lt;/li&gt;
&lt;li&gt;LOCAL_C_INCLUDES 头文件默认是相对于NDK的根目录，如果相对于当前目录要用&lt;code&gt;LOCAL_C_INCLUDES := $(LOCAL_PATH)//foo&lt;/code&gt;,需要设置在LOCAL_CFLAGS和LOCAL_CPPFLAGS &lt;strong&gt;之前&lt;/strong&gt;。ps：在windows上我想直接引用ndk目录，但使用了LOCAL_PATH后似乎就默认是当前目录了， 所以我最后使用了环境变量中的ndk目录。例：&lt;code&gt;LOCAL_C_INCLUDES += $(ANDROID_NDK_HOME)\platforms\$(TARGET_PLATFORM)\arch-$(TARGET_ARCH)\usr\include&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;LOCAL_CFLAGS 给c和c++的编译选项，从 android-ndk-1.5_r1开始，此选项仅适用于c语言&lt;/li&gt;
&lt;li&gt;LOCAL_CPPFLAGS 给c++的编译选项&lt;/li&gt;
&lt;li&gt;LOCAL_STATIC_LIBRARIES 当前模块依赖的静态库，如果当前模块也是静态库，这个表明引用当前模块的也自动依赖这些静态库。如果当前模块是可执行程序或动态库，则链接这些静态库。&lt;/li&gt;
&lt;li&gt;LOCAL_SHARED_LIBRARIES 运行时依赖的动态库，仅用在链接时&lt;/li&gt;
&lt;li&gt;LOCAL_LDLIBS 声明链接时引用的动态库,-l作为前缀，例&lt;code&gt;LOCAL_LDLIBS := -lz&lt;/code&gt;声明需要链接&lt;code&gt;/system/lib/libz.so&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;LOCAL_LDFLAGS 链接参数，如果当前模块是是静态库，此参数无效&lt;/li&gt;
&lt;li&gt;LOCAL_ALLOW_UNDEFINED_SYMBOLS 当设置成true时，链接时不检查未定义的引用。如果当前模块是是静态库，此参数无效&lt;/li&gt;
&lt;li&gt;LOCAL_WHOLE_STATIC_LIBRARIES、LOCAL_ARM_MODE、LOCAL_ARM_NEON、LOCAL_DISABLE_NO_EXECUTE、LOCAL_DISABLE_RELRO、LOCAL_DISABLE_FORMAT_STRING_CHECKS、LOCAL_SHORT_COMMANDS、LOCAL_THIN_ARCHIVE、LOCAL_FILTER_ASM等 略，详见文档&lt;/li&gt;
&lt;li&gt;LOCAL_EXPORT_XXX系列指令&lt;/li&gt;
&lt;li&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;预定义函数&quot;&gt;&lt;a href=&quot;#预定义函数&quot; class=&quot;headerlink&quot; title=&quot;预定义函数&quot;&gt;&lt;/a&gt;预定义函数&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;my-dir&lt;/strong&gt; 获取最后一个makefile的目录&lt;/li&gt;
&lt;li&gt;all-subdir-makefiles 返回所有子目录中的Android.mk&lt;/li&gt;
&lt;li&gt;this-makefile 当前makefile的路径&lt;/li&gt;
&lt;li&gt;parent-makefile 上级makefile的路径&lt;/li&gt;
&lt;li&gt;grand-parent-makefile 上上级makefile的路径&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;import-module&lt;/strong&gt; 使用方式&lt;code&gt;$(call import-module,&amp;lt;name&amp;gt;)&lt;/code&gt;,在NDK_MODULE_PATH环境变量中查找指定名称的模块，然后inlucde它的Android.mk文件&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;Application-mk&quot;&gt;&lt;a href=&quot;#Application-mk&quot; class=&quot;headerlink&quot; title=&quot;Application.mk&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/application_mk.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Application.mk&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;示例：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;APP_ABI := x86 #只生成x86架构的CPU用的lib，要生成所有平台的可以改为all    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#APP_STL := stlport_static  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;NDK_TOOLCHAIN_VERSION=4.7 #使用GCC4.7  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;APP_STL := gnustl_static #GNU STL  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;APP_CPPFLAGS := -fexceptions -frtti #允许异常功能，及运行时类型识别  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;APP_CPPFLAGS +=-std=c++11 #允许使用c++11的函数等功能  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;APP_CPPFLAGS +=-fpermissive  #此项有效时表示宽松的编译形式，比如没有用到的代码中有错误也可以通过编译；使用GNU STL时不用此项std::string 居然编译不通过！！&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;变量&quot;&gt;&lt;a href=&quot;#变量&quot; class=&quot;headerlink&quot; title=&quot;变量&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/application_mk.html#var&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;变量&lt;/a&gt;&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;APP_PROJECT_PATH app的根目录，如果当前Application.mk放在&lt;code&gt;$PROJECT/jni/&lt;/code&gt;下，则不需要设置此变量&lt;/li&gt;
&lt;li&gt;APP_MODULES 如果定义了此变量，则只编译指定的模块。模块名使用空格间隔&lt;/li&gt;
&lt;li&gt;APP_OPTIM release 或 debug ,默认值是release，如果在Android项目中定义了android:debuggable,，则默认是debug&lt;/li&gt;
&lt;li&gt;APP_CFLAGS 所有模块通用的c编译参数&lt;/li&gt;
&lt;li&gt;APP_CPPFLAGS 所有模块通用的c++编译参数&lt;/li&gt;
&lt;li&gt;APP_LDFLAGS 所有模块通用的链接参数&lt;/li&gt;
&lt;li&gt;APP_BUILD_SCRIPT ndk墨认在jin/下找文件Android.mk，可以使用这个变量指定编译脚本路径。&lt;/li&gt;
&lt;li&gt;APP_ABI 默认ndk生成的是armeabi，可以使用此变量来指定，例：&lt;code&gt;APP_ABI := armeabi armeabi-v7a x86 mips&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;APP_PLATFORM 指定最小支持android版本，最好不要使用此选项，而是使用模块的build.gradle中的defaultConfig 或 productFlavors 中的minSdkVersion来指定。&lt;/li&gt;
&lt;li&gt;APP_STL 默认使用系统的std库，可以使用这个指定，可选的见&lt;a href=&quot;https://developer.android.com/ndk/guides/cpp-support.html#runtimes&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;官方文档&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;NDK_TOOLCHAIN_VERSION 指定编译工具的版本，如果是&lt;code&gt;clang&lt;/code&gt;就是引用Clang编译器，如果是&lt;code&gt;4.9&lt;/code&gt;这种，就是指定GCC的版本&lt;/li&gt;
&lt;li&gt;APP_SHORT_COMMANDS、APP_PIE、APP_THIN_ARCHIVE 略过，详见文档&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;gradle配置&quot;&gt;&lt;a href=&quot;#gradle配置&quot; class=&quot;headerlink&quot; title=&quot;gradle配置&quot;&gt;&lt;/a&gt;gradle配置&lt;/h2&gt;&lt;p&gt;如果不用android studio集成编译，而是使用ndk-build手动编译，则不需要配置gradle。&lt;/p&gt;
&lt;p&gt;nkd的配置也分散在grale中&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.BaseExtension.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android节点&lt;/a&gt;下面的各个节点中，主要在ndk，&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ExternalNativeNdkBuildOptions.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;defaultConfig.externalNativeBuild.ndkBuild&lt;/a&gt;、&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ExternalNativeBuild.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;externalNativeBuild.ndkBuild&lt;/a&gt;中，同时在sourceSets中对文件包含进行一些修改，flavor和build-types在不同的编译选项下打不同的包。&lt;/p&gt;
&lt;h3 id=&quot;必须节点-android-externalNativeBuild&quot;&gt;&lt;a href=&quot;#必须节点-android-externalNativeBuild&quot; class=&quot;headerlink&quot; title=&quot;必须节点 android.externalNativeBuild&quot;&gt;&lt;/a&gt;必须节点 android.externalNativeBuild&lt;/h3&gt;&lt;p&gt;这里至少要包括cmake和ndkbuild结节之一，来表明ndk的编译系统。&lt;br&gt;然后子结点中，只能设置路径（path参数），只有当Android.mk或CMakeLists.txt不在默认目录上时使用此选项指定目录。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;android &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  defaultConfig &amp;#123;...&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  buildTypes &amp;#123;...&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  // 这里至少要包括cmake和ndkbuild结节之一，来表明ndk的编译系统&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  externalNativeBuild &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     // AndroidStudio2.2以上就添加了Cmake方式来编译NDK代码，但还是可以使用老方法&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     ndkBuild &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           path &amp;quot;src/main/jni/Android.mk&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          //path &amp;quot;prebuilts/tinysubstrate-bin/Android.mk&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    // Encapsulates your CMake build configurations.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cmake &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      // Provides a relative path to your CMake build script.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      path &amp;quot;CMakeLists.txt&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  // If you want Gradle to package prebuilt native libraries&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  // with your APK, modify the default source set configuration&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  // to include the directory of your prebuilt .so files as follows.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  sourceSets &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      main &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          jniLibs.srcDirs &amp;apos;imported-lib/src/&amp;apos;, &amp;apos;more-imported-libs/src/&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;android-defaultConfig-ndk&quot;&gt;&lt;a href=&quot;#android-defaultConfig-ndk&quot; class=&quot;headerlink&quot; title=&quot;android.defaultConfig.ndk&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ProductFlavor.html#com.android.build.gradle.internal.dsl.ProductFlavor:ndk&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.defaultConfig.ndk&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;接口原型&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public interface CoreNdkOptions &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String getModuleName();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String getcFlags();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;String&amp;gt; getLdLibs();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Set&amp;lt;String&amp;gt; getAbiFilters();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String getStl();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Integer getJobs();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;注意这里也有cFlags和AbiFilters，这两项和下面的&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ExternalNativeNdkBuildOptions.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.defaultConfig.externalNativeBuild&lt;/a&gt;重复，原因暂时我还不知道。&lt;/p&gt;
&lt;p&gt;使用示例：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ndk &amp;#123;//在android节点下面&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   // 生成so的名字，是必须的&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   moduleName =&amp;quot;JNITest&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  toolchain = &amp;apos;clang&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  CFlags.add(&amp;apos;-std=c99&amp;apos;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; // 添加依赖库&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; ldLibs.addAll([&amp;apos;android&amp;apos;,&amp;apos;OpenSLES&amp;apos;, &amp;apos;log&amp;apos;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; // 生成不同abi体系的so库&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  abiFilters.addAll([&amp;apos;armeabi&amp;apos;, &amp;apos;armeabi-v7a&amp;apos;, &amp;apos;arm64-v8a&amp;apos;,                                   &amp;apos;x86&amp;apos;, &amp;apos;x86_64&amp;apos;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;apos;mips&amp;apos;, &amp;apos;mips64&amp;apos;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;android-defaultConfig-externalNativeBuild&quot;&gt;&lt;a href=&quot;#android-defaultConfig-externalNativeBuild&quot; class=&quot;headerlink&quot; title=&quot;android.defaultConfig.externalNativeBuild&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ExternalNativeNdkBuildOptions.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;android.defaultConfig.externalNativeBuild&lt;/a&gt;&lt;/h3&gt;&lt;p&gt;构建参数，可以在每个Flavor里特殊定义。&lt;br&gt;见&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ExternalNativeNdkBuildOptions.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;文档&lt;/a&gt;，接口原型为：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public interface CoreExternalNativeNdkBuildOptions &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;String&amp;gt; getArguments();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;String&amp;gt; getcFlags();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    List&amp;lt;String&amp;gt; getCppFlags();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Set&amp;lt;String&amp;gt; getAbiFilters();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Set&amp;lt;String&amp;gt; getTargets();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;在gradle里的使用方法见&lt;a href=&quot;https://developer.android.com/studio/projects/add-native-code.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;这里&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;buildTypes&quot;&gt;&lt;a href=&quot;#buildTypes&quot; class=&quot;headerlink&quot; title=&quot;buildTypes&quot;&gt;&lt;/a&gt;buildTypes&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;buildTypes &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    release &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        minifyEnabled = false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        proguardFiles.add(file(&amp;apos;proguard-rules.pro&amp;apos;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    debug &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        jniDebuggable true //有这个才会支持调试native 代码,这个放到release里一样能用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;引用&quot;&gt;&lt;a href=&quot;#引用&quot; class=&quot;headerlink&quot; title=&quot;引用&quot;&gt;&lt;/a&gt;引用&lt;/h1&gt;&lt;h2 id=&quot;基本概念&quot;&gt;&lt;a href=&quot;#基本概念&quot; class=&quot;headerlink&quot; title=&quot;基本概念&quot;&gt;&lt;/a&gt;基本概念&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/concepts.html&quot;&gt;Android官方文档-概念&lt;/a&gt;，从这里可以发散出JNI、ABI等需要学习的概念，按文档学习即可&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://google.github.io/android-gradle-dsl/current/index.html&quot;&gt;Android Gradle插件节点定义&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;NDK安装配置&quot;&gt;&lt;a href=&quot;#NDK安装配置&quot; class=&quot;headerlink&quot; title=&quot;NDK安装配置&quot;&gt;&lt;/a&gt;NDK安装配置&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://developer.android.com/ndk/guides/index.html&quot;&gt;Android官方指南&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.jianshu.com/p/9aff422204eb&quot;&gt;Android Studio里NDK入门&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/zhaoguangjun33/article/details/51690136&quot;&gt;Android Studio下使用NDK&lt;/a&gt;,这里提供了一些gradle里直接设置toolchain,CFlags等的示例
    
    </summary>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/categories/android/"/>
    
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/tags/java/"/>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/tags/android/"/>
    
      <category term="android studio" scheme="http://baba.zhaoxiuyuan.com/tags/android-studio/"/>
    
  </entry>
  
  <entry>
    <title>java的asm若干实践</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/08/117_java_asm/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/08/117_java_asm/</id>
    <published>2017-08-03T08:50:28.000Z</published>
    <updated>2017-08-04T01:15:37.681Z</updated>
    
    <content type="html">&lt;h1 id=&quot;一、前置知识、工具、代码库等&quot;&gt;&lt;a href=&quot;#一、前置知识、工具、代码库等&quot; class=&quot;headerlink&quot; title=&quot;一、前置知识、工具、代码库等&quot;&gt;&lt;/a&gt;一、前置知识、工具、代码库等&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;jdk里的javap，用来反汇编class文件查看生成的字节码&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://asm.ow2.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;org.objectweb.asm&lt;/a&gt; 用来解析、修改、保存字节码的代码库&lt;/li&gt;
&lt;li&gt;fernflower.jar 用来批量将class文件反编译成java代码（当然idea也可以手动单个反编译)&lt;/li&gt;
&lt;li&gt;java的&lt;a href=&quot;https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Instrumentation&lt;/a&gt;，可以编写代码使用javaagent代理执行其它java文件，在代码里使用上面的asm库动态修改代码。也可以直接将所有字节保存，并加载其它class文件。&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;二、Instrumentation&quot;&gt;&lt;a href=&quot;#二、Instrumentation&quot; class=&quot;headerlink&quot; title=&quot;二、Instrumentation&quot;&gt;&lt;/a&gt;二、Instrumentation&lt;/h1&gt;&lt;p&gt;在代理jar包中MANIFEST.MF使用Premain-Class指定代理类，代理类需要有premain方法，此方法会在被代理的jar包的main执行前执行：&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public static void premain(String var0, Instrumentation inst) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   inst.addTransformer(new MyTransformer());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;JVM在加载每一个类时，都会调用MyTransformer的transform方法对字节码进行处理:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public final byte[] transform(ClassLoader l, String className, Class&amp;lt;?&amp;gt; c,ProtectionDomain pd, byte[] b) throws IllegalClassFormatException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   // 在这里可以根据className筛选到自己想要更改的类&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   if (className.equal(&amp;quot;example&amp;quot;))&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     b = getAnotherCodeArray(b);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     b = modifyCodeArray(b);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   return b;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;在transform函数也可保存修改前或修改后的字节为class文件，只需要直接将b保存成class文件即可。&lt;/li&gt;
&lt;li&gt;如果transform里抛出异常，程序也能正常执行，只不过类没有发生任何变化(因为没有返回修改过的字节码)。&lt;/li&gt;
&lt;li&gt;如果修改过的字节码中，有错误，比如在生成方法的局部变量时，生成了如下格式&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;LocalVariableTable:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Start  Length  Slot  Name   Signature&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    45      65     0  this   Lnet/minecraft/client/network/NetHandlerLoginClient;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    45      65     1 packetIn   Lnet/minecraft/network/login/server/SPacketLoginSuccess;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    0       0     2 address   desc&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中address对应的类型为desc，显然是非法的，则启动程序时会报异常：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;java.lang.NoClassDefFoundError: net/minecraft/client/network/NetHandlerLoginClient&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Caused by: java.lang.ClassFormatError: Field &amp;quot;address&amp;quot; in class net/minecraft/client/network/NetHandlerLoginClient has illegal signature &amp;quot;desc&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;三、asm实践&quot;&gt;&lt;a href=&quot;#三、asm实践&quot; class=&quot;headerlink&quot; title=&quot;三、asm实践&quot;&gt;&lt;/a&gt;三、asm实践&lt;/h1&gt;&lt;p&gt;使用asm修改字节码的示例有很多，这里就不再详细列举，这里仅说几个我填过的坑。在破解forge版本minecraft游戏的过程中，有些asm代码在老版本执行正常，但是在v1.12版本就导致游戏崩溃。&lt;/p&gt;
&lt;p&gt;在transform里将修改过的代码保存成class文件并且通过idea反汇编成java文件，对比1.11和1.12两个版本生成的java代码是一样的，在各种调整jvm参数、java版本、asm库版本之后，最终找到原因和解决办法。&lt;/p&gt;
&lt;h3 id=&quot;错误1：Caused-by-java-lang-VerifyError-Expecting-a-stackmap-frame-at-branch-target-xxx&quot;&gt;&lt;a href=&quot;#错误1：Caused-by-java-lang-VerifyError-Expecting-a-stackmap-frame-at-branch-target-xxx&quot; class=&quot;headerlink&quot; title=&quot;错误1：Caused by: java.lang.VerifyError: Expecting a stackmap frame at branch target xxx&quot;&gt;&lt;/a&gt;错误1：Caused by: java.lang.VerifyError: Expecting a stackmap frame at branch target xxx&lt;/h3&gt;&lt;p&gt;此bug是因为原有代码在插入了一些if(xxx)等分支流程，假设代码是：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;MethodNode method = xxx;// 从原字节码里使用ClassReader得到方法对象。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 插入自己的新的指令&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;InsnList rawMethodInstructions = method.instructions;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;InsnList newCall = new InsnList();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 在某处逻辑添加了跳转指令&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;LabelNode labelNode = new LabelNode();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newCall.add(new JumpInsnNode(Opcodes.IFEQ, labelNode));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;newCall.add(labelNode);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; rawMethodInstructions.insertBefore(rawMethodInstructions.getFirst(), newCall);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; method.maxStack += 4;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上代码在很多mc版本上都正常运行，只有v1.12版本才会报标题中的错误。是因为v1.12的代码在执行时对生成字节码的StackMapTable区域做了检测。在未修改之前的原方法中可能StackMapTable是这样的：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;StackMapTable: number_of_entries = 6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 10 /* same */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 33 /* same */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 64 /* same_locals_1_stack_item */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    stack = [ int ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 252 /* append */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    offset_delta = 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    locals = [ int ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 252 /* append */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    offset_delta = 34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    locals = [ class net/minecraft/entity/Entity ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 250 /* chop */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    offset_delta = 42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上方法修改后，生成的字节码是这样的：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;StackMapTable: number_of_entries = 6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 10 /* same */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 33 /* same */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 64 /* same_locals_1_stack_item */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    stack = [ int ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 252 /* append */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    offset_delta = 20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    locals = [ int ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 252 /* append */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    offset_delta = 34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    locals = [ class net/minecraft/entity/Entity ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 250 /* chop */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    offset_delta = 42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  frame_type = 6 /* same */&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其实这个 frame_type 的顺序应该和代码块的顺序一致（至于StackMapTable对应代码结构的关系可以见（&lt;a href=&quot;http://hllvm.group.iteye.com/group/topic/26545中R大的解释及其它资料）。&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://hllvm.group.iteye.com/group/topic/26545中R大的解释及其它资料）。&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;知道这个特性后，尝试了给java添加了&lt;a href=&quot;http://blog.csdn.net/u012881904/article/details/51337347&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;某博客&lt;/a&gt;提到的 &lt;em&gt;-noverify&lt;/em&gt; 和 &lt;em&gt;-XX:-UseSplitVerifier&lt;/em&gt; 这两个jvm参数来禁用字节码验证，然而不知道为什么并没有卵用。&lt;/p&gt;
&lt;p&gt;最后使用asm在代码合适的位置补上了一个frame解决问题。&lt;/p&gt;
&lt;h3 id=&quot;错误2：java-lang-VerifyError-Bad-local-variable-type&quot;&gt;&lt;a href=&quot;#错误2：java-lang-VerifyError-Bad-local-variable-type&quot; class=&quot;headerlink&quot; title=&quot;错误2：java.lang.VerifyError: Bad local variable type&quot;&gt;&lt;/a&gt;错误2：java.lang.VerifyError: Bad local variable type&lt;/h3&gt;&lt;p&gt;hook代码增加了局部变量，需要手动设置LocalVariableTable，通过 &lt;code&gt;methodnode.visitLocalVariable&lt;/code&gt;来增加变量，注意第三个参数signature如果不是generic types，则不需要设置。例如：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* 必须要调该方法，手动设置LocalVariableTable，否则会报 Caused by: java.lang.VerifyError: Bad local variable type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;*/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;methodnode.visitLocalVariable(&amp;quot;addressObj&amp;quot;, &amp;quot;Ljava/net/SocketAddress;&amp;quot;, null, newLabelBegin.getLabel(), newLabel2.getLabel(), 3);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;methodnode.visitLocalVariable(&amp;quot;addressStr&amp;quot;, &amp;quot;Ljava/lang/String;&amp;quot;, null, newLabelBegin.getLabel(), newLabel2.getLabel(), 4);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;一、前置知识、工具、代码库等&quot;&gt;&lt;a href=&quot;#一、前置知识、工具、代码库等&quot; class=&quot;headerlink&quot; title=&quot;一、前置知识、工具、代码库等&quot;&gt;&lt;/a&gt;一、前置知识、工具、代码库等&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;jdk里的javap，用来反汇编class文件查看生成的字节码&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://asm.ow2.org/&quot;&gt;org.objectweb.asm&lt;/a&gt; 用来解析、修改、保存字节码的代码库&lt;/li&gt;
&lt;li&gt;fernflower.jar 用来批量将class文件反编译成java代码（当然idea也可以手动单个反编译)&lt;/li&gt;
&lt;li&gt;java的&lt;a href=&quot;https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html&quot;&gt;Instrumentation&lt;/a&gt;，可以编写代码使用javaagent代理执行其它java文件，在代码里使用上面的asm库动态修改代码。也可以直接将所有字节保存，并加载其它class文件。&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;二、Instrumentation&quot;&gt;&lt;a href=&quot;#二、Instrumentation&quot; class=&quot;headerlink&quot; title=&quot;二、Instrumentation&quot;&gt;&lt;/a&gt;二、Instrumentation&lt;/h1&gt;&lt;p&gt;在代理jar包中MANIFEST.MF使用Premain-Class指定代理类，代理类需要有premain方法，此方法会在被代理的jar包的main执行前执行：&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/categories/java/minecraft/"/>
    
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/tags/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/tags/minecraft/"/>
    
      <category term="asm" scheme="http://baba.zhaoxiuyuan.com/tags/asm/"/>
    
  </entry>
  
  <entry>
    <title>Spigot编译流程</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/08/118_spigot/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/08/118_spigot/</id>
    <published>2017-08-03T08:50:28.000Z</published>
    <updated>2017-08-04T07:05:55.446Z</updated>
    
    <content type="html">&lt;h1 id=&quot;相关文档&quot;&gt;&lt;a href=&quot;#相关文档&quot; class=&quot;headerlink&quot; title=&quot;相关文档&quot;&gt;&lt;/a&gt;相关文档&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.spigotmc.org/wiki/buildtools/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;buildtools帮助文档&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;BuildTool.jar下载地址&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;使用说明&quot;&gt;&lt;a href=&quot;#使用说明&quot; class=&quot;headerlink&quot; title=&quot;使用说明&quot;&gt;&lt;/a&gt;使用说明&lt;/h1&gt;&lt;p&gt;使用gitbash打开当前目录，输入&lt;code&gt;java -jar BuildTools.jar --rev 1.8&lt;/code&gt;,这里的1.8可以替换成其它版本，如1.10,1.10.2等。&lt;/p&gt;
&lt;h1 id=&quot;流程一，下载代码&quot;&gt;&lt;a href=&quot;#流程一，下载代码&quot; class=&quot;headerlink&quot; title=&quot;流程一，下载代码&quot;&gt;&lt;/a&gt;流程一，下载代码&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;克隆git代码&lt;a href=&quot;https://hub.spigotmc.org/stash/scm/spigot/bukkit.git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;bukkit&lt;/a&gt; 到 &lt;code&gt;bukkit&lt;/code&gt; 目录&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;克隆git代码&lt;a href=&quot;https://hub.spigotmc.org/stash/scm/spigot/craftbukkit.git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;craftbukkit&lt;/a&gt; 到 &lt;code&gt;craftbukkit&lt;/code&gt; 目录&lt;/li&gt;
&lt;li&gt;克隆git代码&lt;a href=&quot;https://hub.spigotmc.org/stash/scm/spigot/spigot.git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;spigot&lt;/a&gt; 到 &lt;code&gt;Spigot&lt;/code&gt; 目录&lt;/li&gt;
&lt;li&gt;克隆git代码&lt;a href=&quot;https://hub.spigotmc.org/stash/scm/spigot/builddata.git&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;buildata&lt;/a&gt;到 &lt;code&gt;BuildData&lt;/code&gt; 目录&lt;/li&gt;
&lt;li&gt;下载&lt;a href=&quot;https://static.spigotmc.org/maven/apache-maven-3.2.5-bin.zip&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;maven工具&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;从服务器上查询命令行中指定的rev对应的各代码库的分支，如&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Attempting to build version: &amp;apos;1.8&amp;apos; use --rev &amp;lt;version&amp;gt; to override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Found version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;quot;name&amp;quot;: &amp;quot;1.8&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;quot;description&amp;quot;: &amp;quot;Backport of fixes from 1.8.3&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;quot;information&amp;quot;: &amp;quot;Last build of Spigot 1.8.0. To update please see http://www.spigotmc.org/&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;quot;warning&amp;quot;: &amp;quot;***** Please ensure your BuildTools is at least #35 *****&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;quot;refs&amp;quot;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;quot;BuildData&amp;quot;: &amp;quot;0630ea462a82fdbd93018de7d5ec5e9d3b3c732b&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;quot;Bukkit&amp;quot;: &amp;quot;1d2509b99fb10b3bd6f597e63805f85b49d5a055&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;quot;CraftBukkit&amp;quot;: &amp;quot;7019900e276b7c9f6e940debf8529094c7f4da0c&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;quot;Spigot&amp;quot;: &amp;quot;550ebace4b43adc73854d7d5976e1343eba6fb98&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;将4个文件夹中的代码更新到指定标签&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;目录说明&quot;&gt;&lt;a href=&quot;#目录说明&quot; class=&quot;headerlink&quot; title=&quot;目录说明&quot;&gt;&lt;/a&gt;目录说明&lt;/h2&gt;&lt;h3 id=&quot;BuildData&quot;&gt;&lt;a href=&quot;#BuildData&quot; class=&quot;headerlink&quot; title=&quot;BuildData&quot;&gt;&lt;/a&gt;BuildData&lt;/h3&gt;&lt;p&gt;反编译工具及反编译minecraft使用的代码映射。&lt;/p&gt;
&lt;h3 id=&quot;CraftBukkit&quot;&gt;&lt;a href=&quot;#CraftBukkit&quot; class=&quot;headerlink&quot; title=&quot;CraftBukkit&quot;&gt;&lt;/a&gt;CraftBukkit&lt;/h3&gt;&lt;p&gt;对minecraft server的魔改，改善性能，并支持插件等。&lt;/p&gt;
&lt;h3 id=&quot;Bukkit&quot;&gt;&lt;a href=&quot;#Bukkit&quot; class=&quot;headerlink&quot; title=&quot;Bukkit&quot;&gt;&lt;/a&gt;Bukkit&lt;/h3&gt;&lt;p&gt;Bukkit是服务器插件编程接口，封装不同版本minecraft server的细节，统一接口，便于开发插件。&lt;/p&gt;
&lt;h3 id=&quot;Spigot目录&quot;&gt;&lt;a href=&quot;#Spigot目录&quot; class=&quot;headerlink&quot; title=&quot;Spigot目录&quot;&gt;&lt;/a&gt;Spigot目录&lt;/h3&gt;&lt;p&gt;spigot服务器是一个改良服务器，在文件夹里是两个补丁目录，CraftBukkit-Patches存放对craftBukkit代码的补丁，Bukkit-Patches存放对Bukkit代码的补丁。&lt;/p&gt;
&lt;h1 id=&quot;流程二，下载minecraft-server并反编译&quot;&gt;&lt;a href=&quot;#流程二，下载minecraft-server并反编译&quot; class=&quot;headerlink&quot; title=&quot;流程二，下载minecraft server并反编译&quot;&gt;&lt;/a&gt;流程二，下载minecraft server并反编译&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;下载纯净版本minecraft服务器jar包（此处应有梯子）。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Attempting to build Minecraft with details: VersionInfo(minecraftVersion=1.8, accessTransforms=bukkit-1.8.at, classMappings=bukkit-1.8-cl.csrg, memberMappings=bukkit-1.8-members.csrg, packageMappings=package.srg, minecraftHash=null, decompileCommand=null, serverUrl=null)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Starting download of https://s3.amazonaws.com/Minecraft.Download/versions/1.8/minecraft_server.1.8.jar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;如果下载不下来，也可以迅雷下载后直接放在work目录中，如果已经存在，则会提示：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Found good Minecraft hash (5b19d1a562a8a7c5f9a787ad96c8148b)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Found good Minecraft hash (5b19d1a562a8a7c5f9a787ad96c8148b)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;反编译代码&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Final mapped jar: work\mapped.8eb82bde.jar does not exist, creating!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Loading mappings&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Loading mappings&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;1 packages, 0 classes, 0 fields, 0 methods&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: merging AccessMap net/minecraft/server/CraftingManager/recipes from AccessChange(clear=16, set=0, vis=1) with AccessChange(clear=0, set=0, vis=1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: merging AccessMap net/minecraft/server/PropertyManager/properties from AccessChange(clear=0, set=0, vis=1) with AccessChange(clear=0, set=0, vis=1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: merging AccessMap net/minecraft/server/TileEntityBrewingStand/items from AccessChange(clear=0, set=0, vis=1) with AccessChange(clear=0, set=0, vis=1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: merging AccessMap net/minecraft/server/WorldServer/tracker from AccessChange(clear=16, set=0, vis=1) with AccessChange(clear=0, set=0, vis=1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO: merging AccessMap net/minecraft/server/WorldManager/world from AccessChange(clear=0, set=0, vis=1) with AccessChange(clear=0, set=0, vis=1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Remapping final jar&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;将minecraft-server的class文件释放到work目录下的&lt;code&gt;decompile-xxxxxxxx&lt;/code&gt;目录的&lt;code&gt;classes&lt;/code&gt;子目录。&lt;/li&gt;
&lt;li&gt;根据map文件，将释放的class文件，反编译到work目录下的&lt;code&gt;decompile-xxxxxxxx&lt;/code&gt;中。&lt;/li&gt;
&lt;li&gt;将生成的java文件，编译并生成minecraft-server-1.8-SNAPSHOT.jar到mvn的代码仓库目录&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Scanning for projects...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO]                                                                         &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] ------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Building Maven Stub Project (No POM) 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] ------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] --- maven-install-plugin:2.4:install-file (default-cli) @ standalone-pom ---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Installing D:\mc\spigotmc_build\work\mapped.8eb82bde.jar to D:\repo\repository\org\spigotmc\minecraft-server\1.8-SNAPSHOT\minecraft-server-1.8-SNAPSHOT.jar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] Installing C:\Users\terry\AppData\Local\Temp\mvninstall1056450265315348368.pom to D:\repo\repository\org\spigotmc\minecraft-server\1.8-SNAPSHOT\minecraft-server-1.8-SNAPSHOT.pom&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] ------------------------------------------------------------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[INFO] BUILD SUCCESS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;extract ....*.class&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Decomiling ***.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Applying CraftBukkit Patches&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;应用代码补丁&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Applying CraftBukkit Patches&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Patching with BiomeDecorator.patch&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Patching with BiomeTheEndDecorator.patch&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;并各种文件夹合并,将Bukkit和CraftBukkit的代码都checkout一份到Spigot目录。&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;流程三，编译代码&quot;&gt;&lt;a href=&quot;#流程三，编译代码&quot; class=&quot;headerlink&quot; title=&quot;流程三，编译代码&quot;&gt;&lt;/a&gt;流程三，编译代码&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;编译Bukkit和CraftBukkit,并且都输出到Maven本地仓库。&lt;/li&gt;
&lt;li&gt;将Bukkit和CraftBukkit的代码check out到Spigot中的Spigot-API和Spigot-Server，然后分别打上补丁(Bukkit-Patches和CraftBukkit-Patches)。&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Rebuilding Forked projects.... &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;From file:///D:\mc\spigotmc_build\Bukkit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * [new branch]      spigot     -&amp;gt; origin/spigot&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HEAD is now at 1d2509b Revert finite checks in locations. Fixes SPIGOT-628 and others&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Cloning into &amp;apos;Spigot-API&amp;apos;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;done.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Resetting Spigot-API to Bukkit...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HEAD is now at 36052f0 CraftBukkit $ Fri Aug 04 14:37:11 CST 2017&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Cloning into &amp;apos;Spigot-Server&amp;apos;...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;done.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Resetting Spigot-Server to CraftBukkit...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;编译输出 craftbukkit-1.8.jar 和 spigot-1.8.jar 等&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Success! Everything compiled successfully. Copying final .jar files now.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Copying craftbukkit-1.8-R0.1-SNAPSHOT-remapped.jar to D:\mc\spigotmc_build\.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - Saved as craftbukkit-1.8.jar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Copying craftbukkit-1.8-R0.1-SNAPSHOT.jar to D:\mc\spigotmc_build\.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - Saved as craftbukkit-1.8.jar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Copying spigot-1.8-R0.1-SNAPSHOT-remapped.jar to D:\mc\spigotmc_build\.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - Saved as spigot-1.8.jar&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Copying spigot-1.8-R0.1-SNAPSHOT.jar to D:\mc\spigotmc_build\.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - Saved as spigot-1.8.jar&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;相关文档&quot;&gt;&lt;a href=&quot;#相关文档&quot; class=&quot;headerlink&quot; title=&quot;相关文档&quot;&gt;&lt;/a&gt;相关文档&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.spigotmc.org/wiki/buildtools/&quot;&gt;buildtools帮助文档&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar&quot;&gt;BuildTool.jar下载地址&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;使用说明&quot;&gt;&lt;a href=&quot;#使用说明&quot; class=&quot;headerlink&quot; title=&quot;使用说明&quot;&gt;&lt;/a&gt;使用说明&lt;/h1&gt;&lt;p&gt;使用gitbash打开当前目录，输入&lt;code&gt;java -jar BuildTools.jar --rev 1.8&lt;/code&gt;,这里的1.8可以替换成其它版本，如1.10,1.10.2等。&lt;/p&gt;
&lt;h1 id=&quot;流程一，下载代码&quot;&gt;&lt;a href=&quot;#流程一，下载代码&quot; class=&quot;headerlink&quot; title=&quot;流程一，下载代码&quot;&gt;&lt;/a&gt;流程一，下载代码&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;克隆git代码&lt;a href=&quot;https://hub.spigotmc.org/stash/scm/spigot/bukkit.git&quot;&gt;bukkit&lt;/a&gt; 到 &lt;code&gt;bukkit&lt;/code&gt; 目录
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/categories/java/minecraft/"/>
    
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/tags/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/tags/minecraft/"/>
    
  </entry>
  
  <entry>
    <title>mc的部分代码研究</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/06/116_mc_code/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/06/116_mc_code/</id>
    <published>2017-06-28T08:50:28.000Z</published>
    <updated>2017-08-04T10:58:15.213Z</updated>
    
    <content type="html">&lt;h1 id=&quot;minecraft-server&quot;&gt;&lt;a href=&quot;#minecraft-server&quot; class=&quot;headerlink&quot; title=&quot;minecraft server&quot;&gt;&lt;/a&gt;minecraft server&lt;/h1&gt;&lt;p&gt;spigot服务器代码中，net.minecraft.server.v1_8_R3.PacketPlayOutPlayerInfo用来序列化玩家配置文件GameProfile给客户端的。&lt;br&gt;某次由于服务器返回的格式不符合要求，导致在使用了某种道具后导致了某个服务器崩溃。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;com-mojiang-authlib&quot;&gt;&lt;a href=&quot;#com-mojiang-authlib&quot; class=&quot;headerlink&quot; title=&quot;com.mojiang.authlib&quot;&gt;&lt;/a&gt;com.mojiang.authlib&lt;/h3&gt;&lt;p&gt;服务器和客户端共用代码，用来实现yggdrasil用户登录验证和用户Profile的获取。&lt;/p&gt;
&lt;p&gt;其中com/mojang/authlib/yggdrasil/YggdrasilMinecraftSessionService.java定义了所有使用到的url和资源域名白名单列表，直接更改此代码再重新打包成jar可改变客户端和服务器端的行为。&lt;/p&gt;
&lt;h2 id=&quot;spigot服务器&quot;&gt;&lt;a href=&quot;#spigot服务器&quot; class=&quot;headerlink&quot; title=&quot;spigot服务器&quot;&gt;&lt;/a&gt;spigot服务器&lt;/h2&gt;&lt;h3 id=&quot;入口&quot;&gt;&lt;a href=&quot;#入口&quot; class=&quot;headerlink&quot; title=&quot;入口&quot;&gt;&lt;/a&gt;入口&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;spigot-1.7.x-1.8.1.jar!\org\bukkit\craftbukkit\Main&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-&amp;gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;net.minecraft.server.v1_7_R4.MinecraftServer.main(options1);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;其中MinecraftServer是纯净版服务器反编译的代码，而org\bukkit\craftbukkit\v1_7_R4\CraftServer是自已在反编译代码上封装的一层服务器接口。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;net-minecraft-server-v1-7-R4-LoginListener&quot;&gt;&lt;a href=&quot;#net-minecraft-server-v1-7-R4-LoginListener&quot; class=&quot;headerlink&quot; title=&quot;net.minecraft.server.v1_7_R4.LoginListener&quot;&gt;&lt;/a&gt;net.minecraft.server.v1_7_R4.LoginListener&lt;/h3&gt;&lt;p&gt;&lt;code&gt;public void a(PacketLoginInEncryptionBegin packetlogininencryptionbegin) {&lt;/code&gt;函数用来处理登录请求，在里开启线程向服务器验证登录(盗版服的情况下，直接在线程里fireLoginEvents声明登录成功)。&lt;/p&gt;
&lt;p&gt;1.7版本的spigot的实现是开启&lt;code&gt;ThreadPlayerLookupUUID&lt;/code&gt;线程类来验证登录。&lt;br&gt;1.8.8版本在此函数中直接开启匿名线程类，但里面的流程还是大致相同的，都是通过调用&lt;code&gt;LoginListener.this.server.aD().hasJoinedServer(...)&lt;/code&gt;来验证登录，这个&lt;code&gt;aD()&lt;/code&gt;返回的即是上面提到的&lt;code&gt;YggdrasilMinecraftSessionService&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;在hasJoinedServer里转调&lt;code&gt;net.minecraft.util.com.mojang.authlib.yggdrasil.YggdrasilAuthenticationService.makeRequest&lt;/code&gt;并指定链接来获取一个&lt;code&gt;HasJoinedMinecraftServerResponse&lt;/code&gt;格式的对象，这个对象的json原形在在mc的登录验证接口文档中有，就不再多说了。拿到Response后，hasJoinedServer使用Response构造出一个GameProfile并且返回，LoginListener将返回的GameProfile保存在成员变量i里。&lt;/p&gt;
&lt;p&gt;这里连接成功了就开始触发连接后处理流程，其中有一个工作流程是骑过LoginListener调用PlayerList然后通过上面提到的PacketPlayOutPlayerInfo构造一个包，并通过net.minecraft.server.v1_7_R4.PlayerConnection.SendPacket()加入到发送队列，最后发送出去。在网络发送时，调用PacketPlayOutPlayerInfo.b将这个packet序列化成二进制。&lt;/p&gt;
&lt;p&gt;但是在Spigot 1.7的，在packetdataserializer.version &amp;gt;= 20 这个分支才完整的输出了皮肤和披风等信息;在另外的分支里，只输出了name。通过&lt;a href=&quot;http://wiki.vg/Protocol_version_numbers中得到20版本号是介于1.7.10(version=5)和1.8版本(version=47)之间的某测试版本的版本号，所以对于老版本mc客户端应该是不会直接返回带Propertys的GameProfile的包。&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://wiki.vg/Protocol_version_numbers中得到20版本号是介于1.7.10(version=5)和1.8版本(version=47)之间的某测试版本的版本号，所以对于老版本mc客户端应该是不会直接返回带Propertys的GameProfile的包。&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;造成这种代码区别的原因是因为，在1.7.10也就是&lt;a href=&quot;http://wiki.vg/index.php?title=Protocol&amp;amp;oldid=6003#Player_List_Item&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;version为5的协议&lt;/a&gt;中用户列表中只有一种消息，只有三个字段Player name、Online、Ping。&lt;/p&gt;
&lt;p&gt;而在在&lt;a href=&quot;http://wiki.vg/index.php?title=Protocol&amp;amp;oldid=7368#Player_List_Item&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;47版本的协议&lt;/a&gt;中区分了更多的类型，里面添加了action并且提供对一组用户的通知。action为0(add player)的消息中附带有GameProfile中的Property的属性。&lt;/p&gt;
&lt;p&gt;在1.7.10之前版本应该是只能通过&lt;a href=&quot;http://wiki.vg/Mojang_API#UUID_-.3E_Profile_.2B_Skin.2FCape&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Mojang API#UUID -&amp;gt; Profile + Skin/Cape&lt;/a&gt;来请求皮肤和披风。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt; public void PacketPlayOutPlayerInfo.b(PacketDataSerializer packetdataserializer) throws IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if(packetdataserializer.version &amp;gt;= 20) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         case 0:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                packetdataserializer.a(this.player.getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                PropertyMap properties = this.player.getProperties();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                packetdataserializer.b(properties.size());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Iterator i$ = properties.values().iterator();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                while(i$.hasNext()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    Property property = (Property)i$.next();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    packetdataserializer.a(property.getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    packetdataserializer.a(property.getValue());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    packetdataserializer.writeBoolean(property.hasSignature());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    if(property.hasSignature()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        packetdataserializer.a(property.getSignature());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; else &amp;#123;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        packetdataserializer.a(this.username);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        packetdataserializer.writeBoolean(this.action != 4);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        packetdataserializer.writeShort(this.ping);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;BungeeCord&quot;&gt;&lt;a href=&quot;#BungeeCord&quot; class=&quot;headerlink&quot; title=&quot;BungeeCord&quot;&gt;&lt;/a&gt;BungeeCord&lt;/h1&gt;&lt;h2 id=&quot;支持的客户端版本列表&quot;&gt;&lt;a href=&quot;#支持的客户端版本列表&quot; class=&quot;headerlink&quot; title=&quot;支持的客户端版本列表&quot;&gt;&lt;/a&gt;支持的客户端版本列表&lt;/h2&gt;&lt;p&gt;在&lt;code&gt;net.md_5.bungee.protocol.ProtocolConstants.java&lt;/code&gt;里定义了SUPPORTED_VERSION_IDS，如：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public static final List&amp;lt;String&amp;gt; SUPPORTED_VERSIONS = Arrays.asList(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;quot;1.8.x&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;quot;1.9.x&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;quot;1.10.x&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;quot;1.11.x&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;public static final List&amp;lt;Integer&amp;gt; SUPPORTED_VERSION_IDS = Arrays.asList( ProtocolConstants.MINECRAFT_1_8,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProtocolConstants.MINECRAFT_1_9,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProtocolConstants.MINECRAFT_1_9_1,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProtocolConstants.MINECRAFT_1_9_2,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProtocolConstants.MINECRAFT_1_9_4,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProtocolConstants.MINECRAFT_1_10,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProtocolConstants.MINECRAFT_1_11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;正版登录验证&quot;&gt;&lt;a href=&quot;#正版登录验证&quot; class=&quot;headerlink&quot; title=&quot;正版登录验证&quot;&gt;&lt;/a&gt;正版登录验证&lt;/h2&gt;&lt;p&gt;在&lt;code&gt;net.md_5.bungee.connection.InitialHandler&lt;/code&gt;的&lt;code&gt;public void handle(EncryptionResponse encryptResponse)&lt;/code&gt;方法中，调用&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;精简版本代码：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HttpClient.get(&amp;quot;https://sessionserver.mojang.com/session/minecraft/hasJoined?username=&amp;quot; + xxx,new Callback()&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  if (success)&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;  else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      InitialHandler.this.disconnect(&amp;quot;给客户端的提示错误信息&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h1 id=&quot;客户端&quot;&gt;&lt;a href=&quot;#客户端&quot; class=&quot;headerlink&quot; title=&quot;客户端&quot;&gt;&lt;/a&gt;客户端&lt;/h1&gt;&lt;h2 id=&quot;authlib&quot;&gt;&lt;a href=&quot;#authlib&quot; class=&quot;headerlink&quot; title=&quot;authlib&quot;&gt;&lt;/a&gt;authlib&lt;/h2&gt;&lt;p&gt;同上面服务器，只不过客户端的authlib是在.minecraft中的&lt;code&gt;.minecraft\libraries\com\mojang\authlib&lt;/code&gt;目录中，替换和原客户端相同的版本即可。&lt;/p&gt;
&lt;h3 id=&quot;皮肤和披风获取&quot;&gt;&lt;a href=&quot;#皮肤和披风获取&quot; class=&quot;headerlink&quot; title=&quot;皮肤和披风获取&quot;&gt;&lt;/a&gt;皮肤和披风获取&lt;/h3&gt;&lt;p&gt;服务器访问&lt;a href=&quot;http://wiki.vg/Protocol_Encryption#Server&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MojangAPi&lt;/a&gt;验证客户端登录后就有了皮肤和披风数据，然后加入缓存。&lt;/p&gt;
&lt;p&gt;1.8版本在登录成功后，服务器就会返回给客户端的Player_List_Item消息中就加入皮肤和披风数据，所以客户端可以直接展示自己及别人的皮肤。&lt;/p&gt;
&lt;p&gt;1.7以前版本的客户端，1.7版本通过Spawn Player通知某个玩家周围可见用户的皮肤数据。但自己的皮肤需要单独在YggdrasilMinecraftSessionService类的protected GameProfile fillGameProfile(GameProfile gameprofile, boolean flag) 方法中访问&lt;a href=&quot;http://wiki.vg/Mojang_API#UUID_-.3E_Profile_.2B_Skin.2FCape&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MojangApi&lt;/a&gt;来获取自己的皮肤数据，返回的结果跟服务器访问&lt;a href=&quot;http://wiki.vg/Protocol_Encryption#Server&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;MojangAPi&lt;/a&gt;得到的结果差不多。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;timestamp&amp;quot;: 1501839740,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;profileId&amp;quot;: &amp;quot;08d699bb6400355e981b678c9441fa75&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;profileName&amp;quot;: &amp;quot;k1988&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;signatureRequired&amp;quot;: false,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;textures&amp;quot;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;quot;CAPE&amp;quot;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;quot;url&amp;quot;: &amp;quot;http://icon.mc.kuai8.com/cape/douyu.png&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;quot;SKIN&amp;quot;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;quot;url&amp;quot;: &amp;quot;http://icon.mc.kuai8.com/imshop/201708/20170803110431142.png&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;白名单&quot;&gt;&lt;a href=&quot;#白名单&quot; class=&quot;headerlink&quot; title=&quot;白名单&quot;&gt;&lt;/a&gt;白名单&lt;/h3&gt;&lt;p&gt;为了安全起见，皮肤和披风的链接都需要在YggdrasilMinecraftSessionService.isWhitelistedDomain中判断是否预定义的几个白名单网址。&lt;/p&gt;
&lt;h2 id=&quot;forge版本&quot;&gt;&lt;a href=&quot;#forge版本&quot; class=&quot;headerlink&quot; title=&quot;forge版本&quot;&gt;&lt;/a&gt;forge版本&lt;/h2&gt;&lt;h3 id=&quot;无敌模式&quot;&gt;&lt;a href=&quot;#无敌模式&quot; class=&quot;headerlink&quot; title=&quot;无敌模式&quot;&gt;&lt;/a&gt;无敌模式&lt;/h3&gt;&lt;p&gt;在编译spigot时反编译了net.minecraft.server.Entity的代码中，有一个函数&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public boolean damageEntity(DamageSource damagesource, float f) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if (this.isInvulnerable(damagesource)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        this.ac();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在forge版本的&lt;code&gt;net.minecraft.entity.player.EntityPlayerMp&lt;/code&gt;的代码中，同样有一段类似但更复杂的函数,如果hook掉此函数的功能直接return false，即可实现无敌模式。&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;public boolean func_70097_a(DamageSource source, float amount) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if(this.func_180431_b(source)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        boolean flag = this.field_71133_b.func_71262_S() &amp;amp;&amp;amp; this.func_175400_cq() &amp;amp;&amp;amp; &amp;quot;fall&amp;quot;.equals(source.field_76373_n);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        if(!flag &amp;amp;&amp;amp; this.field_147101_bU &amp;gt; 0 &amp;amp;&amp;amp; source != DamageSource.field_76380_i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            if(source instanceof EntityDamageSource) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                Entity entity = source.func_76346_g();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                if(entity instanceof EntityPlayer &amp;amp;&amp;amp; !this.func_96122_a((EntityPlayer)entity)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                if(entity instanceof EntityArrow) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    EntityArrow entityarrow = (EntityArrow)entity;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    if(entityarrow.field_70250_c instanceof EntityPlayer &amp;amp;&amp;amp; !this.func_96122_a((EntityPlayer)entityarrow.field_70250_c)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            return super.func_70097_a(source, amount);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;皮肤性别选择&quot;&gt;&lt;a href=&quot;#皮肤性别选择&quot; class=&quot;headerlink&quot; title=&quot;皮肤性别选择&quot;&gt;&lt;/a&gt;皮肤性别选择&lt;/h3&gt;&lt;p&gt;游戏中默认皮肤是Steve还是Alex的选择方式。&lt;/p&gt;
&lt;p&gt;ref：&lt;a href=&quot;http://wiki.vg/Mojang_API#UUID_-.3E_Profile_.2B_Skin.2FCape&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://wiki.vg/Mojang_API#UUID_-.3E_Profile_.2B_Skin.2FCape&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * uuid的hashCode如果是奇数就是Alex，为偶数就是Steve&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;private static void printType(String uuid) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    UUID uid = UUID.fromString(uuid);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if ((uid.hashCode() &amp;amp; 1) != 0) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      System.out.println(uid.toString() + &amp;quot; = Alex&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      System.out.println(uid.toString() + &amp;quot; = Steve&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;minecraft-server&quot;&gt;&lt;a href=&quot;#minecraft-server&quot; class=&quot;headerlink&quot; title=&quot;minecraft server&quot;&gt;&lt;/a&gt;minecraft server&lt;/h1&gt;&lt;p&gt;spigot服务器代码中，net.minecraft.server.v1_8_R3.PacketPlayOutPlayerInfo用来序列化玩家配置文件GameProfile给客户端的。&lt;br&gt;某次由于服务器返回的格式不符合要求，导致在使用了某种道具后导致了某个服务器崩溃。&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/categories/java/minecraft/"/>
    
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/tags/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/tags/minecraft/"/>
    
  </entry>
  
  <entry>
    <title>Android RandomAccessFile模式</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/05/115_android_randomaccessfile/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/05/115_android_randomaccessfile/</id>
    <published>2017-05-03T08:50:28.000Z</published>
    <updated>2017-05-03T08:50:41.383Z</updated>
    
    <content type="html">&lt;p&gt;在项目中发现同一个文件（约500M），在浏览器和别的下载工具上使用http协议下载速度能达5M+KB/s，而我们的app中只能到6、700+KB/s。一开始以为是没有使用多线程下载，或者某逻辑代码是耗时操作，经过多次对比实验和调试，发现将下载时写文件用的&lt;code&gt;RandomAccessFile&lt;/code&gt;的构造函数中的参数&lt;code&gt;mode&lt;/code&gt;由&lt;code&gt;rwd&lt;/code&gt;改为&lt;code&gt;rw&lt;/code&gt;即可。&lt;/p&gt;
&lt;h3 id=&quot;RandomAccessFile的mode官方文档：&quot;&gt;&lt;a href=&quot;#RandomAccessFile的mode官方文档：&quot; class=&quot;headerlink&quot; title=&quot;RandomAccessFile的mode官方文档：&quot;&gt;&lt;/a&gt;&lt;code&gt;RandomAccessFile&lt;/code&gt;的&lt;code&gt;mode&lt;/code&gt;官方文档：&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;th style=&quot;text-align:center&quot;&gt;Meaning&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;“r”&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;for reading only. Invoking any of the write methods of the resulting object will cause an IOException.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;“rw”&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;Open for reading and writing. If the file does not already exist then an attempt will be made to create it.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;“rws”&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;Open for reading and writing, as with “rw”, and also require that every update to the file’s content or metadata be written synchronously to the underlying storage device.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;“rwd”&lt;/td&gt;
&lt;td style=&quot;text-align:center&quot;&gt;Open for reading and writing, as with “rw”, and also require that every update to the file’s content be written synchronously to the underlying storage device.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;参考：&quot;&gt;&lt;a href=&quot;#参考：&quot; class=&quot;headerlink&quot; title=&quot;参考：&quot;&gt;&lt;/a&gt;参考：&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.itpub.net/7437037/viewspace-977394/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.itpub.net/7437037/viewspace-977394/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/attilax/article/details/50881526&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/attilax/article/details/50881526&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在项目中发现同一个文件（约500M），在浏览器和别的下载工具上使用http协议下载速度能达5M+KB/s，而我们的app中只能到6、700+KB/s。一开始以为是没有使用多线程下载，或者某逻辑代码是耗时操作，经过多次对比实验和调试，发现将下载时写文件用的&lt;code&gt;Rand
    
    </summary>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/categories/android/"/>
    
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/tags/java/"/>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/tags/android/"/>
    
  </entry>
  
  <entry>
    <title>Android Studio：打包时出现xxx is not translated in xx</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/04/114_android_studio_translate/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/04/114_android_studio_translate/</id>
    <published>2017-04-20T03:20:28.000Z</published>
    <updated>2017-04-20T03:31:01.308Z</updated>
    
    <content type="html">&lt;p&gt;在某项目里用到了友盟的SDK，在打正式包时，友盟sdk里的很多资源文件编译出错，报错信息如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Error:(23) Error: &amp;quot;com_facebook_like_button_not_liked&amp;quot; is not translated in &amp;quot;ar&amp;quot; (Arabic), &amp;quot;cs&amp;quot; (Czech), &amp;quot;de&amp;quot; (German), &amp;quot;es&amp;quot; (Spanish), &amp;quot;fi&amp;quot; (Finnish), &amp;quot;fr&amp;quot; (French), &amp;quot;he&amp;quot; (Hebrew), &amp;quot;it&amp;quot; (Italian), &amp;quot;iw&amp;quot; (Hebrew), &amp;quot;ja&amp;quot; (Japanese), &amp;quot;ko&amp;quot; (Korean), &amp;quot;nl&amp;quot; (Dutch), &amp;quot;pl&amp;quot; (Polish), &amp;quot;pt&amp;quot; (Portuguese), &amp;quot;pt-BR&amp;quot; (Portuguese: Brazil), &amp;quot;ro&amp;quot; (Romanian), &amp;quot;ru&amp;quot; (Russian), &amp;quot;zh&amp;quot; (Chinese) [MissingTranslation]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但其实最后apk也打出来了，虽然不知道为什么报错了还是能输出apk，但是还要想解决这个问题，经过搜索，找到以下解决方案。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;解决方案一：&quot;&gt;&lt;a href=&quot;#解决方案一：&quot; class=&quot;headerlink&quot; title=&quot;解决方案一：&quot;&gt;&lt;/a&gt;解决方案一：&lt;/h2&gt;&lt;p&gt;在字符串资源文件里将&lt;code&gt;string&lt;/code&gt;结点添加一个属性&lt;code&gt;translatable=&amp;quot;false&amp;quot;&lt;/code&gt;，这种方法只适合数量较少的情况下。&lt;/p&gt;
&lt;h2 id=&quot;解决方案二：&quot;&gt;&lt;a href=&quot;#解决方案二：&quot; class=&quot;headerlink&quot; title=&quot;解决方案二：&quot;&gt;&lt;/a&gt;解决方案二：&lt;/h2&gt;&lt;p&gt;是用tools:ignore=”MissingTranslation“ 属性直接忽略这个问题。在字符资源文件里根结点&lt;code&gt;resource&lt;/code&gt;中下添加这么两个属性，就可以了&lt;br&gt;xmlns:tools=”&lt;a href=&quot;http://schemas.android.com/tools&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://schemas.android.com/tools&lt;/a&gt;“&lt;br&gt;tools:ignore=”MissingTranslation”。例：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;utf-8&amp;quot;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;resources&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  xmlns:tools=&amp;quot;http://schemas.android.com/tools&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  tools:ignore=&amp;quot;MissingTranslation&amp;quot; &amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;string name=&amp;quot;whatsapp_showword&amp;quot;&amp;gt;WhatsApp&amp;lt;/string&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/resources&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;解决方案三：&quot;&gt;&lt;a href=&quot;#解决方案三：&quot; class=&quot;headerlink&quot; title=&quot;解决方案三：&quot;&gt;&lt;/a&gt;解决方案三：&lt;/h2&gt;&lt;p&gt;在项目的builde.gralde里添加如下代码&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;android &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  lintOptions &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      checkReleaseBuilds false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      // Or, if you prefer, you can continue to check for errors in release builds,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      // but continue the build even when errors are found:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      abortOnError false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h3 id=&quot;参考资料&quot;&gt;&lt;a href=&quot;#参考资料&quot; class=&quot;headerlink&quot; title=&quot;参考资料&quot;&gt;&lt;/a&gt;参考资料&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.163.com/shexinyang@126/blog/static/136739312201492144928812/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.163.com/shexinyang@126/blog/static/136739312201492144928812/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.cnblogs.com/qinxianyuzou/p/3941661.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.cnblogs.com/qinxianyuzou/p/3941661.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://segmentfault.com/a/1190000000599530&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://segmentfault.com/a/1190000000599530&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在某项目里用到了友盟的SDK，在打正式包时，友盟sdk里的很多资源文件编译出错，报错信息如下：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Error:(23) Error: &amp;quot;com_facebook_like_button_not_liked&amp;quot; is not translated in &amp;quot;ar&amp;quot; (Arabic), &amp;quot;cs&amp;quot; (Czech), &amp;quot;de&amp;quot; (German), &amp;quot;es&amp;quot; (Spanish), &amp;quot;fi&amp;quot; (Finnish), &amp;quot;fr&amp;quot; (French), &amp;quot;he&amp;quot; (Hebrew), &amp;quot;it&amp;quot; (Italian), &amp;quot;iw&amp;quot; (Hebrew), &amp;quot;ja&amp;quot; (Japanese), &amp;quot;ko&amp;quot; (Korean), &amp;quot;nl&amp;quot; (Dutch), &amp;quot;pl&amp;quot; (Polish), &amp;quot;pt&amp;quot; (Portuguese), &amp;quot;pt-BR&amp;quot; (Portuguese: Brazil), &amp;quot;ro&amp;quot; (Romanian), &amp;quot;ru&amp;quot; (Russian), &amp;quot;zh&amp;quot; (Chinese) [MissingTranslation]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但其实最后apk也打出来了，虽然不知道为什么报错了还是能输出apk，但是还要想解决这个问题，经过搜索，找到以下解决方案。&lt;br&gt;
    
    </summary>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/categories/android/"/>
    
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/tags/android/"/>
    
      <category term="android studio" scheme="http://baba.zhaoxiuyuan.com/tags/android-studio/"/>
    
  </entry>
  
  <entry>
    <title>bat实例：用windows批处理将文件分组</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/03/113_bat_split/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/03/113_bat_split/</id>
    <published>2017-03-21T09:53:28.000Z</published>
    <updated>2017-03-21T09:53:22.735Z</updated>
    
    <content type="html">&lt;p&gt;上一次，使用bat来将txt文件给合并起来，而这次又有个小需求要将某目录下的大数量的指定类型文件（比如1w张图片，或者2w个xml）拆分到多个文件夹中。&lt;/p&gt;
&lt;p&gt;第一期先实现了个简单的按数量拆分的批处理文件，后面根据需求可以再过滤文件修改时间，文件名等（不过如果需求真的到了那么复杂，可能会换用python来写）。&lt;/p&gt;
&lt;p&gt;代码如下&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;@echo off &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set usage=Usage：split_folder 源文件夹(可加通配符) 目标文件夹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 待拆分的源文件夹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set src=%1%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 拆分的目标文件夹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set dest=%2%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 检查参数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;if &amp;#123;%src%&amp;#125; == &amp;#123;&amp;#125; echo &amp;quot;%usage%&amp;quot; &amp;amp;&amp;amp; goto end&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;if &amp;#123;%dest%&amp;#125; == &amp;#123;&amp;#125; echo &amp;quot;%usage%&amp;quot; &amp;amp;&amp;amp; goto end&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 每一页条数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set page_count=2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 起始页码&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set cur_page=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 起始页内索引&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set index=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SETLOCAL ENABLEDELAYEDEXPANSION &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 循环处理列举出来的文件，如有特殊需求，可改下面的copy语句&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;for /f &amp;quot;delims=&amp;quot; %%i in (&amp;apos;dir /b /s /a-d %src%&amp;apos;) do (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set /a index = !index! + 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    set /a cur_page = !index! / %page_count%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if not exist %dest%\!cur_page! mkdir %dest%\!cur_page!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    copy &amp;quot;%%i&amp;quot; &amp;quot;%dest%\!cur_page!\%%~nxi&amp;quot; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;:end&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pause&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;上一次，使用bat来将txt文件给合并起来，而这次又有个小需求要将某目录下的大数量的指定类型文件（比如1w张图片，或者2w个xml）拆分到多个文件夹中。&lt;/p&gt;
&lt;p&gt;第一期先实现了个简单的按数量拆分的批处理文件，后面根据需求可以再过滤文件修改时间，文件名等（不过如果需求真的到了那么复杂，可能会换用python来写）。&lt;/p&gt;
&lt;p&gt;代码如下&lt;br&gt;
    
    </summary>
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/categories/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/tags/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
      <category term="bat" scheme="http://baba.zhaoxiuyuan.com/tags/bat/"/>
    
  </entry>
  
  <entry>
    <title>bat实例：用windows批处理合并txt文件</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/03/112_bat_merge/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/03/112_bat_merge/</id>
    <published>2017-03-07T02:23:28.000Z</published>
    <updated>2017-03-07T02:37:08.015Z</updated>
    
    <content type="html">&lt;p&gt;我有一堆小txt文本，想放在手机上阅读，但是在阅读器中切换文件比较烦，就写了个批处理把他们合并在一起成一个txt文件。&lt;/p&gt;
&lt;p&gt;示例中：将小文件全部放在&lt;code&gt;D:\mini&lt;/code&gt;文件夹中，然后将所有txt合并到&lt;code&gt;D:\mini_10k.txt&lt;/code&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;@echo off&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set dest=D:\mini_10k.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set src=D:\mini&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;echo &amp;gt;%dest%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;for /r &amp;quot;%src%&amp;quot; %%i in (*.txt) do (&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 添加分割线&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;echo --------------------------------------- &amp;gt;&amp;gt; %dest%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 输出文件路径&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;echo %%i &amp;gt;&amp;gt; %dest%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 输出文件内容&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;type &amp;quot;%%i&amp;quot; &amp;gt;&amp;gt; %dest%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;我有一堆小txt文本，想放在手机上阅读，但是在阅读器中切换文件比较烦，就写了个批处理把他们合并在一起成一个txt文件。&lt;/p&gt;
&lt;p&gt;示例中：将小文件全部放在&lt;code&gt;D:\mini&lt;/code&gt;文件夹中，然后将所有txt合并到&lt;code&gt;D:\mini_10k.txt&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/categories/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/tags/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
      <category term="bat" scheme="http://baba.zhaoxiuyuan.com/tags/bat/"/>
    
  </entry>
  
  <entry>
    <title>svn使用技巧：使用命令行添加忽略文件和目录</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/03/111_svn_ignore/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/03/111_svn_ignore/</id>
    <published>2017-03-03T03:40:28.000Z</published>
    <updated>2017-03-07T02:40:12.360Z</updated>
    
    <content type="html">&lt;p&gt;之前一直在团队中推荐自己在&lt;code&gt;TortoiseSVN&lt;/code&gt;的&lt;code&gt;Setting-&amp;gt;General-&amp;gt;Global ignore pattern&lt;/code&gt;中定义排除规则。比如，我一直用的是&lt;code&gt;*.o *.lo *.la *.al .libs *.so *.so.[0-9]* *.a *.pyc *.pyo __pycache__ *.rej *~ #*# .#* .*.swp .DS_Store [Tt]humbs.db&lt;/code&gt;。但有些人就不喜欢用，而且随着项目类型的转换，比如新的android团队需要定义不同的规则，这时就得重新在群里发新的规则比较麻烦。&lt;/p&gt;
&lt;p&gt;想到git项目中有.gitignore文件，就想svn中是否有一样的文件，寻找了一圈发现应该是没有类型的文件可以用，仅仅是在项目的svn Propertys设置对话框中在Edit时可以Load一个文件，这个文件的规则和.gitignore类似。&lt;/p&gt;
&lt;p&gt;顺便看到更改项目的svn:global-ignores和svn:ignore的命令行，就直接写了个批处理，外加三个规则文件&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;，在批处理里分别导入三个规则文件到svn属性里，然后在工程根目录执行后提交svn即可，然后同事们再add时就不容易带入垃圾文件了。&lt;/p&gt;
&lt;p&gt;批处理如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;@echo off&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 此批处理的用途&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 参考链接：http://stackoverflow.com/questions/17298668/svn-ignore-like-gitignore&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 参考命令行&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem svn propset svn:ignore -RF /root/svn-ignore.txt . [dot for current dir]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem 各语言通用&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;set txt_path=%~dp0%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;svn propset svn:global-ignores -F &amp;quot;%txt_path%svn_ignored_common.txt&amp;quot; %cd%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem java开发&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;svn propset svn:global-ignores -F &amp;quot;%txt_path%\svn_ignored_java.txt&amp;quot; %cd%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rem android studio&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;svn propset svn:ignore -F &amp;quot;%txt_path%\svn_ignored_android_studio.txt&amp;quot; %cd%&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pause&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;具体的几个规则文件由于可能会经常变更，并且不同项目有不同的需求，在这里就只放个链接了，&lt;a href=&quot;https://github.com/k1988/win_mini_tool/tree/master/bats&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/k1988/win_mini_tool/tree/master/bats&lt;/a&gt;。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;之前一直在团队中推荐自己在&lt;code&gt;TortoiseSVN&lt;/code&gt;的&lt;code&gt;Setting-&amp;gt;General-&amp;gt;Global ignore pattern&lt;/code&gt;中定义排除规则。比如，我一直用的是&lt;code&gt;*.o *.lo *.la *.al .libs *.so *.so.[0-9]* *.a *.pyc *.pyo __pycache__ *.rej *~ #*# .#* .*.swp .DS_Store [Tt]humbs.db&lt;/code&gt;。但有些人就不喜欢用，而且随着项目类型的转换，比如新的android团队需要定义不同的规则，这时就得重新在群里发新的规则比较麻烦。&lt;/p&gt;
&lt;p&gt;想到git项目中有.gitignore文件，就想svn中是否有一样的文件，寻找了一圈发现应该是没有类型的文件可以用，仅仅是在项目的svn Propertys设置对话框中在Edit时可以Load一个文件，这个文件的规则和.gitignore类似。&lt;/p&gt;
&lt;p&gt;顺便看到更改项目的svn:global-ignores和svn:ignore的命令行，就直接写了个批处理，外加三个规则文件
    
    </summary>
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/categories/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/tags/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
      <category term="svn" scheme="http://baba.zhaoxiuyuan.com/tags/svn/"/>
    
  </entry>
  
  <entry>
    <title>Android Studio 使用技巧：修改默认build.gradle</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/02/110_as_templates/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/02/110_as_templates/</id>
    <published>2017-02-14T12:00:28.000Z</published>
    <updated>2017-03-07T02:40:07.544Z</updated>
    
    <content type="html">&lt;p&gt;在项目中发现一些好用的插件和库，就想默认在每个工程里使用，就想到了找找如何直接修改默认工程的build.gradle文件，经过多方面查找资料，可以使用下面的方法来改。&lt;/p&gt;
&lt;p&gt;比如说有一个好用的butterKnife这个库，需要添加buildscript的dependencies和compile的dependencies。&lt;/p&gt;
&lt;p&gt;我们先找到&lt;code&gt;Android Studio\plugins\android\lib\templates\gradle-projects&lt;/code&gt;，然后看名称就知道&lt;code&gt;NewAndroidProject&lt;/code&gt;目录下的就是创建android工程时默认使用的模板。&lt;/p&gt;
&lt;p&gt;然后我们打开&lt;code&gt;root&lt;/code&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;中的&lt;code&gt;build.gradle.ftl&lt;/code&gt;，看起来和一个默认项目里的结构一模一样，我们首先把&lt;code&gt;classpath &amp;#39;com.jakewharton:butterknife-gradle-plugin:8.5.1&amp;#39;&lt;/code&gt;添加在&lt;code&gt;buildscript.dependencies&lt;/code&gt;的最后面。同时，添加一个版本号字义(这一步也可以省略，如果省略，后面在app的gradle里就直接指定版本的&lt;code&gt;butterknife&lt;/code&gt;)以供在app的gradle里使用版本号变量来指定&lt;code&gt;butterknife&lt;/code&gt;，如下文中的&lt;code&gt;ext&lt;/code&gt;结点。&lt;/p&gt;
&lt;p&gt;如：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;buildscript &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    repositories &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        jcenter()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;#if mavenUrl != &amp;quot;mavenCentral&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        maven &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            url &amp;apos;$&amp;#123;mavenUrl&amp;#125;&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/#if&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    dependencies &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        classpath &amp;apos;com.android.tools.build:gradle:$&amp;#123;gradlePluginVersion&amp;#125;&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        // NOTE: Do not place your application dependencies here; they belong&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        // in the individual module build.gradle files&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        classpath &amp;apos;com.jakewharton:butterknife-gradle-plugin:8.5.1&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// Define versions in a single place&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ext &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  // App dependencies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  butterKnifeVersion = &amp;apos;8.5.1&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是我们在NewAndroidProject目录里并没有找到新建工程后的app目录里的那个build.gradle对应的模板，看名称找到了&lt;code&gt;NewAndroidModule&lt;/code&gt;目录，同样的步骤打开&lt;code&gt;root\build.gradle.ftl&lt;/code&gt;然后在&lt;code&gt;dependencies&lt;/code&gt;节点添加两行，结果见：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    compile fileTree(dir: &amp;apos;libs&amp;apos;, include: [&amp;apos;*.jar&amp;apos;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    androidTestCompile(&amp;apos;com.android.support.test.espresso:espresso-core:$&amp;#123;espressoVersion!&amp;quot;2.0&amp;quot;&amp;#125;&amp;apos;, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        exclude group: &amp;apos;com.android.support&amp;apos;, module: &amp;apos;support-annotations&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;#if WearprojectName?has_content &amp;amp;&amp;amp; NumberOfEnabledFormFactors?has_content &amp;amp;&amp;amp; NumberOfEnabledFormFactors gt 1 &amp;amp;&amp;amp; Wearincluded&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    wearApp project(&amp;apos;:$&amp;#123;WearprojectName&amp;#125;&amp;apos;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    compile &amp;apos;com.google.android.gms:play-services:+&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/#if&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    // code generator for view(这3行是新增的)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    compile &amp;quot;com.jakewharton:butterknife:$rootProject.butterKnifeVersion&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    annotationProcessor &amp;quot;com.jakewharton:butterknife-compiler:$rootProject.butterKnifeVersion&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后保存文件，打开Android Stuido 新建工程。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在项目中发现一些好用的插件和库，就想默认在每个工程里使用，就想到了找找如何直接修改默认工程的build.gradle文件，经过多方面查找资料，可以使用下面的方法来改。&lt;/p&gt;
&lt;p&gt;比如说有一个好用的butterKnife这个库，需要添加buildscript的dependencies和compile的dependencies。&lt;/p&gt;
&lt;p&gt;我们先找到&lt;code&gt;Android Studio\plugins\android\lib\templates\gradle-projects&lt;/code&gt;，然后看名称就知道&lt;code&gt;NewAndroidProject&lt;/code&gt;目录下的就是创建android工程时默认使用的模板。&lt;/p&gt;
&lt;p&gt;然后我们打开&lt;code&gt;root&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/categories/android/"/>
    
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/tags/android/"/>
    
      <category term="gradle" scheme="http://baba.zhaoxiuyuan.com/tags/gradle/"/>
    
      <category term="Android Studio" scheme="http://baba.zhaoxiuyuan.com/tags/Android-Studio/"/>
    
  </entry>
  
  <entry>
    <title>NSIS 3.0 System Call 失败问题</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/02/109_NSIS3_system_call/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/02/109_NSIS3_system_call/</id>
    <published>2017-02-03T12:00:28.000Z</published>
    <updated>2017-03-07T02:39:48.415Z</updated>
    
    <content type="html">&lt;p&gt;以前一直用的是NSIS 2.x，但这些版本的NSIS打出来的安装包没有加声明系统兼容性的manifest，也不好用软件在打好的安装包上加manifest，所以就换用了最新版本的NSIS 3.0。&lt;/p&gt;
&lt;p&gt;换用3.0后之前正常的一些System::Call “xxx:xxx”函数失效了。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;先怀疑NSIS 3.0的System插件有问题，换成2.x的System插件，也还是解决不了问题。并且未能找到System.dll的源码。并且IDA反编译之，也未发现两者有什么关于加载库的区别。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;又怀疑是不是System语法问题，之前使用时直接没有加各种参数原型说明，也没有像文档一样使用参数列表和原型列表分开的调用方式。于是写了个Hello.dll,里面定义了个简单的Init函数，以及另外一个和MessageBox函数格式相同的 MyMessageBox函数。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用与调用 user32::MessageBox 相同的格式调用Hello:: MyMessageBox 依然未成功。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用ApiMonitor监控，发现LoadLibrary(“hello”)返回错误码126，即“模块未找到”。尝试将hello分别放在与 安装包同目录，系统目录，在环境变量PATH里的非系统目录，结果只有放在系统目录下才调用成功。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用不同的系统来测试，win7、xp无此问题。win8与win10一样有此问题。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用c++编写一个简单的代码测试来加载NSIS加载不了的dll，也是可以加载的&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;最后使用全路径临时解决此问题。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Function .onInit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  StrCpy $InstallSuccess 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Call CheckMutex&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  InitPluginsDir&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  SetOutPath $PLUGINSDIR&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call &amp;apos;user32::MessageBox(p, t, t, i) i (0, &amp;quot;123&amp;quot;, &amp;quot;System Example 2&amp;quot;, $&amp;#123;MB_OKCANCEL&amp;#125;)&amp;apos; &amp;quot;$7&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  file &amp;quot;hello.dll&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call &amp;apos;hello::Init()&amp;apos; # 失败&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call /NOUNLOAD &amp;apos;hello::Init()&amp;apos; # 失败&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call &amp;apos;$PLUGINSDIR\hello::MyMessageBox(p, t, t, i) i (0, &amp;quot;123&amp;quot;, &amp;quot;System Example 2&amp;quot;, $&amp;#123;MB_OKCANCEL&amp;#125;)&amp;apos; &amp;quot;$7&amp;quot; #成功&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;p&gt;以前一直用的是NSIS 2.x，但这些版本的NSIS打出来的安装包没有加声明系统兼容性的manifest，也不好用软件在打好的安装包上加manifest，所以就换用了最新版本的NSIS 3.0。&lt;/p&gt;
&lt;p&gt;换用3.0后之前正常的一些System::Call “xxx:xxx”函数失效了。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;先怀疑NSIS 3.0的System插件有问题，换成2.x的System插件，也还是解决不了问题。并且未能找到System.dll的源码。并且IDA反编译之，也未发现两者有什么关于加载库的区别。
    
    </summary>
    
    
      <category term="bugs" scheme="http://baba.zhaoxiuyuan.com/tags/bugs/"/>
    
      <category term="NSIS" scheme="http://baba.zhaoxiuyuan.com/tags/NSIS/"/>
    
  </entry>
  
</feed>
