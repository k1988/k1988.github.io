<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>k1988</title>
  
  <link href="/rss.xml" rel="self"/>
  
  <link href="http://baba.zhaoxiuyuan.com/"/>
  <updated>2017-02-14T06:30:26.742Z</updated>
  <id>http://baba.zhaoxiuyuan.com/</id>
  
  <author>
    <name>赵海洋</name>
    <email>zhaohaiyang_1988@163.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>NSIS 3.0 System Call 失败问题</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/02/109_NSIS3_system_call/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/02/109_NSIS3_system_call/</id>
    <published>2017-02-03T12:00:28.000Z</published>
    <updated>2017-02-14T06:30:26.742Z</updated>
    
    <content type="html">&lt;p&gt;以前一直用的是NSIS 2.x，但这些版本的NSIS打出来的安装包没有加声明系统兼容性的manifest，也不好用软件在打好的安装包上加manifest，所以就换用了最新版本的NSIS 3.0。&lt;/p&gt;
&lt;p&gt;换用3.0后之前正常的一些System::Call “xxx:xxx”函数失效了。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;先怀疑NSIS 3.0的System插件有问题，换成2.x的System插件，也还是解决不了问题。并且未能找到System.dll的源码。并且IDA反编译之，也未发现两者有什么关于加载库的区别。&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;又怀疑是不是System语法问题，之前使用时直接没有加各种参数原型说明，也没有像文档一样使用参数列表和原型列表分开的调用方式。于是写了个Hello.dll,里面定义了个简单的Init函数，以及另外一个和MessageBox函数格式相同的 MyMessageBox函数。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用与调用 user32::MessageBox 相同的格式调用Hello:: MyMessageBox 依然未成功。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用ApiMonitor监控，发现LoadLibrary(“hello”)返回错误码126，即“模块未找到”。尝试将hello分别放在与 安装包同目录，系统目录，在环境变量PATH里的非系统目录，结果只有放在系统目录下才调用成功。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用不同的系统来测试，win7、xp无此问题。win8与win10一样有此问题。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用c++编写一个简单的代码测试来加载NSIS加载不了的dll，也是可以加载的&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;最后使用全路径临时解决此问题。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Function .onInit&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  StrCpy $InstallSuccess 0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Call CheckMutex&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  InitPluginsDir&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  SetOutPath $PLUGINSDIR&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call &amp;apos;user32::MessageBox(p, t, t, i) i (0, &amp;quot;123&amp;quot;, &amp;quot;System Example 2&amp;quot;, $&amp;#123;MB_OKCANCEL&amp;#125;)&amp;apos; &amp;quot;$7&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  file &amp;quot;hello.dll&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call &amp;apos;hello::Init()&amp;apos; # 失败&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call /NOUNLOAD &amp;apos;hello::Init()&amp;apos; # 失败&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  System::Call &amp;apos;$PLUGINSDIR\hello::MyMessageBox(p, t, t, i) i (0, &amp;quot;123&amp;quot;, &amp;quot;System Example 2&amp;quot;, $&amp;#123;MB_OKCANCEL&amp;#125;)&amp;apos; &amp;quot;$7&amp;quot; #成功&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</content>
    
    <summary type="html">
    
      &lt;p&gt;以前一直用的是NSIS 2.x，但这些版本的NSIS打出来的安装包没有加声明系统兼容性的manifest，也不好用软件在打好的安装包上加manifest，所以就换用了最新版本的NSIS 3.0。&lt;/p&gt;
&lt;p&gt;换用3.0后之前正常的一些System::Call “xxx:xxx”函数失效了。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;先怀疑NSIS 3.0的System插件有问题，换成2.x的System插件，也还是解决不了问题。并且未能找到System.dll的源码。并且IDA反编译之，也未发现两者有什么关于加载库的区别。
    
    </summary>
    
      <category term="bugs" scheme="http://baba.zhaoxiuyuan.com/categories/bugs/"/>
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/categories/bugs/windows/"/>
    
    
      <category term="bugs" scheme="http://baba.zhaoxiuyuan.com/tags/bugs/"/>
    
  </entry>
  
  <entry>
    <title>Android Studio 使用技巧：修改默认build.gradle</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/02/110_as_templates/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/02/110_as_templates/</id>
    <published>2017-02-03T12:00:28.000Z</published>
    <updated>2017-02-24T08:11:44.315Z</updated>
    
    <content type="html">&lt;p&gt;在项目中发现一些好用的插件和库，就想默认在每个工程里使用，就想到了找找如何直接修改默认工程的build.gradle文件，经过多方面查找资料，可以使用下面的方法来改。&lt;/p&gt;
&lt;p&gt;比如说有一个好用的butterKnife这个库，需要添加buildscript的dependencies和compile的dependencies。&lt;/p&gt;
&lt;p&gt;我们先找到&lt;code&gt;Android Studio\plugins\android\lib\templates\gradle-projects&lt;/code&gt;，然后看名称就知道&lt;code&gt;NewAndroidProject&lt;/code&gt;目录下的就是创建android工程时默认使用的模板。&lt;/p&gt;
&lt;p&gt;然后我们打开&lt;code&gt;root&lt;/code&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;中的&lt;code&gt;build.gradle.ftl&lt;/code&gt;，看起来和一个默认项目里的结构一模一样，我们首先把&lt;code&gt;classpath &amp;#39;com.jakewharton:butterknife-gradle-plugin:8.5.1&amp;#39;&lt;/code&gt;添加在&lt;code&gt;buildscript.dependencies&lt;/code&gt;的最后面。同时，添加一个版本号字义(这一步也可以省略，如果省略，后面在app的gradle里就直接指定版本的&lt;code&gt;butterknife&lt;/code&gt;)以供在app的gradle里使用版本号变量来指定&lt;code&gt;butterknife&lt;/code&gt;，如下文中的&lt;code&gt;ext&lt;/code&gt;结点。&lt;/p&gt;
&lt;p&gt;如：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;buildscript &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    repositories &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        jcenter()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;#if mavenUrl != &amp;quot;mavenCentral&amp;quot;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        maven &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            url &amp;apos;$&amp;#123;mavenUrl&amp;#125;&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/#if&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    dependencies &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        classpath &amp;apos;com.android.tools.build:gradle:$&amp;#123;gradlePluginVersion&amp;#125;&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        // NOTE: Do not place your application dependencies here; they belong&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        // in the individual module build.gradle files&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        classpath &amp;apos;com.jakewharton:butterknife-gradle-plugin:8.5.1&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// Define versions in a single place&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ext &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  // App dependencies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  butterKnifeVersion = &amp;apos;8.5.1&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是我们在NewAndroidProject目录里并没有找到新建工程后的app目录里的那个build.gradle对应的模板，看名称找到了&lt;code&gt;NewAndroidModule&lt;/code&gt;目录，同样的步骤打开&lt;code&gt;root\build.gradle.ftl&lt;/code&gt;然后在&lt;code&gt;dependencies&lt;/code&gt;节点添加两行，结果见：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;dependencies &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    compile fileTree(dir: &amp;apos;libs&amp;apos;, include: [&amp;apos;*.jar&amp;apos;])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    androidTestCompile(&amp;apos;com.android.support.test.espresso:espresso-core:$&amp;#123;espressoVersion!&amp;quot;2.0&amp;quot;&amp;#125;&amp;apos;, &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        exclude group: &amp;apos;com.android.support&amp;apos;, module: &amp;apos;support-annotations&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;#if WearprojectName?has_content &amp;amp;&amp;amp; NumberOfEnabledFormFactors?has_content &amp;amp;&amp;amp; NumberOfEnabledFormFactors gt 1 &amp;amp;&amp;amp; Wearincluded&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    wearApp project(&amp;apos;:$&amp;#123;WearprojectName&amp;#125;&amp;apos;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    compile &amp;apos;com.google.android.gms:play-services:+&amp;apos;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;/#if&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    // code generator for view(这3行是新增的)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    compile &amp;quot;com.jakewharton:butterknife:$rootProject.butterKnifeVersion&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    annotationProcessor &amp;quot;com.jakewharton:butterknife-compiler:$rootProject.butterKnifeVersion&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后保存文件，打开Android Stuido 新建工程。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在项目中发现一些好用的插件和库，就想默认在每个工程里使用，就想到了找找如何直接修改默认工程的build.gradle文件，经过多方面查找资料，可以使用下面的方法来改。&lt;/p&gt;
&lt;p&gt;比如说有一个好用的butterKnife这个库，需要添加buildscript的dependencies和compile的dependencies。&lt;/p&gt;
&lt;p&gt;我们先找到&lt;code&gt;Android Studio\plugins\android\lib\templates\gradle-projects&lt;/code&gt;，然后看名称就知道&lt;code&gt;NewAndroidProject&lt;/code&gt;目录下的就是创建android工程时默认使用的模板。&lt;/p&gt;
&lt;p&gt;然后我们打开&lt;code&gt;root&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/categories/android/"/>
    
    
      <category term="android gradle" scheme="http://baba.zhaoxiuyuan.com/tags/android-gradle/"/>
    
  </entry>
  
  <entry>
    <title>java重新入坑</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/01/java%E9%87%8D%E6%96%B0%E5%85%A5%E5%9D%91/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/01/java重新入坑/</id>
    <published>2017-01-11T09:49:48.000Z</published>
    <updated>2017-01-11T07:37:35.031Z</updated>
    
    <content type="html">&lt;p&gt;毕业八年了，从毕业后就没有写过java代码，仅平常看看android相关的资讯和博客及时不时编译下Android工程，以前学过的java早忘光了。&lt;/p&gt;
&lt;p&gt;最近因工作需要要重新学习下java，结果上来就踩一坑。&lt;/p&gt;
&lt;h1 id=&quot;第一坑&quot;&gt;&lt;a href=&quot;#第一坑&quot; class=&quot;headerlink&quot; title=&quot;第一坑&quot;&gt;&lt;/a&gt;第一坑&lt;/h1&gt;&lt;p&gt;更新于：2016-07-06&lt;/p&gt;
&lt;p&gt;很简单一事，随便抄了个&lt;code&gt;Property.java&lt;/code&gt;，想着怎么执行呢，按着&lt;code&gt;python、lua、php、nodejs&lt;/code&gt;类型的方式&lt;code&gt;java Property.java&lt;/code&gt;,呕妹糕，&lt;code&gt;找不到或无法加载主类 Property.java&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;查询网站，原谅我已经忘记了命令行执行java程序是需要先编译一下下的，找到&lt;code&gt;javac.exe&lt;/code&gt;执行后生成了&lt;code&gt;Property.class&lt;/code&gt;，然后&lt;code&gt;java Propery&lt;/code&gt;，又报错&lt;code&gt;找不到或无法加载主类 Property&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;why？why？都有class了还不给执行？&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;查访网络后发现虽然我机器上被各种情况装了各种java环境，可是PATH和CLASS_PATH都没有正确的被设置。&lt;/p&gt;
&lt;p&gt;添加环境变量&lt;code&gt;CLASSPATH=.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;&lt;/code&gt;及&lt;code&gt;PATH=%PATH%;.;%JAVA_HOME%\bin;&lt;/code&gt;后再执行，终于正常了。   &lt;/p&gt;
&lt;h1 id=&quot;jar中没有主清单属性&quot;&gt;&lt;a href=&quot;#jar中没有主清单属性&quot; class=&quot;headerlink&quot; title=&quot;jar中没有主清单属性&quot;&gt;&lt;/a&gt;jar中没有主清单属性&lt;/h1&gt;&lt;p&gt;ref: &lt;a href=&quot;http://jingyan.baidu.com/article/db55b60990f6084ba30a2fb8.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://jingyan.baidu.com/article/db55b60990f6084ba30a2fb8.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;验证一个java特性instrument时，将代码打包成jar包，在&lt;code&gt;manifest.md&lt;/code&gt;里只使用了&lt;code&gt;Premain-Class&lt;/code&gt;属性。但是在随后尝试直接启动时，未添加&lt;code&gt;Main-Class&lt;/code&gt;属性。&lt;/p&gt;
&lt;h1 id=&quot;第二坑&quot;&gt;&lt;a href=&quot;#第二坑&quot; class=&quot;headerlink&quot; title=&quot;第二坑&quot;&gt;&lt;/a&gt;第二坑&lt;/h1&gt;&lt;p&gt;windows上正常的java程序，放到linux上编译失败。报错&lt;code&gt;error: unmappable character for encoding ASCII&lt;/code&gt;&lt;br&gt;原因是windows上默认编码是我中文系统的gbk编码，而linux上出现编码不一致时需要在命令行中指定:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;编译时：javac -encoding gbk test.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;运行时：java  -Dfile.encoding=gbk test&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;当然，编码视不同情况可指定为utf-8等其它编码。&lt;/p&gt;
&lt;p&gt;如果编码统一，则可以在环境变量中指定&lt;code&gt;export JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF8&lt;/code&gt;,如果在在~/.bashrc文件里添加,就不用每次手动再改了!&lt;/p&gt;
&lt;h1 id=&quot;第三坑-Could-not-reserve-enough-space&quot;&gt;&lt;a href=&quot;#第三坑-Could-not-reserve-enough-space&quot; class=&quot;headerlink&quot; title=&quot;第三坑 Could not reserve enough space&quot;&gt;&lt;/a&gt;第三坑 Could not reserve enough space&lt;/h1&gt;&lt;p&gt;2017-01-11更新&lt;/p&gt;
&lt;p&gt;编译某一项目时，该项目编译时提示错误：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Error:Unable to start the daemon process.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;This problem might be caused by incorrect configuration of the daemon.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;For example, an unrecognized jvm option is used.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Please refer to the user guide chapter on the daemon at https://docs.gradle.org/3.1/userguide/gradle_daemon.html&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Please read the following process output to find out more:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-----------------------&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Error occurred during initialization of VM&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Could not reserve enough space for 2621440KB object heap&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Java HotSpot(TM) Client VM warning: ignoring option MaxPermSize=1024m; support was removed in 8.0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;是因为&lt;code&gt;gradle.properties&lt;/code&gt;中有一行&lt;code&gt;org.gradle.jvmargs=-Xmx2560m -XX:MaxPermSize=1024m&lt;/code&gt;，导致构建时java.exe报错。&lt;br&gt;直接使用命令行&lt;code&gt;java -Xmx(n)M -version&lt;/code&gt;测试，发现在我的机器上最大只能到&lt;code&gt;java -Xmx1256M -version&lt;/code&gt;，再研究研究，发现这是个32位的java，换用 &lt;strong&gt;64位jdk&lt;/strong&gt;解决之。&lt;/p&gt;
&lt;h1 id=&quot;其它坑待更新&quot;&gt;&lt;a href=&quot;#其它坑待更新&quot; class=&quot;headerlink&quot; title=&quot;其它坑待更新&quot;&gt;&lt;/a&gt;其它坑待更新&lt;/h1&gt;</content>
    
    <summary type="html">
    
      &lt;p&gt;毕业八年了，从毕业后就没有写过java代码，仅平常看看android相关的资讯和博客及时不时编译下Android工程，以前学过的java早忘光了。&lt;/p&gt;
&lt;p&gt;最近因工作需要要重新学习下java，结果上来就踩一坑。&lt;/p&gt;
&lt;h1 id=&quot;第一坑&quot;&gt;&lt;a href=&quot;#第一坑&quot; class=&quot;headerlink&quot; title=&quot;第一坑&quot;&gt;&lt;/a&gt;第一坑&lt;/h1&gt;&lt;p&gt;更新于：2016-07-06&lt;/p&gt;
&lt;p&gt;很简单一事，随便抄了个&lt;code&gt;Property.java&lt;/code&gt;，想着怎么执行呢，按着&lt;code&gt;python、lua、php、nodejs&lt;/code&gt;类型的方式&lt;code&gt;java Property.java&lt;/code&gt;,呕妹糕，&lt;code&gt;找不到或无法加载主类 Property.java&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;查询网站，原谅我已经忘记了命令行执行java程序是需要先编译一下下的，找到&lt;code&gt;javac.exe&lt;/code&gt;执行后生成了&lt;code&gt;Property.class&lt;/code&gt;，然后&lt;code&gt;java Propery&lt;/code&gt;，又报错&lt;code&gt;找不到或无法加载主类 Property&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;why？why？都有class了还不给执行？
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>那些想哭的bug（一）</title>
    <link href="http://baba.zhaoxiuyuan.com/2017/01/108_human_bug_1/"/>
    <id>http://baba.zhaoxiuyuan.com/2017/01/108_human_bug_1/</id>
    <published>2017-01-03T12:00:28.000Z</published>
    <updated>2017-02-14T06:28:37.095Z</updated>
    
    <content type="html">&lt;h1 id=&quot;前提&quot;&gt;&lt;a href=&quot;#前提&quot; class=&quot;headerlink&quot; title=&quot;前提&quot;&gt;&lt;/a&gt;前提&lt;/h1&gt;&lt;p&gt;在这些年公司和个人的项目中，有些bug在没有找到根本原因之前，会觉得真的是不可思议，各种排除各种测试都未解决或干脆就未复现。&lt;br&gt;但是当某天在查找其它问题/添加新的功能/优化代码/睡觉时，突然发现/想到根本原因之后，简直想哭。。问题可能出现在一个很不起眼/一扫而过/觉得100%不会有问题的地方。&lt;/p&gt;
&lt;p&gt;今天就遇到一个这样的bug，无语的让我想专门开个类别存放这类bug。&lt;/p&gt;
&lt;p&gt;前提条件是这样的，主程序A在运行过程中，会从服务器上拉取一些推(la)荐(ji)信(guang)息(gao),然后在不同的条件下启动程序B来显示。A和B都经常多年多个版本的迭代，加了不同类型的广告，有2种最常用的是：&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;弹窗推荐：A启动后，拉取推荐信息，下载资源，指定时间点或指定分钟数后，启动B在右下角弹窗推荐我们软件中的游戏。&lt;/li&gt;
&lt;li&gt;托盘推荐：A启动后，拉取推荐信息，下载资源，指定时间点或指定分钟数后，启动B在在托盘区域弹窗显示个图标，点击后打开我们软件中的游戏。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;有一个版本，boss看到别的程序经常在退出后还会再弹出一个窗口来推荐信息（如免费版本的winrar），就拍板添加了个功能： A启动后，拉取推荐信息，下载资源，在 &lt;strong&gt;A程序退出后&lt;/strong&gt;居中显示一张图片（有关闭按钮，倒计时），用户点击图片后打开我们推荐的网址。&lt;/p&gt;
&lt;p&gt;我们的各种推荐的到达率都是有数据统计的，点击转换率也是有数据统计的，但这个功能上线后发现居然有 &lt;em&gt;50%左右&lt;/em&gt; 的用户请求了广告，但是没有显示出来退出广告。于是乎各种分析A程序的流程（推荐信息是否拉取失败，信息解析是否可能失败，需要显示的图片资源是否可能失败，启动B程序是否可能失败，是否有安全软件拦截）、统计服务器的统计代码、统计分析服务器的代码都没有发现原因；在测试部门测试、复测时也没有发现请求了广告但是退出时不显示的问题。&lt;/p&gt;
&lt;p&gt;在其它广告的数据中，也偶有丢失个10%左右的情况，但这种50%级别的丢失，实在是难以想像哪儿出了问题，百思不得其解后，也只能先暂停掉这个类型的推荐信息。然后几个月过去了，这事儿就抛在脑后了。&lt;/p&gt;
&lt;h1 id=&quot;神之复现&quot;&gt;&lt;a href=&quot;#神之复现&quot; class=&quot;headerlink&quot; title=&quot;神之复现&quot;&gt;&lt;/a&gt;神之复现&lt;/h1&gt;&lt;p&gt;在今天，因为有个产品，我们将A和B复制并改动出了C和D，然后在走测试流程。有一个测试在测试时向我汇报，她机器上的这种类型的推荐信息偶尔不显示。&lt;br&gt;由于程序员普遍的自负心理，我想我就是A和B简单的复制，稍微改动成的C和D，怎么可能这个功能有问题呢，肯定是测试她自己在测试环境上配置错了，或者某些条件不满足。然后很不耐烦地过去瞅瞅状况，经过她几次反复的演示，我觉得至少在她那儿是有些什么情况，确实是有不显示的问题。&lt;br&gt;先一一排除掉A的信息拉取（WireShark抓包没有问题）正常，资源下载正常（资源目录里有图片），配置后台中的其它信息也一一验证是合法的，然后用 &lt;code&gt;ProcMon.exe&lt;/code&gt; 监控发现不显示广告时，D程序都是创建后很快就退出了。&lt;/p&gt;
&lt;p&gt;于是将命令行拷贝到我测试机上，然后用VS Debug运行，发现一切又很正常。&lt;/p&gt;
&lt;h1 id=&quot;神之谜底&quot;&gt;&lt;a href=&quot;#神之谜底&quot; class=&quot;headerlink&quot; title=&quot;神之谜底&quot;&gt;&lt;/a&gt;神之谜底&lt;/h1&gt;&lt;p&gt;经过几分钟的测试，在Debug和Release、及发行版本的行为对比，发现了一处代码是问题的根源。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;在B的入口处：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	// 查找A程序主窗口&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HWND hWnd = FindWindow(A程序主窗口类名, A程序标题);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if (!hWnd)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#ifndef _DEBUG&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return FALSE;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#endif // _DEBUG&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因为之前的广告的行为基本上都是A启动B，B就单独存在，当用户点击推荐信息时，将动作发送给A，让A来执行。如果A不存在了，就使用命令行启动A来处理。&lt;br&gt;但新加的那个退出推荐的逻辑是，在A的主窗口的&lt;code&gt;OnClose&lt;/code&gt;事件里启动B程序来显示广告信息，但执行顺序存在随机性，有可能是B先启动，然后走到FindWindow，也有可能是A程序的窗口先OnDestory掉，B再走到FindWindow。所以，在所有的用户环境那边，就出现了50%左右的丢失率（如果两边的执行代码区别再大一些，可能是别的百分比）。&lt;/p&gt;
&lt;p&gt;而解决办法显而易见，退出推荐时根本不需要检测A窗口是否存在，后续的用户行为反应也是不需要再启动A来执行的。在if (!hWnd) 条件中再加上广告类型的判断即可解决。&lt;/p&gt;
&lt;h1 id=&quot;迷之羞愧&quot;&gt;&lt;a href=&quot;#迷之羞愧&quot; class=&quot;headerlink&quot; title=&quot;迷之羞愧&quot;&gt;&lt;/a&gt;迷之羞愧&lt;/h1&gt;&lt;p&gt;如果倒着看这个博客，一定会嗤之以鼻：如此简单的问题都找不到。 但反想一下，这个bug是一个随机现象，且不能稳定重现，且bug触发的原因隐藏在多年表现正常的的代码中，这都导致了问题没有很快的解决（ &lt;em&gt;甩锅干脆利落&lt;/em&gt;）。&lt;/p&gt;
&lt;p&gt;其实嘛，经过多年的项目经验，确实印证了一句话 &lt;strong&gt;事出反常必有妖&lt;/strong&gt;，就是当用户出现了不正常的情况，虽然大部分情况下会不由自主的指责别人使用方法不对，但往确实是自己的程序出现了或多或少的考虑不周或者是隐藏的问题导致的。只不过，有些bug换种使用流程和环境就绕过去了（比如：万能的重启），有些bug总是会在不经意间蹦出来咬你一口。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前提&quot;&gt;&lt;a href=&quot;#前提&quot; class=&quot;headerlink&quot; title=&quot;前提&quot;&gt;&lt;/a&gt;前提&lt;/h1&gt;&lt;p&gt;在这些年公司和个人的项目中，有些bug在没有找到根本原因之前，会觉得真的是不可思议，各种排除各种测试都未解决或干脆就未复现。&lt;br&gt;但是当某天在查找其它问题/添加新的功能/优化代码/睡觉时，突然发现/想到根本原因之后，简直想哭。。问题可能出现在一个很不起眼/一扫而过/觉得100%不会有问题的地方。&lt;/p&gt;
&lt;p&gt;今天就遇到一个这样的bug，无语的让我想专门开个类别存放这类bug。&lt;/p&gt;
&lt;p&gt;前提条件是这样的，主程序A在运行过程中，会从服务器上拉取一些推(la)荐(ji)信(guang)息(gao),然后在不同的条件下启动程序B来显示。A和B都经常多年多个版本的迭代，加了不同类型的广告，有2种最常用的是：&lt;br&gt;
    
    </summary>
    
      <category term="bugs" scheme="http://baba.zhaoxiuyuan.com/categories/bugs/"/>
    
    
      <category term="bugs" scheme="http://baba.zhaoxiuyuan.com/tags/bugs/"/>
    
  </entry>
  
  <entry>
    <title>使用百度输入法时程序崩溃</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/11/107_baidupingyin_crash/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/11/107_baidupingyin_crash/</id>
    <published>2016-11-24T06:20:28.000Z</published>
    <updated>2017-02-14T06:28:40.454Z</updated>
    
    <content type="html">&lt;p&gt;使用4.0.3187.0版本的百度拼音输入法时，启动我司的快吧游戏软件，再退出快吧，程序崩溃。查看消息结构体，窗口目标句柄在spy++里已经搜索不到，崩溃地址在某台机器上是0x690eb410。&lt;/p&gt;
&lt;p&gt;重启后加汇编断点后发现，该模块地址是百度的uipfull.dll中，父调用者是user32.dll!__InternalCallWinProc@20()。而该窗口的类名是CMessenger_Wnd，样式是CS_IME。&lt;/p&gt;
&lt;p&gt;猜测在某种环境下，&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;百度输入法在uipfull模板释放时，并未将输入法窗口的WndProc修改成原来的函数，并且还触发了自定义消息？&lt;br&gt;导致分发消息时，试图尝试调用窗口的wndProc属性指定的消息处理函数，导致崩溃。&lt;/p&gt;
&lt;img title=&quot;程序崩溃&quot; alt=&quot;程序崩溃&quot; src=&quot;http://o9tn2674s.bkt.clouddn.com/static/images/107_crash.png-k1988&quot;&gt; </content>
    
    <summary type="html">
    
      &lt;p&gt;使用4.0.3187.0版本的百度拼音输入法时，启动我司的快吧游戏软件，再退出快吧，程序崩溃。查看消息结构体，窗口目标句柄在spy++里已经搜索不到，崩溃地址在某台机器上是0x690eb410。&lt;/p&gt;
&lt;p&gt;重启后加汇编断点后发现，该模块地址是百度的uipfull.dll中，父调用者是user32.dll!__InternalCallWinProc@20()。而该窗口的类名是CMessenger_Wnd，样式是CS_IME。&lt;/p&gt;
&lt;p&gt;猜测在某种环境下，
    
    </summary>
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/categories/windows/"/>
    
    
      <category term="windows shell" scheme="http://baba.zhaoxiuyuan.com/tags/windows-shell/"/>
    
  </entry>
  
  <entry>
    <title>windows托盘图标检测</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/11/106_windows%E6%89%98%E7%9B%98%E5%9B%BE%E6%A0%87%E6%A3%80%E6%B5%8B/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/11/106_windows托盘图标检测/</id>
    <published>2016-11-10T07:20:28.000Z</published>
    <updated>2016-11-10T07:57:22.160Z</updated>
    
    <content type="html">&lt;p&gt;由于业务需要，研究一下如何用程序判断右下角拖盘中某图标在什么时候隐藏到溢出区。经过多方资料查找，最终输出可用代码。支持windows xp至windows 10的32位和64位下的图标检测。&lt;/p&gt;
&lt;p&gt;32位程序中读取64位explorer进程中的信息时，网上大多只给出了32位的结构体定义，所以根据调试时查看内存分布，调整了下64位的结构体。&lt;/p&gt;
&lt;p&gt;代码如下：&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;165&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;166&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;167&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;169&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;170&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;171&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;173&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;174&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;175&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;177&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;178&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;179&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;180&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;181&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;typedef struct TBBUTTON64 &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	int iBitmap;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	int idCommand;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	BYTE fsState;	// TBSTATE_CHECKED 等&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	BYTE fsStyle;	// TBSTYLE_BUTTON 等&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	BYTE bReserved[6];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	int64_t dwData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	int64_t iString;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	BYTE test[100];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; ;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;struct TRAYDATA64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	int64_t hWnd;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	uint32_t uID;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	uint32_t uCallbackMessage;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	uint32_t Reserved1[2];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	int64_t hIcon;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	uint32_t Reserved2[4];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	TCHAR szExePath[MAX_PATH];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	TCHAR szTip[128]; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;struct TRAYDATA32 &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HWND hwnd;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	UINT uID;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	UINT uCallbackMessage;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	DWORD Reserved[2];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HICON hIcon;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	DWORD Reserved2[3];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	TCHAR szExePath[MAX_PATH];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	TCHAR szTip[128]; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bool IsWow64ProcessEx( HANDLE hProcess )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	/*判断ntdll中的导出函数,可知是否是64位OS*/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HMODULE hMod = GetModuleHandle(_T(&amp;quot;ntdll.dll&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	FARPROC x64fun = ::GetProcAddress(hMod,&amp;quot;ZwWow64ReadVirtualMemory64&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if(!x64fun) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	/*利用IsWow64Process判断是否是x64进程*/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	typedef BOOL(WINAPI *pfnIsWow64Process)(HANDLE,PBOOL);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	pfnIsWow64Process fnIsWow64Process = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hMod = GetModuleHandle(_T(&amp;quot;kernel32.dll&amp;quot;));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	fnIsWow64Process = (pfnIsWow64Process)GetProcAddress(hMod,&amp;quot;IsWow64Process&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if(!fnIsWow64Process) //如果没有导出则判定为32位&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	BOOL bX64;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if(!fnIsWow64Process(hProcess, &amp;amp;bX64))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	return !bX64;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;template&amp;lt;typename BUTTONTYPE, typename TRAYDATA_TYPE&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;void EnumIcons(size_t buttonNumber, HANDLE hProcess, LPVOID pAddress, HWND hWnd)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	for( int i=0; i&amp;lt; buttonNumber; i++ )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		long lRet = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		// 读取图标结构体&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		BUTTONTYPE buttonInfo = &amp;#123;0&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		DWORD dwBytes = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		::WriteProcessMemory(hProcess, pAddress, &amp;amp;buttonInfo, sizeof(buttonInfo), &amp;amp;dwBytes);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		lRet = ::SendMessage( hWnd, TB_GETBUTTON, i, long(pAddress) );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		lRet = ReadProcessMemory( hProcess, pAddress, &amp;amp;buttonInfo, sizeof(buttonInfo), &amp;amp;dwBytes);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		// 读取TrayData&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		TRAYDATA_TYPE trayData;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		lRet =  ::ReadProcessMemory(hProcess, (LPVOID)buttonInfo.dwData, &amp;amp;trayData, sizeof(trayData), NULL);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		// 方法1. 直接从ButtonInfo成员的string地址读取图标标题&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		TCHAR szTips[1024];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		::ReadProcessMemory(hProcess, (void*)(buttonInfo.iString),szTips, 1024, &amp;amp;dwBytes);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		OutputDebugString(szTips);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		// 方法2. 从TrayData中读取图标标题和程序路径&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		OutputDebugString(trayData.szTip);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		OutputDebugString(trayData.szExePath);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		// 方法3. 发送消息，读取图标标题&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		SendMessage(hWnd, TB_GETBUTTONTEXT, buttonInfo.idCommand, LPARAM(LPARAM(pAddress) + sizeof(buttonInfo)));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		::ReadProcessMemory(hProcess, (void*)(LPARAM(pAddress) + sizeof(buttonInfo)),szTips, 1024, &amp;amp;dwBytes);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		OutputDebugString(szTips);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 判断在通知区域是否有托盘图标&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BOOL IsTrayIconExsitInNotifyArea()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HWND hWnd = NULL, hWndPager = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	unsigned long ulPID = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	long lRet = 0, lButtons = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HANDLE hProcess = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	LPVOID pAddress = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	long lTextAdr = 0, lHwndAdr = 0, lHwnd = 0, lButtonID = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	char strBuff[1024] = &amp;#123; 0 &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	char_t *pStr = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	char *pTemp = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hWnd = ::FindWindow( _T(&amp;quot;Shell_TrayWnd&amp;quot;), NULL );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hWnd = ::FindWindowEx( hWnd, 0, _T(&amp;quot;TrayNotifyWnd&amp;quot;), NULL );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hWndPager = ::FindWindowEx( hWnd, 0, _T(&amp;quot;SysPager&amp;quot;), NULL );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if( hWndPager == NULL )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		hWnd = ::FindWindowEx( hWnd, 0, _T(&amp;quot;ToolbarWindow32&amp;quot;), NULL ); // 对于Win2000，没有SysPager窗口&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	else&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		hWnd = ::FindWindowEx( hWndPager, 0, _T(&amp;quot;ToolbarWindow32&amp;quot;), NULL );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	lRet = GetWindowThreadProcessId( hWnd, &amp;amp;ulPID );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hProcess = OpenProcess(PROCESS_ALL_ACCESS|PROCESS_VM_OPERATION|PROCESS_VM_READ|PROCESS_VM_WRITE, 0, ulPID );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	pAddress = VirtualAllocEx( hProcess, 0, 0x4096, MEM_COMMIT, PAGE_READWRITE );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	lButtons = ::SendMessage( hWnd, TB_BUTTONCOUNT, 0, 0 );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if (IsWow64ProcessEx(hProcess))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		EnumIcons&amp;lt;TBBUTTON64, TRAYDATA64&amp;gt;(lButtons, hProcess, pAddress, hWnd);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	else&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		EnumIcons&amp;lt;TBBUTTON, TRAYDATA32&amp;gt;(lButtons, hProcess, pAddress, hWnd);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	VirtualFreeEx( hProcess, pAddress, 0X4096, MEM_RELEASE );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	CloseHandle( hProcess );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	return FALSE;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// 判断在托盘溢出区域是否有托盘图标&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BOOL IsTrayIconExsitInOverflowWindow()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HWND hWnd = NULL, hWndPager = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	unsigned long ulPID = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	long lRet = 0, lButtons = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	HANDLE hProcess = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	LPVOID pAddress = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	long lTextAdr = 0, lHwndAdr = 0, lHwnd = 0, lButtonID = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	char strBuff[1024] = &amp;#123; 0 &amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	char_t *pStr = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	char *pTemp = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	// 对于Win7、Win8系统，新增了通知溢出区域，所以要检查该区域中是否有托盘图标&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hWnd = ::FindWindow( _T(&amp;quot;NotifyIconOverflowWindow&amp;quot;), NULL );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hWnd = ::FindWindowEx( hWnd, 0, _T(&amp;quot;ToolbarWindow32&amp;quot;), NULL );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	lRet = GetWindowThreadProcessId( hWnd, &amp;amp;ulPID );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	hProcess = OpenProcess(PROCESS_ALL_ACCESS|PROCESS_VM_OPERATION|PROCESS_VM_READ|PROCESS_VM_WRITE, 0, ulPID );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	pAddress = VirtualAllocEx( hProcess, 0, 0x4096, MEM_COMMIT, PAGE_READWRITE );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	lButtons = ::SendMessage( hWnd, TB_BUTTONCOUNT, 0, 0 );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	if (IsWow64ProcessEx(hProcess))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		EnumIcons&amp;lt;TBBUTTON64, TRAYDATA64&amp;gt;(lButtons, hProcess, pAddress, hWnd);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	else&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		EnumIcons&amp;lt;TBBUTTON, TRAYDATA32&amp;gt;(lButtons, hProcess, pAddress, hWnd);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	VirtualFreeEx( hProcess, pAddress, 0X4096, MEM_RELEASE );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	CloseHandle( hProcess );&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	return FALSE;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://forums.codeguru.com/showthread.php?306661-How-to-always-show-an-icon-in-system-tray&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://forums.codeguru.com/showthread.php?306661-How-to-always-show-an-icon-in-system-tray&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://bbs.csdn.net/topics/390877496&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bbs.csdn.net/topics/390877496&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://bbs.csdn.net/topics/80237414&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bbs.csdn.net/topics/80237414&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/wzsy/article/details/47980317&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/wzsy/article/details/47980317&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.cnblogs.com/croot/p/3496576.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.cnblogs.com/croot/p/3496576.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;由于业务需要，研究一下如何用程序判断右下角拖盘中某图标在什么时候隐藏到溢出区。经过多方资料查找，最终输出可用代码。支持windows xp至windows 10的32位和64位下的图标检测。&lt;/p&gt;
&lt;p&gt;32位程序中读取64位explorer进程中的信息时，网上大多只给出了32位的结构体定义，所以根据调试时查看内存分布，调整了下64位的结构体。&lt;/p&gt;
&lt;p&gt;代码如下：&lt;br&gt;
    
    </summary>
    
      <category term="windows" scheme="http://baba.zhaoxiuyuan.com/categories/windows/"/>
    
    
      <category term="windows shell" scheme="http://baba.zhaoxiuyuan.com/tags/windows-shell/"/>
    
  </entry>
  
  <entry>
    <title>我的世界服务器玩家UUID生成规则</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/10/105_MC%E7%94%A8%E6%88%B7%E7%9A%84UUID%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/10/105_MC用户的UUID生成规则/</id>
    <published>2016-10-10T04:20:28.000Z</published>
    <updated>2016-10-10T04:49:14.236Z</updated>
    
    <content type="html">&lt;p&gt;由于业务需要，研究一下如何将离线版(盗版)minecraft服务器的玩家数据迁移到在线版我的世界服务器上去。&lt;/p&gt;
&lt;p&gt;查看minecraft的服务器代码(反编译)，如果是在线模式就连接用户验证服务器去获取玩家的uuid，否则就根据规则自动生成。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;//代码片断from: net.minecraft.server.NameReferencingFileConverter&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;if (minecraftserver.getOnlineMode() || org.spigotmc.SpigotConfig.bungee) &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    // Spigot: bungee = online mode, for now.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    minecraftserver.getGameProfileRepository().findProfilesByNames(astring, Agent.MINECRAFT, profilelookupcallback);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String[] astring1 = astring;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    int i = astring.length;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    for (int j = 0; j &amp;lt; i; ++j) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String s = astring1[j];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        UUID uuid = EntityHuman.a(new GameProfile((UUID) null, s));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        GameProfile gameprofile = new GameProfile(uuid, s);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        profilelookupcallback.onProfileLookupSucceeded(gameprofile);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;//from：net.minecraft.server.EntityHuman&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;public static UUID a(GameProfile gameprofile) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    UUID uuid = gameprofile.getId();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if (uuid == null) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        uuid = b(gameprofile.getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return uuid;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;public static UUID b(String s) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return UUID.nameUUIDFromBytes((&amp;quot;OfflinePlayer:&amp;quot; + s).getBytes(Charsets.UTF_8));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;生成算法是在用户昵称前面加上“OfflinePlayer:”后使用java函数nameUUIDFromBytes来生成。&lt;/p&gt;
&lt;p&gt;nameUUIDFromBytes函数代码如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;// from: java.util.UUID.java&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;public static UUID nameUUIDFromBytes(byte[] name) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    MessageDigest md;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        md = MessageDigest.getInstance(&amp;quot;MD5&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125; catch (NoSuchAlgorithmException nsae) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        throw new InternalError(&amp;quot;MD5 not supported&amp;quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    byte[] md5Bytes = md.digest(name);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    md5Bytes[6]  &amp;amp;= 0x0f;  /* clear version        */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    md5Bytes[6]  |= 0x30;  /* set to version 3     */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    md5Bytes[8]  &amp;amp;= 0x3f;  /* clear variant        */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    md5Bytes[8]  |= 0x80;  /* set to IETF variant  */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return new UUID(md5Bytes);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;1、计算出MD5    &lt;/p&gt;
&lt;p&gt;&lt;code&gt;OfflinePlayer:k1988&lt;/code&gt; -&amp;gt; MD5: &lt;code&gt;08D699BB6400555E581B678C9441FA75&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;2、MD5的值和生成的uuid文件名对比&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;08d699bb-6400-555e-581b-678c9441fa75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;08d699bb-6400-355e-981b-678c9441fa75&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;== 解析法 ==&lt;/p&gt;
&lt;p&gt;还有一种方法就是枚举minecraft服务器中的world\playerdata目录，这个目录下每个文件对应着一个玩家，文件名(不含后缀)就是一个玩家的uuid，文件使用NBT方式储存着一些用户信息，包括用户上一次使用的昵称(可见，在线版服务器是方便更改昵称的)，及其它信息。&lt;/p&gt;
&lt;p&gt;我fork了一个NBT解析的python代码，并在里面添加了一个python脚本用来枚举playerdata下的所有文件，fork后的代码在&lt;a href=&quot;https://github.com/k1988/NBT&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/k1988/NBT&lt;/a&gt; ，脚本在examples/player_print.py，使用时直接&lt;code&gt;player_print.py &amp;lt;playerdata目录路径&amp;gt;&lt;/code&gt;即可，效果如下图：&lt;br&gt;&lt;img title=&quot;截图&quot; alt=&quot;截图&quot; src=&quot;http://o9tn2674s.bkt.clouddn.com/static/images/105_1.png-k1988&quot;&gt; &lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;由于业务需要，研究一下如何将离线版(盗版)minecraft服务器的玩家数据迁移到在线版我的世界服务器上去。&lt;/p&gt;
&lt;p&gt;查看minecraft的服务器代码(反编译)，如果是在线模式就连接用户验证服务器去获取玩家的uuid，否则就根据规则自动生成。&lt;br&gt;
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/categories/java/minecraft/"/>
    
    
      <category term="minecraft flash" scheme="http://baba.zhaoxiuyuan.com/tags/minecraft-flash/"/>
    
  </entry>
  
  <entry>
    <title>IE控件在flash跨域时回调接口无效的问题研究</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/09/104_IE%E6%8E%A7%E4%BB%B6%E5%9C%A8flash%E8%B7%A8%E5%9F%9F%E6%97%B6%E5%9B%9E%E8%B0%83%E6%8E%A5%E5%8F%A3%E6%97%A0%E6%95%88/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/09/104_IE控件在flash跨域时回调接口无效/</id>
    <published>2016-09-22T05:58:28.000Z</published>
    <updated>2016-10-10T04:28:44.628Z</updated>
    
    <content type="html">&lt;p&gt;问题是这样的，我们公司的产品《UU页游戏助手》中是使用了IE浏览器的ActiveX控件来运行网页游戏，其中创建代码是这样的：&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;hr = ::CoCreateInstance(&amp;quot;&amp;#123;8856F961-340A-11D0-A96B-00C04FD705A2&amp;#125;&amp;quot;, NULL, CLSCTX_ALL, IID_IOleControl, (LPVOID*)&amp;amp;pOleControl);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; GAMEMGR_ASSERT(SUCCEEDED(hr));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if (FAILED(hr) || pOleControl == NULL)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pOleControl-&amp;gt;QueryInterface(IID_IOleObject, (LPVOID*) &amp;amp;m_pUnk);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pOleControl-&amp;gt;Release();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if (m_pUnk == NULL)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    // Create the host too&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    m_pControl = new GMActiveXCtrl();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    m_pControl-&amp;gt;SetOwner(this);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    // More control creation stuff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    DWORD dwMiscStatus = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    m_pUnk-&amp;gt;GetMiscStatus(DVASPECT_CONTENT, &amp;amp;dwMiscStatus);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    IOleClientSite* pOleClientSite = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    m_pControl-&amp;gt;QueryInterface(IID_IOleClientSite, (LPVOID*) &amp;amp;pOleClientSite);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    GMSafeRelease&amp;lt;IOleClientSite&amp;gt; RefOleClientSite = pOleClientSite;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    // Initialize control&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if ((dwMiscStatus &amp;amp; OLEMISC_SETCLIENTSITEFIRST) != 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		m_pUnk-&amp;gt;SetClientSite(pOleClientSite);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    IPersistStreamInit* pPersistStreamInit = NULL;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    m_pUnk-&amp;gt;QueryInterface(IID_IPersistStreamInit, (LPVOID*) &amp;amp;pPersistStreamInit);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if (pPersistStreamInit != NULL)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        hr = pPersistStreamInit-&amp;gt;InitNew();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pPersistStreamInit-&amp;gt;Release();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if (FAILED(hr))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return false;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    if ((dwMiscStatus &amp;amp; OLEMISC_SETCLIENTSITEFIRST) == 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		m_pUnk-&amp;gt;SetClientSite(pOleClientSite);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;在使用这个IE控件时，经常有诸多问题，很多行为和IE不一致。需要去注册表添加不同的选项，最经典和常见的问题莫过于IE兼容性的问题，需要在&lt;code&gt;HKEY_CURRENT_USER\SOFTWARE\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_BROWSER_EMULATION&lt;/code&gt;中添加注册表键来强行指定兼容版本。&lt;/p&gt;
&lt;h2 id=&quot;问题来了&quot;&gt;&lt;a href=&quot;#问题来了&quot; class=&quot;headerlink&quot; title=&quot;问题来了&quot;&gt;&lt;/a&gt;问题来了&lt;/h2&gt;&lt;p&gt;然而 在前不久和今天都有客户反映他们的 &lt;strong&gt;flash&lt;/strong&gt;广告页面（是那种打开后是个flash页面，然后 &lt;strong&gt;点击flash里的按钮/图像&lt;/strong&gt;就弹出注册登录的 &lt;strong&gt;html小浮层&lt;/strong&gt;的页面）在我们的浏览器上有问题，用户第一次打开页面能正常弹出小浮层，但后面再打开就不显示了。&lt;/p&gt;
&lt;p&gt;第一次粗略的研究下，发现清除ie缓存后再打开页面后表现正常，经过调试js也没有发现明显的问题，就让客户在请求swf的链接上添加&lt;code&gt;?t=当前时间戳&lt;/code&gt;的方式避免缓存。但今天再遇到了，就想彻底的研究下到底在什么情况下会出现这个问题。&lt;/p&gt;
&lt;p&gt;使用vs2015使用 &lt;strong&gt;脚本模式&lt;/strong&gt; 附加到我们的程序上，打开解决方案管理器进行调试。多次跟踪代码和对比发现在html这边初使化flash的流程是一样的，所以问题不是在这边。而初使化之后，无缓存的情况下点击flash，js中的函数能被调用，而有缓存的情况下点击flash，js中的函数无法被调用。&lt;/p&gt;
&lt;p&gt;在无缓存的情况下，在js函数中下断点，然后回溯堆栈，发现上层调用者是动态生成的代码”eval code”：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;try &amp;#123; __flash__toXML(sayHello((&amp;#123;code:1,description:&amp;quot;Parameter test&amp;quot;&amp;#125;))) ; &amp;#125; catch (e) &amp;#123; &amp;quot;&amp;lt;undefined/&amp;gt;&amp;quot;; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;因为有过一段as的编码经验，所以知道这是ie和flash生成的支持swf文件里的action script调用js的函数，那么问题来了，为什么在有缓存的情况下没有自动生成这些代码？&lt;/p&gt;
&lt;img title=&quot;堆栈截图&quot; alt=&quot;堆栈截图&quot; src=&quot;http://o9tn2674s.bkt.clouddn.com/static/images/104_1.png-k1988&quot;&gt; 
&lt;h2 id=&quot;模拟重现问题&quot;&gt;&lt;a href=&quot;#模拟重现问题&quot; class=&quot;headerlink&quot; title=&quot;模拟重现问题&quot;&gt;&lt;/a&gt;模拟重现问题&lt;/h2&gt;&lt;p&gt;由于原网页过于复杂，我首先想将这个问题用简单的代码复现，就找到了以前用来测试actionscript和js交互时制作的demo，将其直接布署在我的本地测试机器上。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;我以ip访问测试页面，多次刷新页面，再点击flash按钮，可以正常工作。&lt;/li&gt;
&lt;li&gt;对比发现广告页面是动态插入的flash，于是将demo改成动态插入，但还是无异常。 &lt;/li&gt;
&lt;li&gt;绑定个域名到本机，然后使用域名访问，多次刷新后点击，可以正常工作。&lt;/li&gt;
&lt;li&gt;将swf放在另一个域名，然后多次刷新后点击，不工作。但是这种情况，是无论有无缓存，都不正常工作。&lt;/li&gt;
&lt;li&gt;对比发现demo中的flash节点中&lt;code&gt;allowScriptAccess=&amp;quot;sameDomain&amp;quot;&lt;/code&gt;，而网页的节点属性是&lt;code&gt;allowScriptAccess=&amp;quot;always&amp;quot;&lt;/code&gt;，所以是flash属性导致的。&lt;/li&gt;
&lt;li&gt;去除该属性后再多次刷新对比，成功模拟环境。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在 &lt;strong&gt;IE控件&lt;/strong&gt;中打开的页面中，如果是从 &lt;strong&gt;缓存中加载的swf文件&lt;/strong&gt;，在 &lt;strong&gt;跨域&lt;/strong&gt;的情况下 &lt;strong&gt;未能正常生成&lt;/strong&gt;flash的相关 &lt;strong&gt;动态js代码&lt;/strong&gt;，导致flash中的actionscript不能调用javascript函数。&lt;/p&gt;
&lt;p&gt;但是，在ie浏览器中，无论是否从缓存中加载swf，均能正常生成动态js代码。&lt;/p&gt;
&lt;h2 id=&quot;解决问题&quot;&gt;&lt;a href=&quot;#解决问题&quot; class=&quot;headerlink&quot; title=&quot;解决问题&quot;&gt;&lt;/a&gt;解决问题&lt;/h2&gt;&lt;p&gt;尝试使用跨域文件，无效。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;未能解决此问题，留待以后继续研究吧。。&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;参考：&quot;&gt;&lt;a href=&quot;#参考：&quot; class=&quot;headerlink&quot; title=&quot;参考：&quot;&gt;&lt;/a&gt;参考：&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://stackoverflow.com/questions/30279742/webbrowser-control-and-adobe-flash-content/37503745#37503745&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://stackoverflow.com/questions/30279742/webbrowser-control-and-adobe-flash-content/37503745#37503745&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/summerhust/article/details/7721627&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/summerhust/article/details/7721627&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;问题是这样的，我们公司的产品《UU页游戏助手》中是使用了IE浏览器的ActiveX控件来运行网页游戏，其中创建代码是这样的：&lt;br&gt;
    
    </summary>
    
      <category term="ie" scheme="http://baba.zhaoxiuyuan.com/categories/ie/"/>
    
      <category term="flash" scheme="http://baba.zhaoxiuyuan.com/categories/ie/flash/"/>
    
    
      <category term="ie flash" scheme="http://baba.zhaoxiuyuan.com/tags/ie-flash/"/>
    
  </entry>
  
  <entry>
    <title>Java Annotation(Java注解)</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/08/103_java%20Annotation(%E6%B3%A8%E8%A7%A3)/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/08/103_java Annotation(注解)/</id>
    <published>2016-08-18T03:44:28.000Z</published>
    <updated>2016-08-18T03:46:52.995Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Java注解的基础知识点&quot;&gt;&lt;a href=&quot;#Java注解的基础知识点&quot; class=&quot;headerlink&quot; title=&quot;Java注解的基础知识点&quot;&gt;&lt;/a&gt;Java注解的基础知识点&lt;/h2&gt;&lt;!--![123](./images/annotation.jpg)--&gt;
&lt;img title=&quot;Java注解的基础知识点&quot; alt=&quot;Java注解的基础知识点&quot; src=&quot;http://o9tn2674s.bkt.clouddn.com/static/images/annotation.jpg-k1988&quot;&gt; 
&lt;h2 id=&quot;参考资料&quot;&gt;&lt;a href=&quot;#参考资料&quot; class=&quot;headerlink&quot; title=&quot;参考资料&quot;&gt;&lt;/a&gt;参考资料&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://swiftlet.net/archives/1906&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;注解系列知识总结&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.cnblogs.com/peida/archive/2013/04/24/3036689.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;深入理解Java：注解（Annotation）自定义注解入门&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/duo2005duo/article/details/50505884&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Java注解（1）-基础&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/duo2005duo/article/details/50511476&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Java注解（2）-运行时框架&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/duo2005duo/article/details/50541281&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt; Java注解（3）-源码级框架&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.cnblogs.com/peida/archive/2013/04/24/3036689.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;深入理解Java：注解（Annotation）自定义注解入门&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;深入理解Java：注解（Annotation）--注解处理器&quot;&gt;深入理解Java：注解（Annotation）–注解处理器&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Java注解的基础知识点&quot;&gt;&lt;a href=&quot;#Java注解的基础知识点&quot; class=&quot;headerlink&quot; title=&quot;Java注解的基础知识点&quot;&gt;&lt;/a&gt;Java注解的基础知识点&lt;/h2&gt;&lt;!--![123](./images/annotation.jp
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>minecraft联机知识点</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/08/102/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/08/102/</id>
    <published>2016-08-12T02:44:28.000Z</published>
    <updated>2016-08-12T02:53:23.195Z</updated>
    
    <content type="html">&lt;h1 id=&quot;配置文件&quot;&gt;&lt;a href=&quot;#配置文件&quot; class=&quot;headerlink&quot; title=&quot;配置文件&quot;&gt;&lt;/a&gt;配置文件&lt;/h1&gt;&lt;p&gt;%mc%.minecraft\servers.dat里存放着所有的服务器地址、名称、图标、介绍等信息。其中服务器地址和名称可以通过mc的主菜单-&amp;gt;多人游戏-&amp;gt;添加服务器进行添加。&lt;/p&gt;
&lt;h1 id=&quot;命令行&quot;&gt;&lt;a href=&quot;#命令行&quot; class=&quot;headerlink&quot; title=&quot;命令行&quot;&gt;&lt;/a&gt;命令行&lt;/h1&gt;&lt;p&gt;也可以通过命令行 –server mc.ymdcyy.com –port 25565 来启动mc，使之直接连接到服务器。&lt;/p&gt;
&lt;h1 id=&quot;架设服务器&quot;&gt;&lt;a href=&quot;#架设服务器&quot; class=&quot;headerlink&quot; title=&quot;架设服务器&quot;&gt;&lt;/a&gt;架设服务器&lt;/h1&gt;&lt;p&gt;通过&lt;a id=&quot;more&quot;&gt;&lt;/a&gt; &lt;a href=&quot;https://minecraft.net/en/download/server&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://minecraft.net/en/download/server&lt;/a&gt; 页面下载&lt;a href=&quot;https://s3.amazonaws.com/Minecraft.Download/versions/1.10/minecraft_server.1.10.jar&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;minecraft_server.1.10.jar&lt;/a&gt;,再使用命令行&lt;code&gt;java -Xmx1024M -Xms1024M -jar minecraft_server.jar nogui&lt;/code&gt;可以启动mincraft服务器。&lt;/p&gt;
&lt;p&gt;第一次启动时，会生成&lt;code&gt;eula.txt&lt;/code&gt;、&lt;code&gt;server.properties&lt;/code&gt;文件，然后报错失败。&lt;/p&gt;
&lt;p&gt;这时需要打开&lt;code&gt;eula.txt&lt;/code&gt;将&lt;code&gt;eula=false&lt;/code&gt;改为&lt;code&gt;eula=true&lt;/code&gt;表示同意协议，再次运行命令行在弹出几个错误后会建立成功服务器。这时server.properties里自动生成了一些属性，&lt;code&gt;server-port=25565&lt;/code&gt;这行就是默认使用的端口，也可以改成其它端口后重启。&lt;/p&gt;
&lt;h2 id=&quot;参数说明&quot;&gt;&lt;a href=&quot;#参数说明&quot; class=&quot;headerlink&quot; title=&quot;参数说明&quot;&gt;&lt;/a&gt;参数说明&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;#Minecraft server properties 服务器设置文件 此类型文件不支持中文，本内容仅供作为说明，true代表执行，false代表不执行&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#Sun Mar 11 18:24:34 CST 2012 此为文件生成时间&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否开启地狱，不开启话地狱门将无效&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;allow-nether=true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#地图文件夹名称，下界与末路之地将会自动以nether,ender加上并用下划线隔开&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;level-name=world&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否开启GameSpy4协议服务器监听器，用于获取服务器信息。目测国内用不上。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enable-query=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否允许飞行&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;allow-flight=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#远程访问服务器的密码，此项可以留空或删除&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rcon.password=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#服务器端口（25565为默认端口，联机时无需输入）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server-port=25565&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#第5行对应功能的端口&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;query.port=25565&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#地图类型，Default=默认，FLAT=超平坦，LARGEBIOMES=巨型生物群系&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;level-type=DEFAULT&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否开启远程访问服务器控制台。技术人员可选。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enable-rcon=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#地图种子，在生成地图文件夹之前填入此项，可生成特定的地图&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;level-seed=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#服务器IP，不输入则为默认IP，内网用户的话请填内网IP&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;server-ip=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#最大建筑高度，上限是256，因为Chunk的高度最大值是256&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;max-build-height=256&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否生成NPC&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spawn-npcs=true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否开启白名单，没有白名单的玩家尝试进入服务器会被自动拒绝&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;white-list=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否生成动物&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spawn-animals=true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#此处填写服务器默认材质下载链接，链接必须以.zip结尾&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;texture-pack=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#用于给http://snoop.minecraft.net网站发送服务器数据，这样玩家可以从客户端上获取服务器信息，目测也没人看，推荐关闭&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;snooper-enabled=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否开启极限模式，玩家死亡将自动被ban&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;hardcore=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否开启联网模式（正版专用，盗版必改为false！！！！！！！！！）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;online-mode=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否开启PVP，不是战争服就不要开了&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pvp=false&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#游戏难度，与单机相同&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;difficulty=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#玩家第一次进入游戏时的游戏模式&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gamemode=0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#同时在线的最大玩家数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;max-players=20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#远程访问服务器的端口号，此项可以留空或删除&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;rcon.port=25575&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否生成怪物&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spawn-monsters=true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#是否生成建筑物（包括村庄和地牢）&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;generate-structures=true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#可见距离，最大值为10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;view-distance=10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#服务器欢迎信息（显示在玩家联机页面），中文需中文补丁支持和转码（yy的补丁可用（也需要旧版服务器），ICE未知），推荐EmEditor文本编辑器，自带转码功能&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;motd=A Minecraft Server&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h1 id=&quot;客户端ping&quot;&gt;&lt;a href=&quot;#客户端ping&quot; class=&quot;headerlink&quot; title=&quot;客户端ping&quot;&gt;&lt;/a&gt;客户端ping&lt;/h1&gt;&lt;p&gt;MC在打开网络时，会对每一个保存的服务器进行ping来获取服务器描述信息和图片文件，支持的客户端版本号及在线人数等信息，使用的协议参考&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://wiki.vg/Server_List_Ping&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://wiki.vg/Server_List_Ping&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://wiki.vg/Query&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://wiki.vg/Query&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;测试服务器列表&quot;&gt;&lt;a href=&quot;#测试服务器列表&quot; class=&quot;headerlink&quot; title=&quot;测试服务器列表&quot;&gt;&lt;/a&gt;测试服务器列表&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;five.mengcraft.com:18233&lt;/li&gt;
&lt;li&gt;龙腾盛世 &lt;ul&gt;
&lt;li&gt;mc.ymdcyy.com:25565&lt;/li&gt;
&lt;li&gt;官网：www.ymdcyy.com&lt;/li&gt;
&lt;li&gt;版本 1.7.10&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;配置文件&quot;&gt;&lt;a href=&quot;#配置文件&quot; class=&quot;headerlink&quot; title=&quot;配置文件&quot;&gt;&lt;/a&gt;配置文件&lt;/h1&gt;&lt;p&gt;%mc%.minecraft\servers.dat里存放着所有的服务器地址、名称、图标、介绍等信息。其中服务器地址和名称可以通过mc的主菜单-&amp;gt;多人游戏-&amp;gt;添加服务器进行添加。&lt;/p&gt;
&lt;h1 id=&quot;命令行&quot;&gt;&lt;a href=&quot;#命令行&quot; class=&quot;headerlink&quot; title=&quot;命令行&quot;&gt;&lt;/a&gt;命令行&lt;/h1&gt;&lt;p&gt;也可以通过命令行 –server mc.ymdcyy.com –port 25565 来启动mc，使之直接连接到服务器。&lt;/p&gt;
&lt;h1 id=&quot;架设服务器&quot;&gt;&lt;a href=&quot;#架设服务器&quot; class=&quot;headerlink&quot; title=&quot;架设服务器&quot;&gt;&lt;/a&gt;架设服务器&lt;/h1&gt;&lt;p&gt;通过
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/categories/java/minecraft/"/>
    
    
      <category term="minecraft" scheme="http://baba.zhaoxiuyuan.com/tags/minecraft/"/>
    
  </entry>
  
  <entry>
    <title>通过修改fontconfig.properties文件来改变IDE字体</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/08/fontconfig.properties/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/08/fontconfig.properties/</id>
    <published>2016-08-10T10:29:28.000Z</published>
    <updated>2016-08-11T01:35:05.062Z</updated>
    
    <content type="html">&lt;p&gt;在公司的win10上使用IDEA,设置字体为Monospaced和18号字体，发现中文显示出来不对。明明输入 的是“中文”结果显示出来的是“争X”(这个x是个奇怪的字我打不出来)，复制到别的ide里也是“中文”。 &lt;a id=&quot;more&quot;&gt;&lt;/a&gt; &lt;/p&gt;
&lt;p&gt;经过一翻努力研究，发现只有在我的机器上对于中文+某些字体的组合不能设置成16以上字号，在别的机器上是正常的。&lt;/p&gt;
&lt;p&gt;顺便发现了可以使用fontconfig.properties这个文件来改变基于java的程序的字体映射。&lt;/p&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://my.oschina.net/Tyrfing/blog/681278&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://my.oschina.net/Tyrfing/blog/681278&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/jinuxwu/article/details/5933316&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/jinuxwu/article/details/5933316&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/quantumpo/article/details/10274079&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/quantumpo/article/details/10274079&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://jingyan.baidu.com/article/48a42057c293d9a924250481.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://jingyan.baidu.com/article/48a42057c293d9a924250481.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;在公司的win10上使用IDEA,设置字体为Monospaced和18号字体，发现中文显示出来不对。明明输入 的是“中文”结果显示出来的是“争X”(这个x是个奇怪的字我打不出来)，复制到别的ide里也是“中文”。
    
    </summary>
    
      <category term="java" scheme="http://baba.zhaoxiuyuan.com/categories/java/"/>
    
    
  </entry>
  
  <entry>
    <title>libtorrent打洞分析</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/07/libtorrent%E6%89%93%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/07/libtorrent打洞分析/</id>
    <published>2016-07-17T07:49:48.000Z</published>
    <updated>2016-08-12T05:30:58.757Z</updated>
    
    <content type="html">&lt;h1 id=&quot;相关变量&quot;&gt;&lt;a href=&quot;#相关变量&quot; class=&quot;headerlink&quot; title=&quot;相关变量&quot;&gt;&lt;/a&gt;相关变量&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;torrent_peer::supports_holepunch&lt;/code&gt;：torrent_peer类是每个peer的特征集合，其中&lt;code&gt;supports_holepunch&lt;/code&gt;代表是否支持打洞，默认值是&lt;code&gt;false&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bt_peer_connection::m_holepunch_id&lt;/code&gt;: 对方peer申明的，它所支持的打洞消息的消息id。&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;种子来源&quot;&gt;&lt;a href=&quot;#种子来源&quot; class=&quot;headerlink&quot; title=&quot;种子来源&quot;&gt;&lt;/a&gt;种子来源&lt;/h1&gt;&lt;p&gt;添加peer的流程：&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;torrent::add_peer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;peer_list::add_i2p_peer或peer_list::add_peer &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;peer_list::insert_peer或peer_list::update_peer&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;```    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;如果flags参数包含`flag_holepunch`时，才设置`torrent_peer::supports_holepunch`为true。&amp;lt;!--more--&amp;gt;查找所有调用add_peer的地方，约有以下来源：&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* 从resume文件里获得peer(上次开启任务保存的)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* dht方式从互联网中得到种子&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* tracker从互联网中拿到种子&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* lsd方式从本地网络得到种子&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;* pex方式从互联网中拿到种子&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;其中只有从pex方式得到互联网种子的调用语句使用flags参数，&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 判断是否支持打洞消息&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;在和另一个peer建立连接时，使用bt_peer_connection类，q原来成员变量bt_peer_connection::m_supports_extensions默认值为false，表示不支持bt扩展协议。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;在bt_peer_connection的握手时，会发送是否支持扩展协议的标志，以及支持哪些扩展。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;当确定对面也支持扩展时，进行扩展的handshake操作，其中发送出去的becode结构中，有几以下个整形变量upload_only、ut_holepunch、lt_donthave，他们就对应着本peer接收这3种通知时使用的消息id类型。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;当从握手拿到了对方设置的ut_holepunch时，赋值给成员变量m_holepunch_id,此时此连接的函数supports_holepunch就返回了true值，表示支持打洞。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;bool bt_peer_connection::supports_holepunch() const { return m_holepunch_id != 0; }&lt;br&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;但bt_peer_connection的supports_holepunch()返回true只能说明此peer支持打洞，打洞是需要第三方服务器介入的，如何得到中间介绍人呢，见下节。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 中间介绍人&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;上文提到，种子来源有pex方式。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;当session开启了ut_pex插件时(`session_handle::add_extension(&amp;amp;libtorrent::create_ut_pex_plugin)`)，在ut_pex_peer_plugin::tick()中会使用send_ut_peer_list和send_ut_peer_diff函数来向其它peer发送自己拥有的种子。其中`bt_peer_connection* p = static_cast&amp;lt;bt_peer_connection*&amp;gt;(peer); ... flags |= p-&amp;gt;supports_holepunch() ? 8 : 0;`将peer信息发送给另外一个peer时，会带上了支持打洞的flags，然后接收方拿到peer后，向torrent里添加peer时，`torrent_peer::supports_holepunch`的值就会是true了。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;假设自己是peer A，和peer B握手后知道B是支持打洞消息的，在和peer C连接时，使用pex扩展协议和peer C交换peer时，会把peer B的ip、端口、标志传递peer C，peer C拿到B后就满足了打洞的条件，因为A和B能正常通信，A和C也能正常通信，B和C就可以使用中间人A来进行打洞。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# 什么时候尝试打洞&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;在连接某个peer失败时，并且满足条件时，尝试进入打洞模式。见`void peer_connection::connect_failed(error_code const&amp;amp; e)`中，&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;if ((!is_utp(&lt;em&gt;m_socket)&lt;br&gt;        || !m_settings.get_bool(settings_pack::enable_outgoing_tcp))&lt;br&gt;    &amp;amp;&amp;amp; m_peer_info&lt;br&gt;    &amp;amp;&amp;amp; m_peer_info-&amp;gt;supports_holepunch&lt;br&gt;    &amp;amp;&amp;amp; !m_holepunch_mode)&lt;br&gt;{&lt;br&gt;    // see if we can try a holepunch&lt;br&gt;    bt_peer_connection&lt;/em&gt; p = t-&amp;gt;find_introducer(remote());&lt;br&gt;    if (p)&lt;br&gt;        p-&amp;gt;write_holepunch_msg(bt_peer_connection::hp_rendezvous, remote(), 0);&lt;br&gt;}&lt;br&gt;```&lt;br&gt;假设这段代码是peer C的机器上运行，也就是C从A拿到B的信息后，直接连接B失败了，就判断现在不是utp或者禁止tcp连接、并且支持打洞消息、当前不是打洞模式并且找到了中间介绍人(上文中提到的A)，则向A发送消息开启打洞流程。&lt;/p&gt;
&lt;p&gt;参数中&lt;code&gt;bt_peer_connection::hp_rendezvous&lt;/code&gt;这个变量很有意思，rendezvous是约会地点的意思，当然在这里只是一个消息类型，remote()是B的ip地址信息。&lt;/p&gt;
&lt;p&gt;A接收到C发送的请求打洞（介绍约会）消息后，在自己的peer里找到和B的连接，并且向B发送个打洞消息&lt;code&gt;p-&amp;gt;write_holepunch_msg(hp_connect, remote(), 0);&lt;/code&gt;，同时向C也回复一个打洞消息&lt;code&gt;write_holepunch_msg(hp_connect, ep, 0);&lt;/code&gt;，这里就将自己和B、C的连接时使用的ip地址和端口通知给C、B。&lt;/p&gt;
&lt;p&gt;B和C接收到类型为hp_connect的消息后，将torrent_peer::supports_utp置为true，将bt_peer_connection的m_holepunch_mode设置为true。然后同时开始尝试连接对方，这时，就完成了一个打洞流程，但是由于NAT的特性，不一定成功，具体参考NAT和打洞原理。&lt;/p&gt;
&lt;h1 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;A从trcker拿到peer B和peer C，和B和C进行连接时，知道了B和C支持打洞消息。&lt;/li&gt;
&lt;li&gt;A和C进行pex种子交换，将B传递给C，此时B由pex传递的flags知道C能够通过A打洞。&lt;/li&gt;
&lt;li&gt;B如果连接C正常(不需要打洞)则正常连接。&lt;/li&gt;
&lt;li&gt;B如果连接C失败，就尝试通过A打洞。于是向A发送了打洞请求。&lt;/li&gt;
&lt;li&gt;A接收到B要向C连接的打洞请求，就给B和C发送了互相连接的打洞消息。&lt;/li&gt;
&lt;li&gt;B和C接收请求后，相互发送消息，可能会打通NAT。&lt;/li&gt;
&lt;/ol&gt;
</content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;相关变量&quot;&gt;&lt;a href=&quot;#相关变量&quot; class=&quot;headerlink&quot; title=&quot;相关变量&quot;&gt;&lt;/a&gt;相关变量&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;torrent_peer::supports_holepunch&lt;/code&gt;：torrent_pe
    
    </summary>
    
      <category term="net" scheme="http://baba.zhaoxiuyuan.com/categories/net/"/>
    
      <category term="P2P" scheme="http://baba.zhaoxiuyuan.com/categories/net/P2P/"/>
    
    
      <category term="p2p" scheme="http://baba.zhaoxiuyuan.com/tags/p2p/"/>
    
  </entry>
  
  <entry>
    <title>使用SHA1、SHA2双证书进行微软签名</title>
    <link href="http://baba.zhaoxiuyuan.com/2016/02/101/"/>
    <id>http://baba.zhaoxiuyuan.com/2016/02/101/</id>
    <published>2016-02-03T00:28:11.000Z</published>
    <updated>2016-07-04T09:45:48.944Z</updated>
    
    <content type="html">&lt;p&gt;微软是第一个宣布了SHA-1弃用计划，在2016年之后Windows和IE将不再信任SHA-1证书。正好我们公司的数字签名也到期了，索性就重新申请了sha256和sha1的新数字证书，用来给产品签名。&lt;/p&gt;
&lt;p&gt;这时就要把用了多年的自动签名脚本改为支持sha256和sha1双证书的格式。公司原使用signcode.exe和SignTool.exe两种方式进行签名，其中signcode配合另外找的signcode-pwd.exe工具和pvk+spc文件可以不需要密码即可实现签名(不在此文中详诉)，SignTool是直接用pfx证书+密码来进行签名。于是分别寻找两种方式：&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;查阅signcode的&lt;a href=&quot;https://msdn.microsoft.com/zh-cn/library/9sh96ycy.aspx?f=255&amp;amp;MSPPError=-2147217396&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;文档&lt;/a&gt;发现，&lt;strong&gt;signcode&lt;/strong&gt;的命令行-a是用来指定数字签名的签名算法。试验了下，只支持sha1和md5，&lt;strong&gt;不支持sha256&lt;/strong&gt;。所以此方法废弃。&lt;/p&gt;
&lt;p&gt;再查阅&lt;strong&gt;SignTool&lt;/strong&gt;的&lt;a href=&quot;https://msdn.microsoft.com/zh-cn/library/8s9b9yaz(v=vs.110&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;文档&lt;/a&gt;.aspx)，支持/fd来指定签名，试了md5、sha1、sha256均支持，所以直接在原来签名代码上添加个/&lt;strong&gt;sa /fd sha256&lt;/strong&gt;后如下：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;_SignTool.exe sign /v /as /ac /f D:\test\sign\sign_sha256\xxx.pfx /p xxxx /t &lt;a href=&quot;http://timestamp.wosign.com/timestamp&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://timestamp.wosign.com/timestamp&lt;/a&gt; /fd sha256 “D:\test_double&lt;em&gt;signed.exe”&lt;/em&gt;&lt;br&gt;一开始出现/as选项不识别的问题，经研究是使用的&lt;span style=&quot;color: #ff0000;&quot;&gt;SignTool版本&lt;/span&gt;为6.0,因为自己机器上装了win10的sdk，于是使用了最新的C:\Program Files (x86)\Windows Kits\10\bin\x86\signtool.exe。ps：貌似只有win10带的才支持/as选项，但nnd这货依赖的ncrypt.dll，bcrypt.dll等dll只在vista及以上系统有，所以还在用xp的同学就不要用了。如果想拷贝到其它系统上使用，同时拷贝同目录下的：&lt;br&gt;appxpackaging.dll&lt;/p&gt;
&lt;p&gt;appxsip.dll&lt;/p&gt;
&lt;p&gt;mssign32.dll&lt;/p&gt;
&lt;p&gt;opcservices.dll&lt;/p&gt;
&lt;p&gt;signtool.exe&lt;/p&gt;
&lt;p&gt;signtool.exe.manifest&lt;/p&gt;
&lt;p&gt;wintrust.dll&lt;/p&gt;
&lt;p&gt;wintrust.dll.ini&lt;/p&gt;
&lt;p&gt;Microsoft.Windows.Build.Appx.AppxPackaging.dll.manifest&lt;/p&gt;
&lt;p&gt;Microsoft.Windows.Build.Appx.AppxSip.dll.manifest&lt;/p&gt;
&lt;p&gt;Microsoft.Windows.Build.Appx.OpcServices.dll.manifest&lt;/p&gt;
&lt;p&gt;Microsoft.Windows.Build.Signing.mssign32.dll.manifest&lt;/p&gt;
&lt;p&gt;Microsoft.Windows.Build.Signing.wintrust.dll.manifest&lt;br&gt;再试验出现以下错误：&lt;em&gt;SignTool Error: The /t option is incompatible with the /as option.SignTool Error: Specify the RFC 3161 timestamp server’s URL instead with /tr.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;尝试把/t换成/tr，但是出现错误：SignTool Error: The specified timestamp server either could not be reached orreturned an invalid response.&lt;/p&gt;
&lt;p&gt;经过一番努力后，将&lt;a href=&quot;http://timestamp.wosign.com/timestamp替换成http://timestamp.wosign.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://timestamp.wosign.com/timestamp替换成http://timestamp.wosign.com/&lt;/a&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;rfc3161&lt;/span&gt;解决问题。&lt;a href=&quot;http://timestamp.wosign.com/rfc3161是较新的时间戳服务格式，兼容/t和&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://timestamp.wosign.com/rfc3161是较新的时间戳服务格式，兼容/t和&lt;/a&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;/tr&lt;/span&gt;，而&lt;a href=&quot;http://timestamp.wosign.com/timestamp只适用于/t。&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://timestamp.wosign.com/timestamp只适用于/t。&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;最后将两个签名指令放到批处理文件里：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;set sign_folder=%~dp0%%sign_folder%\SignTool.exe sign /v /f %sign_folder%example.pfx /p examplepassword &lt;span style=&quot;color: #ff0000;&quot;&gt;/tr &lt;a href=&quot;http://timestamp.wosign.com/rfc3161&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://timestamp.wosign.com/rfc3161&lt;/a&gt; /fd sha1&lt;/span&gt; “%1”%sign_folder%\SignTool.exe sign /v &lt;span style=&quot;color: #ff0000;&quot;&gt;/as&lt;/span&gt; /f %sign_folder%example.pfx /p examplepassword&lt;span style=&quot;color: #ff0000;&quot;&gt; /tr &lt;a href=&quot;http://timestamp.wosign.com/rfc3161&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://timestamp.wosign.com/rfc3161&lt;/a&gt; /fd sha256&lt;/span&gt; “%1”&lt;br&gt;别的自动脚本里在想要签名文件时，只需要调用sign.bat “要签名的文件的全路径”即可&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;微软是第一个宣布了SHA-1弃用计划，在2016年之后Windows和IE将不再信任SHA-1证书。正好我们公司的数字签名也到期了，索性就重新申请了sha256和sha1的新数字证书，用来给产品签名。&lt;/p&gt;
&lt;p&gt;这时就要把用了多年的自动签名脚本改为支持sha256和sha1双证书的格式。公司原使用signcode.exe和SignTool.exe两种方式进行签名，其中signcode配合另外找的signcode-pwd.exe工具和pvk+spc文件可以不需要密码即可实现签名(不在此文中详诉)，SignTool是直接用pfx证书+密码来进行签名。于是分别寻找两种方式：&lt;br&gt;
    
    </summary>
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/categories/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="sha256" scheme="http://baba.zhaoxiuyuan.com/tags/sha256/"/>
    
      <category term="数字签名" scheme="http://baba.zhaoxiuyuan.com/tags/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/"/>
    
  </entry>
  
  <entry>
    <title>win10 系统下获取系统版本号为6.2的问题</title>
    <link href="http://baba.zhaoxiuyuan.com/2015/08/99/"/>
    <id>http://baba.zhaoxiuyuan.com/2015/08/99/</id>
    <published>2015-08-13T00:49:20.000Z</published>
    <updated>2016-07-04T09:48:41.200Z</updated>
    
    <content type="html">&lt;p&gt;&lt;span style=&quot;font-family:Microsoft YaHei; font-size:14px&quot;&gt;&amp;nbsp; 近期赶时髦升级了win10，用着挺爽。但是某天在测试一个bug时发现要对win10做特殊处理，于是直接调用了GetVersionEx，并取出版本号进行判断，但是发现得到的版本竟然是6.2。当时就被雷到了，然后看了我们的其它产品中相关功能，皆获取的是6.2。&lt;/span&gt;&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;    &lt;span style=&quot;font-family:Microsoft YaHei; font-size:14px&quot;&gt;&amp;nbsp; 在搜索一会儿之后，发现这是微软故意做的设定，&lt;span style=&quot;color:rgb(69,69,69)&quot;&gt;&lt;a href=&quot;https://msdn.microsoft.com/zh-cn/library/windows/desktop/ms724451(v=vs.85&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;GetVersionEx&lt;/a&gt;.aspx)函数可能在Win8.1之后会取消，推荐程序员们使用&lt;a href=&quot;https://msdn.microsoft.com/en-us/library/windows/desktop/dn424972(v=vs.85&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;span style=&quot;color:#00188f&quot;&gt;Version Helper APIs&lt;/span&gt;&lt;/a&gt;.aspx)&lt;/span&gt;&amp;nbsp;，所以在8.1之后的系统中此函数的行为改变了，如果程序没有加上正确的manifested以表明此程序兼容新系统，则只能得到6.2这个版本号。&lt;/span&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;span style=&amp;quot;font-family:Microsoft YaHei; font-size:14px&amp;quot;&amp;gt;&amp;amp;nbsp; 下面说说，需要如何添加一个正确的manifest，也可以去MSDN上直接看[原始文档](https://msdn.microsoft.com/en-us/library/windows/desktop/dn481241(v=vs.85).aspx)&amp;lt;/span&amp;gt;

&amp;lt;span style=&amp;quot;font-family:Microsoft YaHei; font-size:14px&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp;首先，如果原来程序就已经设置了附加一个额外的manifest文件，则直接在原来的manifest里的assembly根节点里加一段兼容指示：&amp;lt;/span&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;pre name=&quot;code&quot; class=&quot;html&quot;&gt; &amp;lt;compatibility xmlns=&amp;quot;urn:schemas-microsoft-com:compatibility.v1&amp;quot;&amp;gt; 
        &amp;lt;application&amp;gt; 
            &amp;lt;!-- Windows 10 --&amp;gt; 
            &amp;lt;supportedOS Id=&amp;quot;{8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a}&amp;quot;/&amp;gt;
            &amp;lt;!-- Windows 8.1 --&amp;gt;
            &amp;lt;supportedOS Id=&amp;quot;{1f676c76-80e1-4239-95bb-83d0f6d0da78}&amp;quot;/&amp;gt;
            &amp;lt;!-- Windows Vista --&amp;gt;
            &amp;lt;supportedOS Id=&amp;quot;{e2011457-1546-43c5-a5fe-008deee3d3f0}&amp;quot;/&amp;gt; 
            &amp;lt;!-- Windows 7 --&amp;gt;
            &amp;lt;supportedOS Id=&amp;quot;{35138b9a-5d96-4fbd-8e2d-a2440225f93a}&amp;quot;/&amp;gt;
            &amp;lt;!-- Windows 8 --&amp;gt;
            &amp;lt;supportedOS Id=&amp;quot;{4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38}&amp;quot;/&amp;gt;
        &amp;lt;/application&amp;gt; 
    &amp;lt;/compatibility&amp;gt;&lt;/pre&gt;

&lt;p&gt;&lt;span style=&quot;font-family:Microsoft YaHei; font-size:14px&quot;&gt;&amp;nbsp; 如果原来没有一个manifest文件，则可以在工程的某目录创建一个 xxx.manifest文件，里面写上以下内容，当然内容中的工程名称可以随意，并没有强制，只要确保compatibility节点的值不变就可以了：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;pre name=&quot;code&quot; class=&quot;html&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;&lt;br&gt;&amp;lt;assembly xmlns=&amp;quot;urn:schemas-microsoft-com:asm.v1&amp;quot; manifestVersion=&amp;quot;1.0&amp;quot;&amp;gt;&lt;br&gt;    &amp;lt;assemblyIdentity version=&amp;quot;1.5.0.0&amp;quot; processorArchitecture=&amp;quot;X86&amp;quot; name=&amp;quot;Microsoft.Windows.工程名称&amp;quot; type=&amp;quot;win32&amp;quot;/&amp;gt;&lt;br&gt;    &amp;lt;description&amp;gt;工程名称&amp;lt;/description&amp;gt;&lt;br&gt;    &amp;lt;compatibility xmlns=&amp;quot;urn:schemas-microsoft-com:compatibility.v1&amp;quot;&amp;gt;&lt;br&gt;        &amp;lt;application&amp;gt;&lt;br&gt;            &amp;lt;!– Windows 10 –&amp;gt;&lt;br&gt;            &amp;lt;supportedOS Id=&amp;quot;{8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a}&amp;quot;/&amp;gt;&lt;br&gt;            &amp;lt;!– Windows 8.1 –&amp;gt;&lt;br&gt;            &amp;lt;supportedOS Id=&amp;quot;{1f676c76-80e1-4239-95bb-83d0f6d0da78}&amp;quot;/&amp;gt;&lt;br&gt;            &amp;lt;!– Windows Vista –&amp;gt;&lt;br&gt;            &amp;lt;supportedOS Id=&amp;quot;{e2011457-1546-43c5-a5fe-008deee3d3f0}&amp;quot;/&amp;gt;&lt;br&gt;            &amp;lt;!– Windows 7 –&amp;gt;&lt;br&gt;            &amp;lt;supportedOS Id=&amp;quot;{35138b9a-5d96-4fbd-8e2d-a2440225f93a}&amp;quot;/&amp;gt;&lt;br&gt;            &amp;lt;!– Windows 8 –&amp;gt;&lt;br&gt;            &amp;lt;supportedOS Id=&amp;quot;{4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38}&amp;quot;/&amp;gt;&lt;br&gt;        &amp;lt;/application&amp;gt;&lt;br&gt;    &amp;lt;/compatibility&amp;gt;&lt;br&gt;&amp;lt;/assembly&amp;gt;&lt;br&gt;&lt;/pre&gt;&lt;br&gt;&lt;span style=&quot;font-family:Microsoft YaHei; font-size:14px&quot;&gt;&amp;nbsp; 然后在vs工程属性里找到“清单工具-&amp;gt;输入和输出-&amp;gt;附加清单文件”里填入manifest文件的相对路径，然后重新链接，你的程序就可以正常的使用GetVersionEx了。但出了新系统之后，估计还是要重新改下manifest以兼容新的系统。&lt;/span&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;span style=&quot;font-family:Microsoft YaHei; font-size:14px&quot;&gt;&amp;nbsp; 近期赶时髦升级了win10，用着挺爽。但是某天在测试一个bug时发现要对win10做特殊处理，于是直接调用了GetVersionEx，并取出版本号进行判断，但是发现得到的版本竟然是6.2。当时就被雷到了，然后看了我们的其它产品中相关功能，皆获取的是6.2。&lt;/span&gt;&lt;br&gt;
    
    </summary>
    
      <category term="WINDOWS编程" scheme="http://baba.zhaoxiuyuan.com/categories/WINDOWS%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="GetVersionEx" scheme="http://baba.zhaoxiuyuan.com/tags/GetVersionEx/"/>
    
      <category term="win10" scheme="http://baba.zhaoxiuyuan.com/tags/win10/"/>
    
      <category term="系统版本号" scheme="http://baba.zhaoxiuyuan.com/tags/%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC%E5%8F%B7/"/>
    
  </entry>
  
  <entry>
    <title>另类方法制作android通用驱动</title>
    <link href="http://baba.zhaoxiuyuan.com/2015/07/92/"/>
    <id>http://baba.zhaoxiuyuan.com/2015/07/92/</id>
    <published>2015-07-08T00:37:00.000Z</published>
    <updated>2016-07-04T09:46:28.696Z</updated>
    
    <content type="html">&lt;p&gt;绝大多数的Android驱动应该都是基于google的通用驱动改造而来，我们不说复杂的添加很多新模块和新功能的改造，就说简单的改造google的anroid通用驱动来实现适配常见anroid手机。本文中一些名词(inf、数字签名)等不做展开说明，有兴趣请自行了解。&lt;/p&gt;
&lt;p&gt;先在前面声明大纲，改造Android驱动只需要两点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;驱动文件的&lt;strong&gt;inf文件&lt;/strong&gt;中添加该手机对应的&lt;strong&gt;硬件id/兼容id&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;对更新后的inf和所有的原来的文件重新生成&lt;strong&gt;cat文件&lt;/strong&gt;(安全目录)，并&lt;strong&gt;数字签名&lt;/strong&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;驱动常见格式&quot;&gt;&lt;a href=&quot;#驱动常见格式&quot; class=&quot;headerlink&quot; title=&quot;驱动常见格式&quot;&gt;&lt;/a&gt;&lt;strong&gt;驱动常见格式&lt;/strong&gt;&lt;/h2&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;span style=&quot;font-size: 16px; line-height: 24px;&quot;&gt;先看一个从android网站上下载的一个官方驱动usb_driver_r04-windows.zip，解压后内部结构为下图所示:&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;font-size: 16px; line-height: 24px;&quot;&gt; &lt;a href=&quot;http://zhaohaiyang-wordpress.stor.sinaapp.com/uploads/2015/07/l1.png&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;img src=&quot;http://zhaohaiyang-wordpress.stor.sinaapp.com/uploads/2015/07/l1-300x140.png&quot; alt=&quot;&quot; title=&quot;usb_driver_r04-windows 1层目录结构&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://zhaohaiyang-wordpress.stor.sinaapp.com/uploads/2015/07/l2.png&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;img src=&quot;http://zhaohaiyang-wordpress.stor.sinaapp.com/uploads/2015/07/l2-300x67.png&quot; alt=&quot;&quot; title=&quot;usb_driver_r04-windows 2层结构&quot;&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;font-size: 16px; line-height: 24px;&quot;&gt;其中inf文件的内容大致如下：&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span style=&quot;font-size: 16px; line-height: 24px;&quot;&gt;;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;; Android WinUsb driver installation.&lt;/p&gt;
&lt;p&gt;;&lt;/p&gt;
&lt;p&gt;[Version]&lt;/p&gt;
&lt;p&gt;Signature           = “$Windows NT$”&lt;/p&gt;
&lt;p&gt;Class               = AndroidUsbDeviceClass&lt;/p&gt;
&lt;p&gt;ClassGuid           = {3F966BD9-FA04-4ec5-991C-D326973B5128}&lt;/p&gt;
&lt;p&gt;Provider            = %ProviderName%&lt;/p&gt;
&lt;p&gt;DriverVer           = 12/06/2010,4.0.0000.00000&lt;/p&gt;
&lt;p&gt;CatalogFile.NTx86   = androidwinusb86.cat&lt;/p&gt;
&lt;p&gt;CatalogFile.NTamd64 = androidwinusba64.cat&lt;/p&gt;
&lt;p&gt;;&lt;/p&gt;
&lt;p&gt;; This section seems to be required for WinUsb driver installation.&lt;/p&gt;
&lt;p&gt;; If this section is removed the installer will report an error&lt;/p&gt;
&lt;p&gt;; “Required section not found in INF file”.&lt;/p&gt;
&lt;p&gt;;&lt;/p&gt;
&lt;p&gt;[ClassInstall32]&lt;/p&gt;
&lt;p&gt;Addreg = AndroidWinUsbClassReg&lt;/p&gt;
&lt;p&gt;[AndroidWinUsbClassReg]&lt;/p&gt;
&lt;p&gt;HKR,,,0,%ClassName%&lt;/p&gt;
&lt;p&gt;HKR,,Icon,,-1&lt;/p&gt;
&lt;p&gt;[Manufacturer]&lt;/p&gt;
&lt;p&gt;%ProviderName% = Google, NTx86, NTamd64&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;[Google.NTx86]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ; HTC Dream&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_0BB4&amp;amp;PID_0C01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_0BB4&amp;amp;PID_0C02&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleBootLoaderInterface% = USB_Install, USB\VID_0BB4&amp;amp;PID_0FFF&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ; HTC Magic&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_0BB4&amp;amp;PID_0C03&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;Moto Sholes&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_22B8&amp;amp;PID_41DB&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_22B8&amp;amp;PID_41DB&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;Google NexusOne&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_18D1&amp;amp;PID_0D02&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_18D1&amp;amp;PID_0D02&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_18D1&amp;amp;PID_4E11&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_18D1&amp;amp;PID_4E12&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_18D1&amp;amp;PID_4E22&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt;[Google.NTamd64]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ; HTC Dream&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_0BB4&amp;amp;PID_0C01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_0BB4&amp;amp;PID_0C02&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleBootLoaderInterface% = USB_Install, USB\VID_0BB4&amp;amp;PID_0FFF&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ; HTC Magic&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_0BB4&amp;amp;PID_0C03&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;Moto Sholes&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_22B8&amp;amp;PID_41DB&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_22B8&amp;amp;PID_41DB&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; ;Google NexusOne&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_18D1&amp;amp;PID_0D02&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_18D1&amp;amp;PID_0D02&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %SingleAdbInterface%        = USB_Install, USB\VID_18D1&amp;amp;PID_4E11&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_18D1&amp;amp;PID_4E12&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;color: #ff0000;&quot;&gt; %CompositeAdbInterface%     = USB_Install, USB\VID_18D1&amp;amp;PID_4E22&amp;amp;MI_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;[USB_Install]&lt;/p&gt;
&lt;p&gt;Include = winusb.inf&lt;/p&gt;
&lt;p&gt;Needs   = WINUSB.NT&lt;/p&gt;
&lt;p&gt;[USB_Install.Services]&lt;/p&gt;
&lt;p&gt;Include     = winusb.inf&lt;/p&gt;
&lt;p&gt;AddService  = WinUSB,0x00000002,WinUSB_ServiceInstall&lt;/p&gt;
&lt;p&gt;[WinUSB_ServiceInstall]&lt;/p&gt;
&lt;p&gt;DisplayName     = %WinUSB_SvcDesc%&lt;/p&gt;
&lt;p&gt;ServiceType     = 1&lt;/p&gt;
&lt;p&gt;StartType       = 3&lt;/p&gt;
&lt;p&gt;ErrorControl    = 1&lt;/p&gt;
&lt;p&gt;ServiceBinary   = %12%\WinUSB.sys&lt;/p&gt;
&lt;p&gt;[USB_Install.Wdf]&lt;/p&gt;
&lt;p&gt;KmdfService = WINUSB, WinUSB_Install&lt;/p&gt;
&lt;p&gt;[WinUSB_Install]&lt;/p&gt;
&lt;p&gt;KmdfLibraryVersion  = 1.9&lt;/p&gt;
&lt;p&gt;[USB_Install.HW]&lt;/p&gt;
&lt;p&gt;AddReg  = Dev_AddReg&lt;/p&gt;
&lt;p&gt;[Dev_AddReg]&lt;/p&gt;
&lt;p&gt;HKR,,DeviceInterfaceGUIDs,0x10000,”{F72FE0D4-CBCB-407d-8814-9ED673D0DD6B}”&lt;/p&gt;
&lt;p&gt;[USB_Install.CoInstallers]&lt;/p&gt;
&lt;p&gt;AddReg    = CoInstallers_AddReg&lt;/p&gt;
&lt;p&gt;CopyFiles = CoInstallers_CopyFiles&lt;/p&gt;
&lt;p&gt;[CoInstallers_AddReg]&lt;/p&gt;
&lt;p&gt;HKR,,CoInstallers32,0x00010000,”WdfCoInstaller01009.dll,WdfCoInstaller”,”WinUSBCoInstaller2.dll”&lt;/p&gt;
&lt;p&gt;[CoInstallers_CopyFiles]&lt;/p&gt;
&lt;p&gt;WinUSBCoInstaller2.dll&lt;/p&gt;
&lt;p&gt;WdfCoInstaller01009.dll&lt;/p&gt;
&lt;p&gt;[DestinationDirs]&lt;/p&gt;
&lt;p&gt;CoInstallers_CopyFiles=11&lt;/p&gt;
&lt;p&gt;[SourceDisksNames]&lt;/p&gt;
&lt;p&gt;1 = %DISK_NAME%,,,\i386&lt;/p&gt;
&lt;p&gt;2 = %DISK_NAME%,,,\amd64&lt;/p&gt;
&lt;p&gt;[SourceDisksFiles.x86]&lt;/p&gt;
&lt;p&gt;WinUSBCoInstaller2.dll  = 1&lt;/p&gt;
&lt;p&gt;WdfCoInstaller01009.dll = 1&lt;/p&gt;
&lt;p&gt;[SourceDisksFiles.amd64]&lt;/p&gt;
&lt;p&gt;WinUSBCoInstaller2.dll  = 2&lt;/p&gt;
&lt;p&gt;WdfCoInstaller01009.dll = 2&lt;/p&gt;
&lt;p&gt;[Strings]&lt;/p&gt;
&lt;p&gt;ProviderName                = “Google, Inc.”&lt;/p&gt;
&lt;p&gt;SingleAdbInterface          = “Android ADB Interface”&lt;/p&gt;
&lt;p&gt;CompositeAdbInterface       = “Android Composite ADB Interface”&lt;/p&gt;
&lt;p&gt;SingleBootLoaderInterface   = “Android Bootloader Interface”&lt;/p&gt;
&lt;p&gt;WinUSB_SvcDesc              = “Android USB Driver”&lt;/p&gt;
&lt;p&gt;DISK_NAME                   = “Android WinUsb installation disk”&lt;/p&gt;
&lt;p&gt;ClassName                   = “Android Phone”&lt;br&gt;上面这个inf中标为红色的地方就是这个驱动默认支持的所有设备的硬件id。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;修改inf文件&quot;&gt;&lt;a href=&quot;#修改inf文件&quot; class=&quot;headerlink&quot; title=&quot;修改inf文件&quot;&gt;&lt;/a&gt;&lt;strong&gt;修改inf文件&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;&lt;span style=&quot;line-height: 24px;&quot;&gt; 市面上的常见通用 驱动文件的修改大多是采用如谷歌原生驱动一样的方式，将想要支持的设备的硬件id加到inf文件，每多要支持一个系列的设备，就得修改一次inf文件并且重新发布驱动。这种方式简单粗暴，并且使用微软的inf2cat.exe能够正常生成安全目录。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span style=&quot;line-height: 24px;&quot;&gt; 还有一种就是小米早期版本的驱动一样，直接使用硬件设备的兼容id，它改动过的inf如下：&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span style=&quot;line-height: 24px;&quot;&gt;[Google.NTx86]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;;Xiaomi Mione&lt;/p&gt;
&lt;p&gt;%CompositeAdbInterface%     = &lt;span style=&quot;color: #ff0000;&quot;&gt;USB_Install, USB\Class_FF&amp;amp;SubClass_42&amp;amp;Prot_01&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;%SingleAdbInterface% = &lt;span style=&quot;color: #ff0000;&quot;&gt;USB_Install, USB\Class_FF&amp;amp;SubClass_42&amp;amp;Prot_03&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;[Google.NTamd64]&lt;/p&gt;
&lt;p&gt;;Xiaomi Mione&lt;/p&gt;
&lt;p&gt;%CompositeAdbInterface%     = USB_Install, USB\Class_FF&amp;amp;SubClass_42&amp;amp;Prot_01&lt;/p&gt;
&lt;p&gt;%SingleAdbInterface% = USB_Install, USB\Class_FF&amp;amp;SubClass_42&amp;amp;Prot_03&lt;br&gt;但是在研究中发现，在win7上安装驱动时驱动如果没有正确的cat文件和对cat数字签名，驱动是安装不上或者有警告。小米的驱动同样如此，所以估计这也是后来小米的新驱动一样使用上面添加硬件id列表的方式的原因之一吧。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这里我们使用第二种方式，将inf里多余的硬件id全部删除，然后使用小米的这种方式将android手机通用的兼容id写入进去。&lt;/p&gt;
&lt;h2 id=&quot;生成CAT文件&quot;&gt;&lt;a href=&quot;#生成CAT文件&quot; class=&quot;headerlink&quot; title=&quot;生成CAT文件&quot;&gt;&lt;/a&gt;生成CAT文件&lt;/h2&gt;&lt;p&gt;安装windows的驱动开发包(我使用的是WinDDK 7600.16385.1)，找到里面的bin\selfsign\Inf2Cat.exe，使用命令行Inf2Cat.exe /v /driver:&lt;strong&gt;驱动目录&lt;/strong&gt; /OS:7_X64,7_X86进行编辑，如果是使用的硬件id，则会正常生成安装目录文件，但如果使用兼容id，则会报以下错误。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://zhaohaiyang-wordpress.stor.sinaapp.com/uploads/2015/07/无标题.png&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;&lt;img src=&quot;http://zhaohaiyang-wordpress.stor.sinaapp.com/uploads/2015/07/无标题-300x130.png&quot; alt=&quot;&quot; title=&quot;inf2Cat错误提示&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;这个inf2cat程序经研究是c#语言开发的，于是，祭出神器&lt;strong&gt;JetBrains dotPeek 1.1 &lt;/strong&gt;对它进行反编译，并且导出c#工程，然后改掉其中的判断错误的代码&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;在bool flag = driverPackageInfo.TestSignability(out errors, out warnings);之后， 将flag强制赋值为true。&lt;br&gt;并且注释掉AssemblyInfo.cs中的//[assembly: AssemblyKeyFile(“\\DQBLD01\builds2\keys\whos.snk”)]，然后重新生成一个inf2cat程序，放在winddk的原目录。这样重新生成cat文件，虽然还是有错误提示，但是不要紧，cat文件正常的生成出来了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;最后对生成出来的cat文件进行数字签名，注意要使用signtool.exe+证书文件的数字签名方法，使用signcode.exe的加密方式对于64位程序似乎系统不太认。&lt;/p&gt;
&lt;p&gt;这样，一个通用android驱动就完成了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;绝大多数的Android驱动应该都是基于google的通用驱动改造而来，我们不说复杂的添加很多新模块和新功能的改造，就说简单的改造google的anroid通用驱动来实现适配常见anroid手机。本文中一些名词(inf、数字签名)等不做展开说明，有兴趣请自行了解。&lt;/p&gt;
&lt;p&gt;先在前面声明大纲，改造Android驱动只需要两点：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;驱动文件的&lt;strong&gt;inf文件&lt;/strong&gt;中添加该手机对应的&lt;strong&gt;硬件id/兼容id&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;对更新后的inf和所有的原来的文件重新生成&lt;strong&gt;cat文件&lt;/strong&gt;(安全目录)，并&lt;strong&gt;数字签名&lt;/strong&gt;
    
    </summary>
    
      <category term="系统/工具" scheme="http://baba.zhaoxiuyuan.com/categories/%E7%B3%BB%E7%BB%9F-%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="android" scheme="http://baba.zhaoxiuyuan.com/tags/android/"/>
    
      <category term="android 驱动" scheme="http://baba.zhaoxiuyuan.com/tags/android-%E9%A9%B1%E5%8A%A8/"/>
    
  </entry>
  
  <entry>
    <title>32位程序在64位系统上获取系统安装时间</title>
    <link href="http://baba.zhaoxiuyuan.com/2015/01/85/"/>
    <id>http://baba.zhaoxiuyuan.com/2015/01/85/</id>
    <published>2015-01-28T23:07:08.000Z</published>
    <updated>2016-07-04T09:12:54.615Z</updated>
    
    <content type="html">&lt;p&gt;众所周知，取系统的安装时间可取注册表HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion的子项InstallDate，此值是个DWORD类型的UnixStamp。&lt;br&gt;但是在64位系统上有所不同（仅测试了win7、win8），默认情况下32程序在64位机器上访问的是下面这个地址HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion。但此注册表下的InstallDate的值为0。&lt;br&gt;所以，32位程序在64位系统下，读注册表时flag要加上KEY_WOW64_64KEY才能获取到正确的值。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;众所周知，取系统的安装时间可取注册表HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion的子项InstallDate，此值是个DWORD类型的UnixStamp。&lt;br&gt;但是在64位系统上有所不同（仅
    
    </summary>
    
      <category term="WINDOWS编程" scheme="http://baba.zhaoxiuyuan.com/categories/WINDOWS%E7%BC%96%E7%A8%8B/"/>
    
    
  </entry>
  
  <entry>
    <title>IE8崩溃在CElement::GetUpdatedLayoutWithContext</title>
    <link href="http://baba.zhaoxiuyuan.com/2014/11/82/"/>
    <id>http://baba.zhaoxiuyuan.com/2014/11/82/</id>
    <published>2014-11-19T18:40:48.000Z</published>
    <updated>2016-07-04T09:46:35.969Z</updated>
    
    <content type="html">&lt;p&gt;发了一个我们页游助手的版本时，测试报告在某些机器上点开某网站时崩溃 “0x637e5067指令引用的0x00000008内存，该内存不能为read”，查看dump文件，堆栈如下：&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;&lt;img src=&quot;http://images.cnitblog.com/blog/160770/201411/201042174372235.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;崩溃截图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://images.cnitblog.com/blog/160770/201411/201044121563221.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;测试并未找到崩溃的规律，最后经多种方式测试和查阅资料最终得出问题原因：&lt;/p&gt;
&lt;div&gt;1、8.0.6001.19170 版本及之前的IE，在打开&lt;img src=&quot;file:///C:\Users\terry\AppData\Local\Temp\[5UQ[BL(6~BS2JV6W}N6[%S.png&quot; alt=&quot;&quot;&gt;&lt;a href=&quot;http://jzyf.ledu.com/网页后，右键菜单中点击刷新或直接刷新，基本上都会崩溃。&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://jzyf.ledu.com/网页后，右键菜单中点击刷新或直接刷新，基本上都会崩溃。&lt;/a&gt;&lt;br&gt;2、据说与网页中给body设置background图片有关。&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;相关资料：&lt;/div&gt;&lt;br&gt;&lt;div&gt;1、&lt;a href=&quot;https://social.technet.microsoft.com/Forums/en-US/82144d88-ba2f-4042-8b69-61a8f84c2292/ie8-crashes-due-to-bug-in-mshtmldll-up-to-version-80600119170-null-pointer-access-in?forum=ieitprocurrentver&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://social.technet.microsoft.com/Forums/en-US/82144d88-ba2f-4042-8b69-61a8f84c2292/ie8-crashes-due-to-bug-in-mshtmldll-up-to-version-80600119170-null-pointer-access-in?forum=ieitprocurrentver&lt;/a&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;2、&lt;a href=&quot;http://answers.microsoft.com/en-us/ie/forum/ie8-windows_xp/bug-in-mshtmldll-version-80600119154-discovered/6895275e-b796-439b-a2f5-8a8b3655fa44&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://answers.microsoft.com/en-us/ie/forum/ie8-windows_xp/bug-in-mshtmldll-version-80600119154-discovered/6895275e-b796-439b-a2f5-8a8b3655fa44&lt;/a&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;3、&lt;a href=&quot;http://bugs.jquery.com/ticket/9823&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://bugs.jquery.com/ticket/9823&lt;/a&gt;&lt;/div&gt;</content>
    
    <summary type="html">
    
      &lt;p&gt;发了一个我们页游助手的版本时，测试报告在某些机器上点开某网站时崩溃 “0x637e5067指令引用的0x00000008内存，该内存不能为read”，查看dump文件，堆栈如下：&lt;br&gt;
    
    </summary>
    
      <category term="WINDOWS编程" scheme="http://baba.zhaoxiuyuan.com/categories/WINDOWS%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="GetUpdatedLayoutWithContext" scheme="http://baba.zhaoxiuyuan.com/tags/GetUpdatedLayoutWithContext/"/>
    
      <category term="IE8" scheme="http://baba.zhaoxiuyuan.com/tags/IE8/"/>
    
      <category term="崩溃" scheme="http://baba.zhaoxiuyuan.com/tags/%E5%B4%A9%E6%BA%83/"/>
    
  </entry>
  
  <entry>
    <title>DirectDraw程序截图</title>
    <link href="http://baba.zhaoxiuyuan.com/2014/08/72/"/>
    <id>http://baba.zhaoxiuyuan.com/2014/08/72/</id>
    <published>2014-08-27T00:00:18.000Z</published>
    <updated>2016-07-04T09:46:52.591Z</updated>
    
    <content type="html">&lt;p&gt;普通窗口截图可以直接PrintWindow，但是directDraw程序使用这种方法是黑屏。。&lt;br&gt;但奇怪的是，将这种程序的某部门拖动到屏幕外，则整个窗口就可以截图了。&lt;/p&gt;
&lt;p&gt;其它解决办法：&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;br&gt;1、直接GetDC后BitBlt，但如果前面有其它窗口遮挡，则这部分图像使用的是其它窗口的内容。&lt;br&gt;2、hook directdraw，然后拦截绘制过程，或者获取后台buffer&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;普通窗口截图可以直接PrintWindow，但是directDraw程序使用这种方法是黑屏。。&lt;br&gt;但奇怪的是，将这种程序的某部门拖动到屏幕外，则整个窗口就可以截图了。&lt;/p&gt;
&lt;p&gt;其它解决办法：
    
    </summary>
    
      <category term="WINDOWS编程" scheme="http://baba.zhaoxiuyuan.com/categories/WINDOWS%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="directdraw 截图" scheme="http://baba.zhaoxiuyuan.com/tags/directdraw-%E6%88%AA%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>使用python编写svn钩子</title>
    <link href="http://baba.zhaoxiuyuan.com/2014/04/75/"/>
    <id>http://baba.zhaoxiuyuan.com/2014/04/75/</id>
    <published>2014-04-09T02:56:28.000Z</published>
    <updated>2016-07-04T09:46:39.280Z</updated>
    
    <content type="html">&lt;p&gt;同上一篇trac中安装插件的文章的出发点一样，感觉用文档和口头制定规则在执行上会有偏差并且需要经常引导新人去熟悉规则。&lt;/p&gt;
&lt;p&gt;所以，又费了几个小时去琢磨怎么改进svn提交代码的钩子，现有的钩子的功能比较简单，只是验证提交时的日志字数有没有超过5个，而我想将其改进为验证是不是符合&amp;ldquo;问题修复：#1234 xxxx&amp;rdquo;的这种格式，这里处理的是 版本库/hooks/pre-commit.bat &amp;nbsp;这个钩子。&lt;/p&gt;
&lt;p&gt;话不多说，svn钩子原理和规则不表，先上&lt;strong&gt;原钩子代码&lt;/strong&gt;：&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;br&gt;&lt;pre&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;@echo&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;off&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; SVN强制写注释的hooks脚本(Windows)&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;&lt;br&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 文件名是: pre-commit.bat,放到repository/hooks目录下&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;setlocal&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; SVN_BINDIR=”D:\service\Subversion\bin”&lt;br&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; REPOS=&lt;span style=&quot;color: #800080;&quot;&gt;%1&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; TXN=&lt;span style=&quot;color: #800080;&quot;&gt;%2&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; check that logmessage contains at least 10 characters&lt;/span&gt;&lt;br&gt;%SVN_BINDIR%\svnlook log “%REPOS%” -t “%TXN%” | findstr “……” &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; nul&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% gtr 0 &lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; err&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;exit&lt;/span&gt; 0&lt;br&gt;&lt;span style=&quot;color: #800000;&quot;&gt;:err&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;echo&lt;/span&gt; 提交时必须填写说明(Message)! 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;echo&lt;/span&gt; “%REPOS%” -t “%TXN%” 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #0000ff;&quot;&gt;exit&lt;/span&gt; 1&lt;/pre&gt;&lt;br&gt;&lt;/div&gt;

&lt;p&gt;一开始尝试使用直接修改bat，改进findstr来支持更复杂的正则表达式，但是遇到各种问题。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;首先是不太熟悉批处理的各种规则。&lt;/li&gt;
&lt;li&gt;然后有些特殊字符在命令行上的不能使用。&lt;/li&gt;
&lt;li&gt;再者就是使用在线工具验证过的正则表达式findstr匹配失败。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在测试过程中保留了下面这个奇葩的中间版本(不能正常工作的)。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; onclick=&quot;cnblogs_code_show(&#39;e65fe15e-f01f-41bb-aa17-aa928ce698d0&#39;)&quot;&gt;&lt;img src=&quot;http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;&gt;&lt;img src=&quot;http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;div id=&quot;cnblogs_code_open_e65fe15e-f01f-41bb-aa17-aa928ce698d0&quot; class=&quot;cnblogs_code_hide&quot;&gt;&lt;br&gt;&lt;pre&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 1&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;@echo&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;off&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 2&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; SVN强制写注释的hooks脚本(Windows)&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 3&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 文件名是: pre-commit.bat,放到repository/hooks目录下&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 4&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;setlocal&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 5&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; SVN_BINDIR=C:\Program &lt;span style=&quot;color: #0000ff;&quot;&gt;Files&lt;/span&gt;\TortoiseSVN\&lt;span style=&quot;color: #000000;&quot;&gt;bin&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 6&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; REPOS=&lt;span style=&quot;color: #800080;&quot;&gt;%1&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 7&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; TXN=&lt;span style=&quot;color: #800080;&quot;&gt;%2&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 8&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 9&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; check that logmessage contains at least 10 characters&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;10&lt;/span&gt; “%SVN_BINDIR%\svnlook” log “%REPOS%” -t “%TXN%” &amp;gt; t.&lt;span style=&quot;color: #000000;&quot;&gt;log&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;12&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;:set&lt;/span&gt; disable=:;’^&amp;lt;^&amp;gt;,&lt;span style=&quot;color: #000000;&quot;&gt;。&amp;lsquo;&lt;em&gt;【】｛｝？?《》&lt;br&gt;&lt;/em&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;13&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; (#[0-9]+ )?[^#  允许带或不带ticket号开头，不支持非中文符号&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;15&lt;/span&gt; findstr “^问题修复：(#[0-9]+ )…” t.&lt;span style=&quot;color: #000000;&quot;&gt;log&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;16&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;@echo&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;17&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;not&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% gtr 0 &lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; success&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;18&lt;/span&gt; findstr “^功能开发：(#[0-9]+ )&lt;em&gt;[^#%disable%]&lt;/em&gt;$” t.log &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; nul&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;19&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;not&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% gtr 0 &lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; success&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;20&lt;/span&gt; findstr “^功能改进：(#[0-9]+ )&lt;em&gt;[^#%disable%]&lt;/em&gt;$” t.log &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; nul&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;21&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;not&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% gtr 0 &lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; success&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;22&lt;/span&gt; findstr “^功能优化：(#[0-9]+ )&lt;em&gt;[^#%disable%]&lt;/em&gt;$” t.log &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; nul&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;23&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;not&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% gtr 0 &lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; success&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;24&lt;/span&gt; findstr “^代码优化：(#[0-9]+ )&lt;em&gt;[^#%disable%]&lt;/em&gt;$” t.log &amp;gt;&lt;span style=&quot;color: #000000;&quot;&gt; nul&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;25&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;not&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% gtr 0 &lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; success&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;27&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;:err&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;28&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;echo&lt;/span&gt; 未遵循svn提交规范 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;29&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;:echo&lt;/span&gt; “%REPOS%” -t “%TXN%” 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;30&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;:rm&lt;/span&gt; t.&lt;span style=&quot;color: #000000;&quot;&gt;log&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;31&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;exit&lt;/span&gt; 1&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;33&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;:success&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;34&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;:rm&lt;/span&gt; t.&lt;span style=&quot;color: #000000;&quot;&gt;log&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;35&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;exit&lt;/span&gt; 1&lt;/pre&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;不成功的中间版本&lt;/span&gt;&lt;/div&gt;

&lt;p&gt;可以看到，我无奈地将一个正则表达式一分为五，并且拆分成5个之后不会使用管道同时将参数传递(也不能吧？)给findstr，关键是我那么一大串在日志中禁用标点符号不知为何不能工作，反正断断续续(经常被人打断工作，去处理其它事)耗费了我3个小时去写测试的批处理和这个钩子批处理，还是搞不定。一念下，想起python这种神器，花了几分钟找到了正则表达式的match示例，又查阅了对于stdin输入的获取方法，然后直接写了个check.py去代替findstr来匹配正则表达式(其实这思路是上午查看trac的TracTicketValidatorPlugin插件时看代码得到的)，然后再花2分钟验证之，搞定，上代码：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;pre-commit.bat&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;br&gt;&lt;pre&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 1&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;@echo&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;off&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 2&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; SVN强制写注释的hooks脚本(Windows)&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 3&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 文件名是: pre-commit.bat,放到repository/hooks目录下&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 4&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;setlocal&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 5&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; SVN_BINDIR=”C:\Program Files\TortoiseSVN\bin”&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 6&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; REPOS=&lt;span style=&quot;color: #800080;&quot;&gt;%1&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 7&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;set&lt;/span&gt; TXN=&lt;span style=&quot;color: #800080;&quot;&gt;%2&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 8&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 9&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;rem&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; check that logmessage contains at least 10 characters&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;10&lt;/span&gt; %SVN_BINDIR%\svnlook log “%REPOS%” -t “%TXN%” | python check.py “……” 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;11&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; %&lt;span style=&quot;color: #0000ff;&quot;&gt;errorlevel&lt;/span&gt;% gtr 0 &lt;span style=&quot;color: #0000ff;&quot;&gt;goto&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; err&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;12&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;exit&lt;/span&gt; 0&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;14&lt;/span&gt; &lt;span style=&quot;color: #800000;&quot;&gt;:err&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;15&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;echo&lt;/span&gt; 未遵循svn提交规范! 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;16&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;echo&lt;/span&gt; “%REPOS%” -t “%TXN%” 1&amp;gt;&amp;amp;2&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;17&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;exit&lt;/span&gt; 1&lt;/pre&gt;&lt;br&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;check.py (2014/04/10修正，使用unicode字符串以对全角符号进行正确匹配)&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;br&gt;&lt;pre&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 1&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;#&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; coding=gbk&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 2&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; re&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 3&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;import&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; sys&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 4&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 5&lt;/span&gt; input_file =&lt;span style=&quot;color: #000000;&quot;&gt; sys.stdin&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 6&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 7&lt;/span&gt; &lt;span style=&quot;color: #008000;&quot;&gt;#&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt; 如果不用unicode模式则在有全角字符的情况下匹配不成功&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 8&lt;/span&gt; restr=u&lt;span style=&quot;color: #800000;&quot;&gt;‘&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;^((问题修复)|(功能开发)|(功能改进)|(功能优化)|(代码优化))：(#[0-9]+ )?[^#:;\’&amp;lt;&amp;gt;,。&amp;lsquo;*【】｛｝？?《》\n\r]+$&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;‘&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt; 9&lt;/span&gt; &lt;span style=&quot;color: #0000ff;&quot;&gt;for&lt;/span&gt; s &lt;span style=&quot;color: #0000ff;&quot;&gt;in&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt; input_file:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;10&lt;/span&gt;     &lt;span style=&quot;color: #008000;&quot;&gt;#&lt;/span&gt;&lt;span style=&quot;color: #008000;&quot;&gt;先解码为unicode字符串&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: #008080;&quot;&gt;11&lt;/span&gt;     u = s.decode(&lt;span style=&quot;color: #800000;&quot;&gt;‘&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;GBK&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;‘&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;12&lt;/span&gt;     &lt;span style=&quot;color: #0000ff;&quot;&gt;print&lt;/span&gt;(u&lt;span style=&quot;color: #800000;&quot;&gt;“&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;验证字符串:&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;“&lt;/span&gt; +&lt;span style=&quot;color: #000000;&quot;&gt; u)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;13&lt;/span&gt;     &lt;span style=&quot;color: #0000ff;&quot;&gt;if&lt;/span&gt; re.match(restr, u) !=&lt;span style=&quot;color: #000000;&quot;&gt; None:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;14&lt;/span&gt;         &lt;span style=&quot;color: #0000ff;&quot;&gt;print&lt;/span&gt;(&lt;span style=&quot;color: #800000;&quot;&gt;“&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;匹配成功&lt;/span&gt;&lt;span style=&quot;color: #800000;&quot;&gt;“&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;15&lt;/span&gt; &lt;span style=&quot;color: #000000;&quot;&gt;        exit(0)&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;16&lt;/span&gt;     &lt;span style=&quot;color: #0000ff;&quot;&gt;else&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;:&lt;br&gt;&lt;/span&gt;&lt;span style=&quot;color: #008080;&quot;&gt;17&lt;/span&gt;         exit(1)&lt;/pre&gt;&lt;br&gt;&lt;/div&gt;

&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;nbsp;&lt;/p&gt;
&lt;p&gt;ps：&lt;/p&gt;
&lt;p&gt;哎，用几年批处理，依然被诸如：启动进程进获取打印信息，字符串截取，字符串拼装等一些简单操作给难倒，感觉每次写批处理都是在 拼凑-&amp;gt;试一下 的无限循环，不学点新东西就落后了。&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;同上一篇trac中安装插件的文章的出发点一样，感觉用文档和口头制定规则在执行上会有偏差并且需要经常引导新人去熟悉规则。&lt;/p&gt;
&lt;p&gt;所以，又费了几个小时去琢磨怎么改进svn提交代码的钩子，现有的钩子的功能比较简单，只是验证提交时的日志字数有没有超过5个，而我想将其改进为验证是不是符合&amp;ldquo;问题修复：#1234 xxxx&amp;rdquo;的这种格式，这里处理的是 版本库/hooks/pre-commit.bat &amp;nbsp;这个钩子。&lt;/p&gt;
&lt;p&gt;话不多说，svn钩子原理和规则不表，先上&lt;strong&gt;原钩子代码&lt;/strong&gt;：&lt;br&gt;
    
    </summary>
    
      <category term="python" scheme="http://baba.zhaoxiuyuan.com/categories/python/"/>
    
    
      <category term="python" scheme="http://baba.zhaoxiuyuan.com/tags/python/"/>
    
      <category term="svn" scheme="http://baba.zhaoxiuyuan.com/tags/svn/"/>
    
      <category term="钩子" scheme="http://baba.zhaoxiuyuan.com/tags/%E9%92%A9%E5%AD%90/"/>
    
  </entry>
  
  <entry>
    <title>给trac的ticket添加提交时字段验证</title>
    <link href="http://baba.zhaoxiuyuan.com/2014/04/73/"/>
    <id>http://baba.zhaoxiuyuan.com/2014/04/73/</id>
    <published>2014-04-08T21:25:00.000Z</published>
    <updated>2016-07-04T09:46:43.328Z</updated>
    
    <content type="html">&lt;p&gt;我们在项目管理中使用了trac系统，并且对于ticket添加了以下自定义字段并且对它们的格式都有一定要求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;svn版本号：格式为 r1234。多个版本号之间使用半角逗号隔开。如：r1234,r5678&lt;/li&gt;
&lt;li&gt;完成日期：yyyy-mm-dd的格式&lt;/li&gt;
&lt;li&gt;开发周期：表示开发功能所耗费的时间，格式为数字或者一位小数后面跟上单位h或者d。&lt;/li&gt;
&lt;li&gt;测试版本号：v开头的标准版本号，如：v2.3.1.5098&lt;br&gt;但是在实际操作中，很多开发人员不去阅读规范文档或者压根记不起来格式规范，随意填写，很是苦恼。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今天就先试图给完成日期添加一个&lt;a href=&quot;http://trac-hacks.org/wiki/DateFieldPlugin&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;日期插件&lt;/a&gt;让开发人员直接使用日期对话框来选择日期，同时发现它已经自带了格式验证，然后在寻找这个插件的同时发现了一个好用的格式验证插件&lt;a href=&quot;https://trac-hacks.org/wiki/TracTicketValidatorPlugin&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://trac-hacks.org/wiki/TracTicketValidatorPlugin&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;如何安装此插件就不在这里描述，直奔主题看看如何实现配置trac使插件生效。&lt;br&gt;&lt;a id=&quot;more&quot;&gt;&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;首先要在trac的管理-插件里勾选tracticketvalidator 0.1里的所有组件(实际上只有一个&lt;span class=&quot;trac-name&quot;&gt;TicketsValidator&lt;/span&gt;)。&lt;a href=&quot;http://trac.kuai8.com/kuai8/admin/general/plugin#no7&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;
&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;手动打开在trac.ini，修改[ticketvalidator]段里的内容。&lt;/li&gt;
&lt;li&gt;添加以下配置&lt;span style=&quot;font-size: 14px;&quot;&gt;，注意的是&lt;span style=&quot;font-family: &#39;Courier New&#39;; line-height: 1.5;&quot;&gt;validates项指定了要对哪些字段进行验证，这些字段名都是添加的Custom Fields的名称。每一个字段都配置一个rule和tip。rule配置项是一个正则表达式，是插件用来对修改ticket时提交的信息进行验证的(插件源码里是这样写的 re.match(rule, fieldValue) )。而tip是在验证出错之后，给用户的警告信息里显示的内容。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;div class=&quot;cnblogs_Highlighter&quot;&gt;&lt;br&gt;&lt;pre class=&quot;brush:python;gutter:true;&quot;&gt;svn.rule = ^(r[0-9]+)(,r[0-9]+)*$&lt;br&gt;svn.tip = svn号请使用r开头的版本号，并且以半角逗号分割，例:r1234,r5678&lt;br&gt;needtime.rule = ^[0-9]+(.[0-9])?[h|d]$&lt;br&gt;needtime.tip = 完成时间格式：以整数或一位小数开头，以h或d结束(分别表示小时和天).示例：3.1d 或 4h&lt;br&gt;testversion.rule = ^v[0-9]+(.[0-9]+){4}$&lt;br&gt;testversion.tip = 版本号格式: vnn.nn.nn.nn, 例v2.3.1.5098&lt;br&gt;validates = svn,needtime,testversion&lt;/pre&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&amp;nbsp;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;然后重启http服务器，配置就生效了，我们尝试以错误的格式修改ticket：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://images.cnitblog.com/i/160770/201404/091313546063992.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;点击“提交变更”后显示错误警告，以及在页面顶部显示出配置的错误提示。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://images.cnitblog.com/i/160770/201404/091313282002526.jpg&quot; alt=&quot;&quot;&gt;&lt;img src=&quot;http://images.cnitblog.com/i/160770/201404/091314563561860.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;我们在项目管理中使用了trac系统，并且对于ticket添加了以下自定义字段并且对它们的格式都有一定要求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;svn版本号：格式为 r1234。多个版本号之间使用半角逗号隔开。如：r1234,r5678&lt;/li&gt;
&lt;li&gt;完成日期：yyyy-mm-dd的格式&lt;/li&gt;
&lt;li&gt;开发周期：表示开发功能所耗费的时间，格式为数字或者一位小数后面跟上单位h或者d。&lt;/li&gt;
&lt;li&gt;测试版本号：v开头的标准版本号，如：v2.3.1.5098&lt;br&gt;但是在实际操作中，很多开发人员不去阅读规范文档或者压根记不起来格式规范，随意填写，很是苦恼。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;今天就先试图给完成日期添加一个&lt;a href=&quot;http://trac-hacks.org/wiki/DateFieldPlugin&quot;&gt;日期插件&lt;/a&gt;让开发人员直接使用日期对话框来选择日期，同时发现它已经自带了格式验证，然后在寻找这个插件的同时发现了一个好用的格式验证插件&lt;a href=&quot;https://trac-hacks.org/wiki/TracTicketValidatorPlugin&quot;&gt;https://trac-hacks.org/wiki/TracTicketValidatorPlugin&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;如何安装此插件就不在这里描述，直奔主题看看如何实现配置trac使插件生效。&lt;br&gt;
    
    </summary>
    
      <category term="工具" scheme="http://baba.zhaoxiuyuan.com/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
  </entry>
  
</feed>
